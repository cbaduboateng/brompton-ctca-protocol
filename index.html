<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>Brompton CTCA Protocol Selector</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1a4b8c">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CTCA Protocols">
<link rel="apple-touch-icon" href="/icon-192.png">
<meta name="format-detection" content="telephone=no">
<style>
  :root {
    --primary: #1a4b8c;
    --primary-light: #2563a8;
    --accent: #0d9488;
    --accent-light: #14b8a6;
    --bg: #f0f4f8;
    --card-bg: #ffffff;
    --text: #1e293b;
    --text-light: #64748b;
    --border: #e2e8f0;
    --warning: #f59e0b;
    --danger: #ef4444;
    --success: #22c55e;
    --info: #3b82f6;
    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  .header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    padding: 24px 32px;
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .header p {
    font-size: 0.875rem;
    opacity: 0.85;
    margin-top: 4px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  /* Selector Section */
  .selector-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 28px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }

  .selector-section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .selector-section h2 .step-num {
    background: var(--primary);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }

  /* Clinical Indication Grid */
  .indication-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 12px;
  }

  .indication-btn {
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }

  .indication-btn:hover {
    border-color: var(--primary-light);
    background: #f0f5ff;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .indication-btn.selected {
    border-color: var(--primary);
    background: #e8f0fe;
    box-shadow: 0 0 0 1px var(--primary);
  }

  .indication-btn .ind-title {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }

  .indication-btn .ind-desc {
    font-size: 0.8rem;
    color: var(--text-light);
    line-height: 1.4;
  }

  .indication-btn .ind-category {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 8px;
    border-radius: 4px;
    margin-bottom: 6px;
  }

  .cat-coronary .ind-category { background: #dbeafe; color: #1e40af; }
  .cat-valve .ind-category { background: #fce7f3; color: #9d174d; }
  .cat-aortic .ind-category { background: #d1fae5; color: #065f46; }
  .cat-ep .ind-category { background: #ede9fe; color: #5b21b6; }
  .cat-other .ind-category { background: #fef3c7; color: #92400e; }
  .cat-paediatric .ind-category { background: #ccfbf1; color: #0f766e; }
  .cat-specialist .ind-category { background: #fee2e2; color: #991b1b; }

  /* Verification badge for guideline-based protocols */
  .verification-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #fef3c7;
    color: #92400e;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #fde68a;
    margin-bottom: 12px;
  }
  .verification-badge svg { flex-shrink: 0; }

  /* Sub-questions */
  .sub-question {
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    margin-top: 16px;
    display: none;
  }

  .sub-question.visible { display: block; }

  .sub-question label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 0.95rem;
  }

  .radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .radio-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    font-size: 0.9rem;
    background: white;
  }

  .radio-option:hover {
    border-color: var(--accent);
    background: #f0fdfa;
  }

  .radio-option.selected {
    border-color: var(--accent);
    background: #f0fdfa;
    font-weight: 600;
  }

  .radio-option input { display: none; }

  /* Result Card */
  .result-section {
    display: none;
    animation: resultFadeIn 0.25s ease;
  }

  .result-section.visible { display: block; }

  @keyframes resultFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .protocol-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .protocol-card-header {
    background: linear-gradient(135deg, var(--accent) 0%, #0f766e 100%);
    color: white;
    padding: 24px 28px;
  }

  .protocol-card-header h2 {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .protocol-card-header .protocol-name-system {
    font-size: 0.9rem;
    opacity: 0.9;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.15);
    padding: 4px 10px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 6px;
  }

  .protocol-card-body { padding: 28px; }

  .param-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
  }

  .param-group {
    background: #f8fafc;
    border-radius: 10px;
    padding: 18px;
    border: 1px solid var(--border);
  }

  .param-group h3 {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--primary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--border);
  }

  .param-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 6px 0;
    font-size: 0.875rem;
    gap: 12px;
  }

  .param-label {
    color: var(--text-light);
    font-weight: 500;
    flex-shrink: 0;
  }

  .param-value {
    color: var(--text);
    font-weight: 600;
    text-align: right;
  }

  .alert-box {
    border-radius: 8px;
    padding: 14px 18px;
    margin-top: 16px;
    font-size: 0.875rem;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    line-height: 1.5;
  }

  .alert-box.warning {
    background: #fffbeb;
    border: 1px solid #fde68a;
    color: #92400e;
  }

  .alert-box.info {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    color: #1e40af;
  }

  .alert-box.danger {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  .alert-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }

  /* Injection table */
  .injection-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
    margin-top: 8px;
  }

  .injection-table th, .injection-table td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .injection-table th {
    background: #e2e8f0;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .injection-table tr:last-child td { border-bottom: none; }

  /* Deviations list */
  .deviations-list {
    list-style: none;
    padding: 0;
  }

  .deviations-list li {
    padding: 8px 0;
    font-size: 0.85rem;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .deviations-list li:last-child { border-bottom: none; }

  .deviations-list li::before {
    content: "•";
    color: var(--accent);
    font-weight: bold;
    flex-shrink: 0;
    margin-top: -1px;
  }

  /* Full-width param group */
  .param-group.full-width {
    grid-column: 1 / -1;
  }

  /* Reset button */
  .reset-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 24px;
  }

  .reset-btn:hover {
    background: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  /* Print button */
  .print-btn {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 24px;
    margin-left: 10px;
  }

  .print-btn:hover {
    background: #f0f5ff;
  }

  /* Quick reference badge */
  .hr-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .hr-badge.low { background: #d1fae5; color: #065f46; }
  .hr-badge.mid { background: #fef3c7; color: #92400e; }
  .hr-badge.high { background: #fecaca; color: #991b1b; }

  .recon-list {
    list-style: none;
    padding: 0;
  }

  .recon-list li {
    padding: 5px 0;
    font-size: 0.85rem;
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }

  .recon-list li::before {
    content: "→";
    color: var(--accent);
    flex-shrink: 0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 12px; }
    .header { padding: 14px 16px; }
    .header h1 { font-size: 1.2rem; }
    .header p { font-size: 0.75rem; }
    .selector-section { padding: 16px; }
    .indication-grid { grid-template-columns: 1fr; gap: 8px; }
    .indication-btn { padding: 12px 14px; }
    .indication-btn .ind-title { font-size: 0.95rem; }
    .param-grid { grid-template-columns: 1fr; gap: 12px; }
    .param-group { padding: 14px; }
    .param-row { flex-direction: column; gap: 2px; }
    .param-value { text-align: left; }
    .radio-group { flex-direction: column; gap: 8px; }
    .radio-option { padding: 12px 14px; font-size: 0.95rem; }
    .protocol-card-header { padding: 18px 16px; }
    .protocol-card-header h2 { font-size: 1.15rem; }
    .protocol-card-body { padding: 16px; }
    .reset-btn, .print-btn { width: 100%; margin-left: 0; text-align: center; }
    .injection-table { font-size: 0.8rem; }
    .injection-table th, .injection-table td { padding: 6px 8px; }
  }

  /* Extra small screens (iPhone SE etc) */
  @media (max-width: 375px) {
    .header h1 { font-size: 1.05rem; }
    .indication-btn .ind-desc { font-size: 0.75rem; }
    .param-group h3 { font-size: 0.7rem; }
  }

  @media print {
    .header { position: static; }
    .selector-section { display: none; }
    .result-section { display: block !important; }
    .reset-btn, .print-btn { display: none; }
    body { background: white; }
  }

  .footer {
    text-align: center;
    padding: 24px;
    color: var(--text-light);
    font-size: 0.8rem;
  }

  /* ============================================================
     CLINICAL QUERY FEATURE
     ============================================================ */
  .clinical-query-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 28px;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
    border-left: 4px solid var(--accent);
  }

  .clinical-query-section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .clinical-query-section .query-subtitle {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-bottom: 16px;
  }

  .query-input-wrapper {
    display: flex;
    align-items: center;
    background: #f8fafc;
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 0 16px;
    transition: all 0.2s;
  }

  .query-input-wrapper:focus-within {
    border-color: var(--primary);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(26, 75, 140, 0.1);
  }

  .query-input-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    color: var(--text-light);
    margin-right: 12px;
  }

  .query-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 1rem;
    font-family: inherit;
    padding: 14px 0;
    color: var(--text);
    outline: none;
    width: 100%;
  }

  .query-input::placeholder {
    color: #94a3b8;
  }

  .query-clear-btn {
    flex-shrink: 0;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-light);
    padding: 4px;
    display: none;
    font-size: 1.2rem;
    line-height: 1;
  }

  .query-clear-btn.visible {
    display: block;
  }

  .query-results {
    margin-top: 16px;
    display: none;
  }

  .query-results.visible {
    display: block;
  }

  .query-results-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-light);
    margin-bottom: 10px;
  }

  .query-result-card {
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .query-result-card:hover {
    border-color: var(--primary-light);
    background: #f0f5ff;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .query-result-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }

  .query-result-header .ind-category {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 8px;
    border-radius: 4px;
  }

  .query-confidence {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: auto;
  }

  .query-confidence.best {
    background: #d1fae5;
    color: #065f46;
  }

  .query-confidence.good {
    background: #dbeafe;
    color: #1e40af;
  }

  .query-confidence.possible {
    background: #fef3c7;
    color: #92400e;
  }

  .query-result-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text);
    margin-bottom: 4px;
  }

  .query-matched-terms {
    font-size: 0.78rem;
    color: var(--text-light);
    margin-bottom: 6px;
    line-height: 1.4;
  }

  .query-matched-terms mark {
    background: #fef9c3;
    color: var(--text);
    padding: 0 3px;
    border-radius: 2px;
    font-weight: 500;
  }

  .query-guideline {
    font-size: 0.72rem;
    color: var(--text-light);
    border-left: 2px solid var(--accent);
    padding-left: 8px;
    font-style: italic;
  }

  .query-no-results {
    text-align: center;
    padding: 20px;
    color: var(--text-light);
    font-size: 0.9rem;
  }

  .query-separator {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    color: var(--text-light);
    font-size: 0.8rem;
  }

  .query-separator::before,
  .query-separator::after {
    content: "";
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Clinical query responsive */
  @media (max-width: 768px) {
    .clinical-query-section { padding: 16px; }
    .query-input { font-size: 0.95rem; padding: 12px 0; }
    .query-result-card { padding: 12px 14px; }
    .query-confidence { font-size: 0.6rem; }
  }

  @media (max-width: 375px) {
    .clinical-query-section h2 { font-size: 1rem; }
    .query-result-title { font-size: 0.9rem; }
  }

  @media print {
    .clinical-query-section { display: none; }
    .query-separator { display: none; }
    .back-btn { display: none; }
    .view { display: block !important; animation: none !important; }
    #browseView { display: none !important; }
    #detailView { display: block !important; }
  }

  /* ============================================================
     MULTI-VIEW SPA
     ============================================================ */
  .view {
    display: none;
  }

  .view.active {
    display: block;
    animation: viewSlideIn 0.28s ease-out;
  }

  .view.active.no-animate {
    animation: none;
  }

  @keyframes viewSlideIn {
    from { opacity: 0; transform: translateX(40px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes viewSlideBack {
    from { opacity: 0; transform: translateX(-40px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .view.active.slide-back {
    animation: viewSlideBack 0.28s ease-out;
  }

  /* Back button */
  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 10px 18px;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 20px;
    -webkit-tap-highlight-color: transparent;
  }

  .back-btn:hover {
    border-color: var(--primary-light);
    background: #f0f5ff;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .back-btn:active {
    transform: translateY(0);
    box-shadow: none;
  }

  .back-btn svg {
    flex-shrink: 0;
  }

  /* Detail view header showing selected protocol name */
  .detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .detail-protocol-label {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-light);
    background: #f1f5f9;
    padding: 4px 12px;
    border-radius: 6px;
  }

  @media (max-width: 768px) {
    .back-btn { padding: 10px 14px; font-size: 0.9rem; }
  }

  /* ============================================================
     LEARNING CENTRE
     ============================================================ */

  /* Entry banner on browse view */
  .learn-entry-banner {
    display: flex;
    align-items: center;
    gap: 14px;
    background: linear-gradient(135deg, #1e3a5f 0%, #1a4b8c 100%);
    color: white;
    border-radius: var(--radius);
    padding: 18px 22px;
    margin-bottom: 24px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-md);
    -webkit-tap-highlight-color: transparent;
  }

  .learn-entry-banner:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .learn-entry-banner:active {
    transform: translateY(0);
  }

  .learn-entry-banner .learn-banner-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .learn-entry-banner .learn-banner-text {
    flex: 1;
  }

  .learn-entry-banner .learn-banner-text strong {
    display: block;
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 2px;
  }

  .learn-entry-banner .learn-banner-text span {
    font-size: 0.8rem;
    opacity: 0.85;
  }

  .learn-entry-banner .learn-banner-arrow {
    flex-shrink: 0;
    opacity: 0.6;
  }

  /* Learn Hub filter tabs */
  .learn-filter-tabs {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 4px;
    margin-bottom: 20px;
    scrollbar-width: none;
  }

  .learn-filter-tabs::-webkit-scrollbar { display: none; }

  .learn-filter-tab {
    flex-shrink: 0;
    padding: 8px 16px;
    border-radius: 20px;
    border: 2px solid var(--border);
    background: var(--card-bg);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .learn-filter-tab:hover {
    border-color: var(--primary-light);
    color: var(--primary);
  }

  .learn-filter-tab.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  /* Learn Hub search */
  .learn-search-wrapper {
    display: flex;
    align-items: center;
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 0 16px;
    margin-bottom: 20px;
    transition: all 0.2s;
  }

  .learn-search-wrapper:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(26, 75, 140, 0.1);
  }

  .learn-search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 0.95rem;
    font-family: inherit;
    padding: 12px 0;
    color: var(--text);
    outline: none;
  }

  .learn-search-input::placeholder { color: #94a3b8; }

  /* Learn Hub card grid */
  .learn-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }

  .learn-card {
    background: var(--card-bg);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 18px 20px;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }

  .learn-card:hover {
    border-color: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .learn-card .learn-card-category {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 8px;
    border-radius: 4px;
    margin-bottom: 8px;
  }

  .learn-card h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 6px;
  }

  .learn-card .learn-card-summary {
    font-size: 0.82rem;
    color: var(--text-light);
    line-height: 1.5;
  }

  .learn-card .learn-card-question {
    font-size: 0.78rem;
    color: var(--accent);
    font-style: italic;
    margin-top: 8px;
    font-weight: 500;
  }

  /* Learn category group headings in hub */
  .learn-category-heading {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-light);
    margin-top: 24px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--border);
  }

  .learn-category-heading:first-child { margin-top: 0; }

  /* Learn Detail header */
  .learn-detail-header {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
    border-left: 4px solid var(--accent);
  }

  .learn-detail-header .learn-detail-category {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 8px;
    border-radius: 4px;
    margin-bottom: 10px;
  }

  .learn-detail-header h2 {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
  }

  .learn-detail-header .learn-detail-summary {
    font-size: 0.95rem;
    color: var(--text-light);
    line-height: 1.6;
  }

  .learn-detail-header .learn-detail-question {
    font-size: 0.9rem;
    color: var(--accent);
    font-weight: 600;
    font-style: italic;
    margin-top: 10px;
  }

  /* Section quick-nav pills */
  .learn-section-nav {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 12px 0;
    margin-bottom: 8px;
    position: sticky;
    top: 60px;
    z-index: 50;
    background: var(--bg);
    scrollbar-width: none;
  }

  .learn-section-nav::-webkit-scrollbar { display: none; }

  .learn-section-nav button {
    flex-shrink: 0;
    padding: 6px 14px;
    border-radius: 16px;
    border: 1.5px solid var(--border);
    background: var(--card-bg);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .learn-section-nav button:hover,
  .learn-section-nav button:active {
    border-color: var(--accent);
    color: var(--accent);
    background: #f0fdfa;
  }

  /* Collapsible sections */
  .learn-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 12px;
    overflow: hidden;
  }

  .learn-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    cursor: pointer;
    transition: background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .learn-section-header:hover {
    background: #f8fafc;
  }

  .learn-section-header h3 {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .learn-section-chevron {
    transition: transform 0.25s;
    color: var(--text-light);
    flex-shrink: 0;
  }

  .learn-section.open .learn-section-chevron {
    transform: rotate(180deg);
  }

  .learn-section-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease, padding 0.25s ease;
    padding: 0 20px;
  }

  .learn-section.open .learn-section-body {
    max-height: 3000px;
    padding: 0 20px 20px;
  }

  /* Content styles inside sections */
  .learn-list {
    list-style: none;
    padding: 0;
  }

  .learn-list li {
    padding: 6px 0;
    font-size: 0.88rem;
    line-height: 1.5;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    color: var(--text);
  }

  .learn-list li::before {
    content: ""; flex-shrink: 0; width: 6px; height: 6px;
    background: var(--accent); border-radius: 50%; margin-top: 8px;
  }

  .learn-numbered-list {
    list-style: none;
    padding: 0;
    counter-reset: learn-counter;
  }

  .learn-numbered-list li {
    padding: 8px 0;
    font-size: 0.88rem;
    line-height: 1.5;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    color: var(--text);
    counter-increment: learn-counter;
  }

  .learn-numbered-list li::before {
    content: counter(learn-counter);
    flex-shrink: 0;
    width: 24px; height: 24px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.72rem;
    font-weight: 700;
    margin-top: 1px;
  }

  .learn-scenario-card {
    background: #f0fdfa;
    border: 1px solid #ccfbf1;
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 8px;
    font-size: 0.85rem;
    line-height: 1.5;
    color: var(--text);
  }

  .learn-scenario-card strong {
    color: var(--accent);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .learn-rationale-block {
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 10px;
  }

  .learn-rationale-block h4 {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 6px;
  }

  .learn-rationale-block p {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--text);
  }

  /* Decision guide use/don't use */
  .learn-decision-use {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 10px;
  }

  .learn-decision-use h4 { color: #166534; }

  .learn-decision-avoid {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 10px;
  }

  .learn-decision-avoid h4 { color: #991b1b; }

  .learn-decision-use h4,
  .learn-decision-avoid h4 {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 8px;
  }

  .learn-alternative-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .learn-alternative-card:hover {
    border-color: var(--accent);
    background: #f0fdfa;
  }

  .learn-alternative-card .alt-name {
    font-weight: 600;
    font-size: 0.88rem;
    color: var(--text);
  }

  .learn-alternative-card .alt-reason {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  /* Guideline reference cards */
  .learn-guideline-card {
    border-left: 3px solid var(--accent);
    padding: 10px 14px;
    margin-bottom: 8px;
    background: #f8fafc;
    border-radius: 0 8px 8px 0;
  }

  .learn-guideline-card .guide-name {
    font-weight: 600;
    font-size: 0.88rem;
    color: var(--text);
  }

  .learn-guideline-card .guide-relevance {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 2px;
  }

  .learn-evidence-summary {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    padding: 14px 16px;
    font-size: 0.88rem;
    line-height: 1.6;
    color: #1e40af;
    margin-top: 12px;
  }

  /* CTA link to protocol parameters */
  .learn-to-protocol-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius);
    padding: 14px 24px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 20px;
    margin-bottom: 10px;
    -webkit-tap-highlight-color: transparent;
  }

  .learn-to-protocol-link:hover {
    background: #0f766e;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  /* "Why this protocol?" link in detail view */
  .learn-why-link {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f0fdfa;
    border: 2px solid #ccfbf1;
    border-radius: var(--radius);
    padding: 14px 18px;
    margin-top: 20px;
    cursor: pointer;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .learn-why-link:hover {
    border-color: var(--accent);
    background: #e6faf7;
    transform: translateY(-1px);
  }

  .learn-why-link .why-icon {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    background: var(--accent);
    color: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .learn-why-link .why-text strong {
    display: block;
    font-size: 0.9rem;
    color: var(--text);
  }

  .learn-why-link .why-text span {
    font-size: 0.78rem;
    color: var(--text-light);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .learn-entry-banner { padding: 14px 16px; }
    .learn-card-grid { grid-template-columns: 1fr; }
    .learn-card { padding: 14px 16px; }
    .learn-detail-header { padding: 18px 16px; }
    .learn-detail-header h2 { font-size: 1.15rem; }
    .learn-section-header { padding: 14px 16px; }
    .learn-section.open .learn-section-body { padding: 0 16px 16px; }
    .learn-section-nav { top: 50px; }
    .learn-to-protocol-link { width: 100%; }
  }

  @media (max-width: 375px) {
    .learn-filter-tab { padding: 6px 12px; font-size: 0.78rem; }
    .learn-section-nav button { padding: 5px 10px; font-size: 0.7rem; }
  }

  @media print {
    .learn-entry-banner { display: none; }
    .learn-filter-tabs { display: none; }
    .learn-search-wrapper { display: none; }
    .learn-section-nav { display: none; }
    .learn-section { break-inside: avoid; }
    .learn-section-body { max-height: none !important; padding: 0 20px 20px !important; }
    .learn-to-protocol-link { display: none; }
    .learn-why-link { display: none; }
  }

  /* ============================================================
     CLINICAL TOOLS HUB
     ============================================================ */
  .tools-entry-banner {
    display: flex; align-items: center; gap: 14px;
    background: linear-gradient(135deg, #065f46 0%, #0d9488 100%);
    color: white; border-radius: var(--radius);
    padding: 18px 22px; margin-bottom: 12px;
    cursor: pointer; transition: all 0.2s;
    box-shadow: var(--shadow-md);
    -webkit-tap-highlight-color: transparent;
  }
  .tools-entry-banner:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  .tools-entry-banner:active { transform: translateY(0); }

  .quiz-entry-banner {
    display: flex; align-items: center; gap: 14px;
    background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
    color: white; border-radius: var(--radius);
    padding: 18px 22px; margin-bottom: 24px;
    cursor: pointer; transition: all 0.2s;
    box-shadow: var(--shadow-md);
    -webkit-tap-highlight-color: transparent;
  }
  .quiz-entry-banner:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  .quiz-entry-banner:active { transform: translateY(0); }

  .tools-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px; margin-bottom: 24px;
  }

  .tool-card {
    background: var(--card-bg); border: 2px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    cursor: pointer; transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .tool-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .tool-card.active { border-color: var(--accent); background: #f0fdfa; }
  .tool-card .tool-icon {
    width: 40px; height: 40px; background: var(--accent); color: white;
    border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; font-size: 1.2rem;
  }
  .tool-card h3 { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .tool-card p { font-size: 0.82rem; color: var(--text-light); line-height: 1.5; }

  .calc-section {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 24px; box-shadow: var(--shadow); margin-bottom: 16px;
  }
  .calc-section h3 {
    font-size: 1.05rem; font-weight: 700; color: var(--primary);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }
  .calc-form-group { margin-bottom: 16px; }
  .calc-form-group label {
    display: block; font-size: 0.85rem; font-weight: 600;
    color: var(--text); margin-bottom: 6px;
  }
  .calc-input, .calc-select {
    width: 100%; padding: 12px 14px; border: 2px solid var(--border);
    border-radius: 8px; font-size: 0.95rem; font-family: inherit;
    color: var(--text); background: var(--card-bg); transition: border-color 0.2s;
    box-sizing: border-box;
  }
  .calc-input:focus, .calc-select:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(26,75,140,0.1);
  }
  .calc-select { appearance: none; background-repeat: no-repeat; background-position: right 12px center; }
  .calc-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .calc-btn {
    background: var(--accent); color: white; border: none;
    padding: 12px 24px; border-radius: 8px; font-size: 0.95rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; width: 100%;
  }
  .calc-btn:hover { background: #0f766e; transform: translateY(-1px); box-shadow: var(--shadow-md); }

  .calc-result {
    background: #f0fdfa; border: 2px solid #ccfbf1; border-radius: var(--radius);
    padding: 20px; margin-top: 16px; display: none;
  }
  .calc-result.visible { display: block; }
  .calc-result h4 { font-size: 0.9rem; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
  .calc-result-row {
    display: flex; justify-content: space-between; padding: 8px 0;
    font-size: 0.9rem; border-bottom: 1px solid #e2e8f0;
  }
  .calc-result-row:last-child { border-bottom: none; }
  .calc-result-label { color: var(--text-light); font-weight: 500; }
  .calc-result-value { color: var(--text); font-weight: 700; text-align: right; }

  .calc-warning {
    background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px;
    padding: 12px 16px; margin-top: 12px; font-size: 0.85rem; color: #92400e; line-height: 1.5;
  }
  .calc-danger {
    background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;
    padding: 12px 16px; margin-top: 12px; font-size: 0.85rem; color: #991b1b; line-height: 1.5; font-weight: 600;
  }

  .risk-badge {
    display: inline-block; padding: 4px 12px; border-radius: 20px;
    font-size: 0.8rem; font-weight: 700; text-transform: uppercase;
  }
  .risk-badge.low { background: #d1fae5; color: #065f46; }
  .risk-badge.moderate { background: #fef3c7; color: #92400e; }
  .risk-badge.high { background: #fecaca; color: #991b1b; }

  /* ============================================================
     SCAN RANGE & CONTRAST TIMING HIGHLIGHTS
     ============================================================ */
  .scan-range-highlight {
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    border: 2px solid #3b82f6;
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .scan-range-highlight .hl-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    margin-top: 1px;
    line-height: 1;
  }
  .scan-range-highlight .hl-content { flex: 1; }
  .scan-range-highlight .hl-label {
    font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.6px; color: #1d4ed8; margin-bottom: 3px;
  }
  .scan-range-highlight .hl-value {
    font-size: 0.98rem; font-weight: 600; color: #1e3a5f; line-height: 1.4;
  }

  .contrast-timing-highlight {
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    border: 2px solid #f59e0b;
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .contrast-timing-highlight .hl-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    margin-top: 1px;
    line-height: 1;
  }
  .contrast-timing-highlight .hl-content { flex: 1; }
  .contrast-timing-highlight .hl-label {
    font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.6px; color: #b45309; margin-bottom: 3px;
  }
  .contrast-timing-highlight .hl-value {
    font-size: 0.98rem; font-weight: 600; color: #78350f; line-height: 1.4;
  }
  .contrast-timing-highlight .hl-sub {
    font-size: 0.82rem; font-weight: 400; color: #92400e; margin-top: 4px; line-height: 1.35;
  }

  .injection-type-highlight {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 2px solid #22c55e;
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 14px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .injection-type-highlight .hl-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    margin-top: 1px;
    line-height: 1;
  }
  .injection-type-highlight .hl-content { flex: 1; }
  .injection-type-highlight .hl-label {
    font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.6px; color: #15803d; margin-bottom: 3px;
  }
  .injection-type-highlight .hl-value {
    font-size: 0.98rem; font-weight: 600; color: #14532d; line-height: 1.4;
  }
  .injection-type-highlight .hl-sub {
    font-size: 0.82rem; font-weight: 400; color: #166534; margin-top: 4px; line-height: 1.35;
  }
  .injection-type-badge {
    display: inline-block; padding: 3px 10px; border-radius: 12px;
    font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.4px; margin-left: 8px; vertical-align: middle;
  }
  .injection-type-badge.standard { background: #d1fae5; color: #065f46; }
  .injection-type-badge.long-injection { background: #dbeafe; color: #1e40af; }
  .injection-type-badge.bastion-wheel { background: #fce7f3; color: #9d174d; }
  .injection-type-badge.erasmus { background: #ede9fe; color: #5b21b6; }
  .injection-type-badge.flash { background: #fef3c7; color: #92400e; }
  .injection-type-badge.weight-based { background: #e0e7ff; color: #3730a3; }
  .injection-type-badge.none { background: #f1f5f9; color: #475569; }
  .injection-type-badge.manual { background: #fef2f2; color: #991b1b; }

  .highlight-row {
    display: flex; gap: 10px; flex-wrap: wrap;
  }
  .highlight-row > div { flex: 1; min-width: 260px; }

  @media (max-width: 768px) {
    .highlight-row { flex-direction: column; }
    .highlight-row > div { min-width: unset; }
  }

  .calc-contra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .calc-contra-item {
    display: flex; align-items: center; gap: 8px; font-size: 0.88rem;
    padding: 8px 10px; background: #f8fafc; border-radius: 6px; cursor: pointer;
  }
  .calc-contra-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--danger); }

  /* ============================================================
     CHECKLISTS (protocol detail integration)
     ============================================================ */
  .checklist-container { margin-top: 24px; }
  .checklist-container > h2 {
    font-size: 1.05rem; font-weight: 700; color: var(--primary);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }
  .checklist-phase {
    background: var(--card-bg); border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 12px; overflow: hidden;
  }
  .checklist-phase-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; cursor: pointer; transition: background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .checklist-phase-header:hover { background: #f8fafc; }
  .checklist-phase-header h3 {
    font-size: 0.9rem; font-weight: 700; color: var(--primary);
    display: flex; align-items: center; gap: 8px;
  }
  .checklist-phase-header .cl-chevron {
    transition: transform 0.25s; color: var(--text-light);
  }
  .checklist-phase.open .cl-chevron { transform: rotate(180deg); }
  .checklist-progress {
    font-size: 0.75rem; font-weight: 600; color: var(--text-light);
    display: flex; align-items: center; gap: 8px;
  }
  .checklist-progress-bar {
    width: 80px; height: 6px; background: var(--border);
    border-radius: 3px; overflow: hidden;
  }
  .checklist-progress-fill {
    height: 100%; background: var(--success); border-radius: 3px;
    transition: width 0.3s ease;
  }
  .checklist-body {
    max-height: 0; overflow: hidden;
    transition: max-height 0.35s ease, padding 0.25s ease;
    padding: 0 18px;
  }
  .checklist-phase.open .checklist-body {
    max-height: 2000px; padding: 0 18px 18px;
  }
  .checklist-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 10px 0; border-bottom: 1px solid #f1f5f9;
  }
  .checklist-item:last-child { border-bottom: none; }
  .checklist-item input[type="checkbox"] {
    width: 20px; height: 20px; accent-color: var(--accent);
    cursor: pointer; flex-shrink: 0; margin-top: 2px;
  }
  .checklist-item-label { font-size: 0.88rem; color: var(--text); line-height: 1.5; }
  .checklist-item.checked .checklist-item-label {
    text-decoration: line-through; color: var(--text-light);
  }

  /* ============================================================
     QUIZ MODE
     ============================================================ */
  .quiz-hub-header {
    border-left: 4px solid #7c3aed; background: var(--card-bg);
    border-radius: var(--radius); padding: 20px 24px;
    box-shadow: var(--shadow); margin-bottom: 20px;
  }
  .quiz-hub-header h2 { font-size: 1.15rem; font-weight: 700; color: #5b21b6; margin-bottom: 4px; }
  .quiz-hub-header p { font-size: 0.85rem; color: var(--text-light); }

  .quiz-progress-dashboard {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 20px 24px; box-shadow: var(--shadow); margin-bottom: 20px;
  }
  .quiz-progress-dashboard h3 {
    font-size: 0.9rem; font-weight: 700; color: var(--primary); margin-bottom: 12px;
  }
  .quiz-progress-row {
    display: flex; align-items: center; padding: 8px 0;
    border-bottom: 1px solid #f1f5f9;
  }
  .quiz-progress-row:last-child { border-bottom: none; }
  .quiz-progress-label { font-size: 0.85rem; font-weight: 600; min-width: 130px; }
  .quiz-progress-bar-track {
    flex: 1; height: 8px; background: var(--border);
    border-radius: 4px; margin: 0 12px; overflow: hidden;
  }
  .quiz-progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
  .quiz-progress-pct { font-size: 0.8rem; font-weight: 600; color: var(--text-light); min-width: 45px; text-align: right; }

  .quiz-section-label {
    font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.06em; color: var(--text-light); margin: 24px 0 12px;
  }
  .quiz-hub-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 12px; margin-bottom: 24px;
  }
  .quiz-category-card {
    background: var(--card-bg); border: 2px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    cursor: pointer; transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .quiz-category-card:hover { border-color: #7c3aed; transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .quiz-category-card .quiz-cat-icon { font-size: 1.4rem; margin-bottom: 6px; }
  .quiz-category-card h3 { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
  .quiz-category-card p { font-size: 0.82rem; color: var(--text-light); }

  .quiz-question-card {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 24px; box-shadow: var(--shadow); margin-bottom: 16px;
  }
  .quiz-question-progress { font-size: 0.8rem; color: var(--text-light); margin-bottom: 8px; }
  .quiz-question-text {
    font-size: 1rem; font-weight: 600; color: var(--text);
    margin-bottom: 16px; line-height: 1.6;
  }
  .quiz-option {
    display: block; width: 100%; text-align: left;
    padding: 14px 18px; border: 2px solid var(--border);
    border-radius: 10px; background: var(--card-bg);
    margin-bottom: 8px; cursor: pointer; transition: all 0.15s;
    font-size: 0.9rem; font-family: inherit; color: var(--text);
  }
  .quiz-option:hover { border-color: #7c3aed; background: #faf5ff; }
  .quiz-option.correct { border-color: var(--success); background: #f0fdf4; color: #166534; }
  .quiz-option.incorrect { border-color: var(--danger); background: #fef2f2; color: #991b1b; }
  .quiz-option.disabled { pointer-events: none; opacity: 0.7; }
  .quiz-option.dimmed { opacity: 0.5; pointer-events: none; }

  .quiz-feedback {
    padding: 14px 18px; border-radius: 8px; margin-top: 12px;
    font-size: 0.88rem; line-height: 1.5; display: none;
  }
  .quiz-feedback.visible { display: block; }
  .quiz-feedback.correct-fb { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
  .quiz-feedback.incorrect-fb { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }

  .quiz-next-btn {
    background: #5b21b6; color: white; border: none;
    padding: 12px 24px; border-radius: 8px; font-size: 0.95rem;
    font-weight: 600; cursor: pointer; margin-top: 12px; transition: all 0.15s;
  }
  .quiz-next-btn:hover { background: #6d28d9; }
  .quiz-next-btn.outline { background: transparent; color: #5b21b6; border: 2px solid #5b21b6; }

  .case-patient-info {
    background: #f8fafc; border: 1px solid var(--border); border-radius: 8px;
    padding: 14px 16px; margin-bottom: 16px; font-size: 0.9rem; line-height: 1.6;
  }
  .case-step-card {
    background: var(--card-bg); border-radius: var(--radius);
    padding: 24px; box-shadow: var(--shadow); margin-bottom: 16px;
    border-left: 4px solid var(--accent);
  }
  .case-history-card {
    background: var(--card-bg); border-radius: 8px;
    padding: 12px 16px; margin-bottom: 8px; opacity: 0.7;
    border-left: 4px solid var(--success); font-size: 0.85rem;
  }
  .case-history-card.wrong { border-left-color: var(--danger); }

  .quiz-score-display {
    font-size: 2.5rem; font-weight: 700; margin: 12px 0;
  }

  /* Responsive for tools/quiz/checklists */
  @media (max-width: 768px) {
    .tools-card-grid { grid-template-columns: 1fr; }
    .calc-section { padding: 16px; }
    .calc-row { grid-template-columns: 1fr; }
    .calc-contra-grid { grid-template-columns: 1fr; }
    .quiz-hub-grid { grid-template-columns: 1fr; }
    .quiz-question-card { padding: 16px; }
    .tools-entry-banner, .quiz-entry-banner { padding: 14px 16px; }
    .checklist-phase-header { padding: 12px 14px; }
    .checklist-phase.open .checklist-body { padding: 0 14px 14px; }
  }

  @media (max-width: 375px) {
    .quiz-option { padding: 12px 14px; font-size: 0.85rem; }
    .calc-input, .calc-select { font-size: 16px; }
  }

  @media print {
    .tools-entry-banner, .quiz-entry-banner { display: none; }
    .checklist-container { break-inside: avoid; }
    .checklist-body { max-height: none !important; padding: 0 18px 18px !important; }
    .checklist-phase .cl-chevron { display: none; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Brompton CTCA Protocol Selector</h1>
  <p>Royal Brompton Hospital &mdash; Siemens SOMATOM Force / Flash CT Scanner</p>
</div>

<div class="container">

  <!-- ===== VIEW 1: BROWSE ===== -->
  <div id="browseView" class="view active no-animate">

  <!-- Clinical Query -->
  <div class="clinical-query-section">
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      Clinical Query
    </h2>
    <p class="query-subtitle">Type a clinical question and get evidence-based protocol recommendations (SCCT / BSCI)</p>
    <div class="query-input-wrapper">
      <svg class="query-input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" class="query-input" id="clinicalQueryInput" placeholder="e.g. 'assess CAD', 'pre TAVI planning', 'AF ablation'..." autocomplete="off" autocapitalize="off" spellcheck="false" oninput="onQueryInput(this.value)">
      <button class="query-clear-btn" id="queryClearBtn" onclick="clearQuery()" aria-label="Clear search">&times;</button>
    </div>
    <div class="query-results" id="queryResults"></div>
  </div>

  <div class="query-separator">Or browse protocols below</div>

  <!-- Learning Centre Entry -->
  <div class="learn-entry-banner" onclick="navigateTo('learn')">
    <div class="learn-banner-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <div class="learn-banner-text">
      <strong>Protocol Learning Centre</strong>
      <span>Understand why each protocol is used and when</span>
    </div>
    <div class="learn-banner-arrow">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </div>
  </div>

  <!-- Clinical Tools Entry -->
  <div class="tools-entry-banner" onclick="navigateTo('tools')">
    <div class="learn-banner-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
    </div>
    <div class="learn-banner-text">
      <strong>Clinical Tools</strong>
      <span>Calculators for contrast, renal risk, dosing &amp; radiation</span>
    </div>
    <div class="learn-banner-arrow">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </div>
  </div>

  <!-- Quiz Mode Entry -->
  <div class="quiz-entry-banner" onclick="navigateTo('quiz')">
    <div class="learn-banner-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
    </div>
    <div class="learn-banner-text">
      <strong>Quiz Mode</strong>
      <span>Test your protocol knowledge with MCQs and clinical cases</span>
    </div>
    <div class="learn-banner-arrow">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </div>
  </div>

  <!-- Step 1: Clinical Indication -->
  <div class="selector-section">
    <h2><span class="step-num">1</span> Select Clinical Indication</h2>
    <div class="indication-grid" id="indicationGrid">

      <!-- Coronary -->
      <button class="indication-btn cat-coronary" data-protocol="coronary_arteries" onclick="selectIndication(this)">
        <div class="ind-category">Coronary</div>
        <div class="ind-title">Coronary Arteries</div>
        <div class="ind-desc">Rule out CAD, pre-op planning, anomalous origins, Kawasaki's</div>
      </button>
      <button class="indication-btn cat-coronary" data-protocol="calcium_score" onclick="selectIndication(this)">
        <div class="ind-category">Coronary</div>
        <div class="ind-title">Calcium Score</div>
        <div class="ind-desc">Rule out CAD &mdash; non-contrast calcium scoring</div>
      </button>
      <button class="indication-btn cat-coronary" data-protocol="grafts" onclick="selectIndication(this)">
        <div class="ind-category">Coronary</div>
        <div class="ind-title">Grafts (CABG)</div>
        <div class="ind-desc">Visualise bypass grafts + native coronaries, congenital + coro's</div>
      </button>

      <!-- Valvular -->
      <button class="indication-btn cat-valve" data-protocol="tavi_no_coros" onclick="selectIndication(this)">
        <div class="ind-category">Valve</div>
        <div class="ind-title">TAVI (No Coronaries)</div>
        <div class="ind-desc">Severe AS, TAVI planning &mdash; cath within 12 months</div>
      </button>
      <button class="indication-btn cat-valve" data-protocol="tavi_plus_coros" onclick="selectIndication(this)">
        <div class="ind-category">Valve</div>
        <div class="ind-title">TAVI + Coronaries</div>
        <div class="ind-desc">Severe AS, TAVI planning &mdash; no cath in last 12 months</div>
      </button>
      <button class="indication-btn cat-valve" data-protocol="4d_valve" onclick="selectIndication(this)">
        <div class="ind-category">Valve</div>
        <div class="ind-title">4D Valve</div>
        <div class="ind-desc">Post TAVI assessment &mdash; ?thrombus on leaflets, ?failing TAVI</div>
      </button>
      <button class="indication-btn cat-valve" data-protocol="mitral_valve" onclick="selectIndication(this)">
        <div class="ind-category">Valve</div>
        <div class="ind-title">Mitral Valve</div>
        <div class="ind-desc">Assess mitral valve suitability and motility pre-surgery</div>
      </button>
      <button class="indication-btn cat-valve" data-protocol="evoque" onclick="selectIndication(this)">
        <div class="ind-category">Valve</div>
        <div class="ind-title">EVOQUE</div>
        <div class="ind-desc">Transcatheter tricuspid valve replacement planning</div>
      </button>
      <button class="indication-btn cat-valve" data-protocol="tendyne" onclick="selectIndication(this)">
        <div class="ind-category">Valve</div>
        <div class="ind-title">Tendyne GFS</div>
        <div class="ind-desc">Mitral annulus + LV dimensions, rule out LVOT obstruction (research)</div>
      </button>

      <!-- Aortic -->
      <button class="indication-btn cat-aortic" data-protocol="gated_thoracic_aorta" onclick="selectIndication(this)">
        <div class="ind-category">Aortic</div>
        <div class="ind-title">Gated Thoracic Aorta</div>
        <div class="ind-desc">Dilated ascending aorta, Marfans, aneurysm, coarctation, dissection</div>
      </button>
      <button class="indication-btn cat-aortic" data-protocol="aortic_pears" onclick="selectIndication(this)">
        <div class="ind-category">Aortic</div>
        <div class="ind-title">Aortic PEARS</div>
        <div class="ind-desc">ExoVasc personalised external aortic root support (dilated aorta)</div>
      </button>
      <button class="indication-btn cat-aortic" data-protocol="ross_pears" onclick="selectIndication(this)">
        <div class="ind-category">Aortic</div>
        <div class="ind-title">Ross PEARS</div>
        <div class="ind-desc">ExoVasc support for pulmonary autograft &mdash; Ross-PEARS operation</div>
      </button>
      <button class="indication-btn cat-aortic" data-protocol="access_routes" onclick="selectIndication(this)">
        <div class="ind-category">Aortic</div>
        <div class="ind-title">Access Routes</div>
        <div class="ind-desc">Pre-surgery aortic planning, vessel calibre/tortuosity, dissection repair, SCAD</div>
      </button>

      <!-- EP -->
      <button class="indication-btn cat-ep" data-protocol="carto" onclick="selectIndication(this)">
        <div class="ind-category">Electrophysiology</div>
        <div class="ind-title">CARTO (Gated PV)</div>
        <div class="ind-desc">Pre AF/AT/VT ablation, Watchman/Lariat, ?LAA thrombus</div>
      </button>
      <button class="indication-btn cat-ep" data-protocol="vivo" onclick="selectIndication(this)">
        <div class="ind-category">Electrophysiology</div>
        <div class="ind-title">VIVO</div>
        <div class="ind-desc">Pre-treatment scan for ablation &mdash; must state VIVO protocol</div>
      </button>
      <button class="indication-btn cat-ep" data-protocol="inheart" onclick="selectIndication(this)">
        <div class="ind-category">Electrophysiology</div>
        <div class="ind-title">INHEART</div>
        <div class="ind-desc">Pre-ablation planning &mdash; arterial + late enhanced CTCA</div>
      </button>

      <!-- Other -->
      <button class="indication-btn cat-other" data-protocol="gated_ctpa" onclick="selectIndication(this)">
        <div class="ind-category">Other</div>
        <div class="ind-title">Gated CTPA (No Coro's)</div>
        <div class="ind-desc">Congenital heart, triple rule out (PE, dissection, CAD)</div>
      </button>

      <!-- Paediatric -->
      <button class="indication-btn cat-paediatric" data-protocol="paediatric_cardiac" onclick="selectIndication(this)">
        <div class="ind-category">Paediatric</div>
        <div class="ind-title">Paediatric Cardiac CT</div>
        <div class="ind-desc">CHD, Kawasaki, anomalous coronaries, vascular rings &mdash; weight-based</div>
      </button>

      <!-- Specialist -->
      <button class="indication-btn cat-specialist" data-protocol="ecmo_ct" onclick="selectIndication(this)">
        <div class="ind-category">Specialist</div>
        <div class="ind-title">ECMO CT</div>
        <div class="ind-desc">Cannula position, complications, cardiac recovery, pre-decannulation</div>
      </button>
    </div>
  </div>

  </div><!-- /browseView -->

  <!-- ===== VIEW 2: DETAIL ===== -->
  <div id="detailView" class="view">

  <!-- Back button -->
  <button class="back-btn" onclick="goBack()">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    Back to Protocols
  </button>

  <!-- Step 2: Sub-questions -->
  <div class="selector-section" id="subQuestionsSection" style="display:none">
    <h2><span class="step-num">2</span> Additional Parameters</h2>

    <div class="sub-question" id="q_hr">
      <label>What is the patient's resting heart rate?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'hr')"><input type="radio" name="hr" value="lt60"> &lt;60 bpm (regular)</div>
        <div class="radio-option" onclick="selectRadio(this, 'hr')"><input type="radio" name="hr" value="60-65"> 60&ndash;65 bpm (regular)</div>
        <div class="radio-option" onclick="selectRadio(this, 'hr')"><input type="radio" name="hr" value="gt65"> &gt;65 bpm or irregular</div>
      </div>
    </div>

    <div class="sub-question" id="q_bmi">
      <label>What is the patient's BMI?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'bmi')"><input type="radio" name="bmi" value="lt20"> &lt;20 (Small)</div>
        <div class="radio-option" onclick="selectRadio(this, 'bmi')"><input type="radio" name="bmi" value="20-28"> 20&ndash;28 (Average)</div>
        <div class="radio-option" onclick="selectRadio(this, 'bmi')"><input type="radio" name="bmi" value="28-30"> 28&ndash;30 (Above average)</div>
        <div class="radio-option" onclick="selectRadio(this, 'bmi')"><input type="radio" name="bmi" value="gt30"> &gt;30 (Large)</div>
      </div>
    </div>

    <div class="sub-question" id="q_cath">
      <label>Has the patient had a coronary angiogram within the last 12 months?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'cath')"><input type="radio" name="cath" value="yes"> Yes &mdash; cath within 12 months</div>
        <div class="radio-option" onclick="selectRadio(this, 'cath')"><input type="radio" name="cath" value="no"> No &mdash; no recent cath</div>
      </div>
    </div>

    <div class="sub-question" id="q_arch">
      <label>Does the referrer want to include the aortic arch? (for retrograde approach)</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'arch')"><input type="radio" name="arch" value="no"> No &mdash; standard range</div>
        <div class="radio-option" onclick="selectRadio(this, 'arch')"><input type="radio" name="arch" value="yes"> Yes &mdash; include arch</div>
      </div>
    </div>

    <div class="sub-question" id="q_tendyne_bmi">
      <label>What is the patient's BMI?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'tendyne_bmi')"><input type="radio" name="tendyne_bmi" value="lt30"> &lt;30 (Average)</div>
        <div class="radio-option" onclick="selectRadio(this, 'tendyne_bmi')"><input type="radio" name="tendyne_bmi" value="gt30"> &gt;30 (Large)</div>
      </div>
    </div>

    <div class="sub-question" id="q_mitral_bmi">
      <label>What is the patient's BMI?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'mitral_bmi')"><input type="radio" name="mitral_bmi" value="lt20"> &lt;20 (Small)</div>
        <div class="radio-option" onclick="selectRadio(this, 'mitral_bmi')"><input type="radio" name="mitral_bmi" value="20-30"> 20&ndash;30 (Average)</div>
        <div class="radio-option" onclick="selectRadio(this, 'mitral_bmi')"><input type="radio" name="mitral_bmi" value="gt30"> &gt;30 (Large)</div>
      </div>
    </div>

    <div class="sub-question" id="q_paed_weight">
      <label>What is the patient's weight?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'paed_weight')"><input type="radio" name="paed_weight" value="lt10"> &lt;10 kg (Neonate / Infant)</div>
        <div class="radio-option" onclick="selectRadio(this, 'paed_weight')"><input type="radio" name="paed_weight" value="10-20"> 10&ndash;20 kg (Infant / Small child)</div>
        <div class="radio-option" onclick="selectRadio(this, 'paed_weight')"><input type="radio" name="paed_weight" value="20-40"> 20&ndash;40 kg (Child)</div>
        <div class="radio-option" onclick="selectRadio(this, 'paed_weight')"><input type="radio" name="paed_weight" value="gt40"> &gt;40 kg (Adolescent)</div>
      </div>
    </div>

    <div class="sub-question" id="q_ecmo_type">
      <label>What type of ECMO support?</label>
      <div class="radio-group">
        <div class="radio-option" onclick="selectRadio(this, 'ecmo_type')"><input type="radio" name="ecmo_type" value="va"> VA-ECMO (Veno-Arterial)</div>
        <div class="radio-option" onclick="selectRadio(this, 'ecmo_type')"><input type="radio" name="ecmo_type" value="vv"> VV-ECMO (Veno-Venous)</div>
      </div>
    </div>
  </div>

  <!-- Result -->
  <div class="result-section" id="resultSection">
    <div class="protocol-card">
      <div class="protocol-card-header">
        <h2 id="resultTitle"></h2>
        <div class="protocol-name-system" id="resultSystemName"></div>
      </div>
      <div class="protocol-card-body" id="resultBody"></div>
    </div>
    <button class="reset-btn" onclick="resetAll()">Start New Selection</button>
    <button class="print-btn" onclick="window.print()">Print Protocol</button>
  </div>

  </div><!-- /detailView -->

  <!-- ===== VIEW 3: LEARN HUB ===== -->
  <div id="learnView" class="view">
    <button class="back-btn" onclick="navigateTo('browse', {slideBack:true})">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      Back to Protocols
    </button>
    <div class="selector-section" style="border-left: 4px solid var(--accent);">
      <h2 style="color:var(--accent);">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        Protocol Learning Centre
      </h2>
      <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:16px;">Tap a protocol to learn about its clinical purpose, anatomy, key learning points, and when to use it.</p>
      <!-- Filter tabs -->
      <div class="learn-filter-tabs" id="learnFilterTabs">
        <button class="learn-filter-tab active" onclick="filterLearnCategory('all', this)">All</button>
        <button class="learn-filter-tab" onclick="filterLearnCategory('coronary', this)">Coronary</button>
        <button class="learn-filter-tab" onclick="filterLearnCategory('valve', this)">Valve</button>
        <button class="learn-filter-tab" onclick="filterLearnCategory('aortic', this)">Aortic</button>
        <button class="learn-filter-tab" onclick="filterLearnCategory('ep', this)">EP</button>
        <button class="learn-filter-tab" onclick="filterLearnCategory('other', this)">Other</button>
      </div>
      <!-- Search -->
      <div class="learn-search-wrapper">
        <svg style="flex-shrink:0;width:18px;height:18px;color:var(--text-light);margin-right:10px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input type="text" class="learn-search-input" id="learnSearchInput" placeholder="Search protocols..." oninput="searchLearnContent(this.value)" autocomplete="off" autocapitalize="off" spellcheck="false">
      </div>
    </div>
    <!-- Card grid rendered by JS -->
    <div id="learnCardGrid" class="learn-card-grid"></div>
  </div><!-- /learnView -->

  <!-- ===== VIEW 4: LEARN DETAIL ===== -->
  <div id="learnDetailView" class="view">
    <button class="back-btn" onclick="navigateLearnBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      Back to Learning Hub
    </button>
    <!-- Content rendered by JS -->
    <div id="learnDetailContent"></div>
  </div><!-- /learnDetailView -->

  <!-- ===== VIEW 5: CLINICAL TOOLS HUB ===== -->
  <div id="toolsView" class="view">
    <button class="back-btn" onclick="navigateTo('browse', {slideBack:true})">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      Back to Protocols
    </button>
    <div class="selector-section" style="border-left:4px solid var(--accent);">
      <h2 style="color:var(--accent);display:flex;align-items:center;gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        Clinical Tools
      </h2>
      <p style="font-size:0.85rem;color:var(--text-light);">Select a clinical calculator or dosing guide below.</p>
    </div>
    <div id="toolsCardGrid" class="tools-card-grid"></div>
    <div id="toolActiveContent"></div>
  </div><!-- /toolsView -->

  <!-- ===== VIEW 6: QUIZ HUB ===== -->
  <div id="quizView" class="view">
    <button class="back-btn" onclick="navigateTo('browse', {slideBack:true})">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      Back to Protocols
    </button>
    <div id="quizHubContent"></div>
  </div><!-- /quizView -->

  <!-- ===== VIEW 7: QUIZ CASE ===== -->
  <div id="quizCaseView" class="view">
    <button class="back-btn" onclick="navigateTo('quiz', {slideBack:true})">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      Back to Quiz Hub
    </button>
    <div id="quizCaseContent"></div>
  </div><!-- /quizCaseView -->

</div>

<div class="footer">
  Brompton CTCA Protocol Selector &mdash; For clinical reference only. Always verify parameters on scanner.<br>
  App developed by Dr Charles Badu-Boateng. Last updated: 2025.
</div>

<script>
// ============================================================
// PROTOCOL DATABASE
// ============================================================
const protocols = {

  coronary_arteries: {
    title: "Coronary Arteries",
    systemName: "Coronary_Angio (all BMIs)",
    category: "Adult > Cardiac Region",
    indications: ["Rule out CAD", "Pre-operative planning", "Anomalous origins of coronary arteries", "Kawasaki's disease"],
    note: "Only perform calcium score if protocolled by radiologist.",
    patientPosition: "Supine, Head first",
    patientPrep: "Perform baseline BP and SpO2. Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: {
      betaBlockers: "Yes — if HR >60 bpm and not contra-indicated",
      gtn: "Depending on Radiologist and if not contra-indicated",
      note: "Contra-indications on reverse of cardiac patient questionnaire"
    },
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina. If no calcium score required, right-click on indented CaSc and add control scan. Delete the calcium score after.",
    calciumScore: "Carina to base of heart (if protocolled by radiologist)",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    getAcquisition: function(hr) {
      if (hr === 'lt60') {
        return {
          mode: "TURBO FLASH",
          description: "Flash acquisition",
          range: "Carina to domes of diaphragm (base of heart) — use CaSc to help plan",
          delay: "Test bolus timing + 5s delay",
          badge: '<span class="hr-badge low">HR &lt;60 regular</span>'
        };
      } else if (hr === '60-65') {
        return {
          mode: "END DIASTOLIC — Adaptive Sequential (60%-80%)",
          description: "Diastolic adaptive sequential",
          range: "Carina to domes of diaphragm (base of heart) — use CaSc to help plan",
          delay: "Test bolus timing + 3s delay",
          trigger: "Set scan and range per HR look-up table (Appendix 1)",
          badge: '<span class="hr-badge mid">HR 60-65 regular</span>'
        };
      } else {
        return {
          mode: "END SYSTOLIC — Adaptive Sequential (ms timing)",
          description: "Systolic adaptive sequential",
          range: "Carina to domes of diaphragm (base of heart) — use CaSc to help plan",
          delay: "Test bolus timing + 3s delay",
          trigger: "Set scan and range per HR look-up table (Appendix 1)",
          badge: '<span class="hr-badge high">HR &gt;65 or irregular</span>'
        };
      }
    },
    getInjection: function(bmi) {
      const isBig = (bmi === '28-30' || bmi === 'gt30');
      return {
        protocolName: isBig ? "Cardiac coro large (BMI>28)" : "Cardiac standard (BMI<28)",
        contrast: "Iomeron 400 (100ml)",
        saline: "100ml",
        testBolus: [
          { rate: "5/6 ml/s", volume: "15ml contrast" },
          { rate: "5/6 ml/s", volume: "40ml saline" },
          { rate: "", volume: "HOLD" }
        ],
        scan: [
          { rate: "5/6 ml/s", volume: isBig ? "80ml contrast" : "60ml contrast" },
          { rate: "5/6 ml/s", volume: "40ml saline" }
        ]
      };
    },
    dose: [
      { name: "Flash_CaSc", weight: "70kg", ctdi: "0.5 mGy", dlp: "8 mGycm" },
      { name: "Fl_CorCTA", weight: "70kg", ctdi: "1.7 mGy", dlp: "30 mGycm" },
      { name: "DS_CorAdSeq", weight: "70kg", ctdi: "7.6 mGy", dlp: "140 mGycm" },
      { name: "DS_SysAdSeq", weight: "70kg", ctdi: "7.6 mGy", dlp: "140 mGycm" }
    ],
    individualDRL: true,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay). Use this delay in dynamic evaluation.",
      "If patient >140kg and scan box is yellow: decrease scan length as much as possible.",
      "Increase gantry rotation time (0.28s to 0.33/0.5s) for large patients.",
      "Extra contrast required — check with reporting consultant.",
      "If motion artefact on FLASH and repeat needed: check coverage with consultant, consider padding or 70% phase. Reload 100ml contrast + 50ml saline. Delete test bolus and hold on injector. Add 3s to TB timing. Delete lung recons."
    ],
    reconstructions: [
      "Multiphase first (or thin recons if no multiphase) — heart only, small FOV. Select all possible phases.",
      "First recon box: same range as multiphase, best phase chosen (manual — best % or ms).",
      "All other recons: wide FOV covering entire lung fields, start to end of scan.",
      "Add stent recon if required — Bv49 kernel, cardiac window.",
      "Send topogram, control scan, test bolus, all recons + one ECG + patient protocol to APS and Impax.",
      "Export all raw data."
    ],
    postCare: "If Beta blockers or GTN administered: perform post-observation BP and SpO2, compare to baseline before removing cannula."
  },

  calcium_score: {
    title: "Calcium Score",
    systemName: "Turbo_Flash_Ca_Score_Sn",
    category: "Adult > Cardiac Region",
    indications: ["Rule out CAD"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "Apices to base of lungs",
    scanRange: "Carina to base of heart",
    dose: [{ name: "Flash_CaSc", weight: "70kg", ctdi: "0.5 mGy", dlp: "8 mGycm" }],
    individualDRL: true,
    deviations: ["If patient cannot understand English, use the 1+2 technique."],
    reconstructions: [
      "Send topogram and all recons + one ECG + patient protocol to APS and Impax.",
      "Export all raw data."
    ],
    simple: true
  },

  grafts: {
    title: "Grafts (CABG + Native Coronaries)",
    systemName: "Coronary_Angio",
    category: "Adult > Cardiac Region",
    indications: [
      "Visualise coronary artery bypass grafts and native coronary arteries",
      "Thoracic or congenital heart indications that also want coronary visualisation",
      "Pre-operative surgery planning"
    ],
    note: "Calcium score is NOT indicated in patients who have bypass grafts. DO NOT USE FLASH CORONARY ACQUISITION.",
    patientPosition: "Supine, Head first",
    patientPrep: "Perform baseline BP and SpO2. Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: {
      betaBlockers: "Yes — if HR >60 bpm and not contra-indicated",
      gtn: "Depending on Radiologist and if not contra-indicated",
      note: "Contra-indications on reverse of cardiac patient questionnaire"
    },
    topogram: "Apices to base of lungs",
    controlScan: "Right-click and add control scan, then cut out calcium score. Level of carina.",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    getAcquisition: function(hr) {
      if (hr === 'lt60' || hr === '60-65') {
        return {
          mode: "END DIASTOLIC — Adaptive Sequential (60%-80%)",
          range: "Apices to domes of diaphragm (base of heart)",
          delay: "Test bolus timing — no extra delay",
          trigger: "Set scan and range per HR look-up table (Appendix 1)",
          badge: '<span class="hr-badge mid">HR &lt;65 regular</span>'
        };
      } else {
        return {
          mode: "END SYSTOLIC — Adaptive Sequential (ms timing)",
          range: "Apices to domes of diaphragm (base of heart)",
          delay: "Test bolus timing — no extra delay",
          trigger: "Set scan and range per HR look-up table (Appendix 1)",
          badge: '<span class="hr-badge high">HR &gt;65 or irregular</span>'
        };
      }
    },
    injection: {
      protocolName: "Grafts",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "80ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" }
      ]
    },
    congenitalInjection: {
      note: "For congenital heart patients requiring long injection (both R+L heart + coro's):",
      protocolName: "Cardiac long injection",
      contrast: "Iomeron 400 (150ml)",
      saline: "100ml",
      scan: [
        { rate: "5/6 ml/s", volume: "80ml contrast" },
        { rate: "5/6 ml/s", volume: "50ml; 70% contrast / 30% saline" },
        { rate: "5/6 ml/s", volume: "40ml; 50% contrast / 50% saline" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg and scan box is yellow: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "Multiphase first (or thin recons if no multiphase) — heart only, small FOV.",
      "First recon: same range as multiphase, best phase (manual).",
      "All other recons: wide FOV, entire lung fields, start to end of scan.",
      "Add stent recon if required — B46 kernel, cardiac window.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ],
    postCare: "If Beta blockers or GTN administered: post-observation BP and SpO2 before removing cannula."
  },

  tavi_no_coros: {
    title: "Turbo Flash TAVI (No Coronaries)",
    systemName: "Turbo_Flash_TAVI",
    category: "Adult > Cardiac Region",
    indications: ["Severe AS being considered for TAVI", "Coronary angiogram performed within last 12 months"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "COW to lesser trochanter",
    calciumScore: "Carina to base of heart",
    testBolus: {
      level: "Level of L1",
      watch: "Descending aorta",
      dynamicEval: "Add 12s into delay box, ROI in descending aorta"
    },
    acquisition: {
      mode: "Turbo Flash",
      range: "COW to lesser trochanter",
      delay: "Test bolus timing + 8s",
      recons: "First recon (cardiac) over heart; all others from base of skull to lesser trochanter"
    },
    injection: {
      protocolName: "Flash_TAVI",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "3 ml/s", volume: "10ml contrast" },
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" }
      ]
    },
    dose: [{ name: "Fl_GatedBody", ctdi: "3.5 mGy", dlp: "270 mGycm" }],
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "First recon: heart only.",
      "Lung recon: lung fields only.",
      "All other recons: wide FOV, entire scan length.",
      "Send all recons + ECG + patient protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  tavi_plus_coros: {
    title: "TAVI Plus Coronaries",
    systemName: "TAVI_plus_Coros",
    category: "Adult > Cardiac Region",
    indications: ["Severe AS being considered for TAVI", "Rule out CAD — no cath in last 12 months"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "Base of skull to lesser trochanter",
    calciumScore: "Carina to base of heart",
    testBolus: {
      level: "Level of carina",
      watch: "Descending aorta",
      dynamicEval: "Add 10s into delay box, ROI in descending aorta"
    },
    acquisition: {
      mode: "END SYSTOLIC — Adaptive Sequential (ms timing)",
      ctca: "Carina to domes of diaphragm — use CaSc to help plan",
      ctcaDelay: "Test bolus + 3s delay. Set scan and range per HR look-up table.",
      bodyAngio: "Base of skull to lesser trochanter",
      bodyAngioDelay: "Minimum 6s delay between CTCA and body angio"
    },
    injection: {
      protocolName: "TAVI_Coros",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "10ml contrast" },
        { rate: "5/6 ml/s", volume: "30ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "30ml saline" },
        { rate: "5/6 ml/s", volume: "60ml mixed (50% contrast / 50% saline)" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "CTCA recons: heart only.",
      "Lung recon: lung fields only.",
      "All other recons: wide FOV, entire scan length.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  "4d_valve": {
    title: "4D Valve",
    systemName: "4D_Valve (for all BMIs)",
    category: "Adult > Cardiac Region",
    indications: ["Post TAVI assessment", "?Thrombus on leaflets", "?Failing TAVI valve"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: { betaBlockers: "No", gtn: "No" },
    topogram: "Apices to base of lungs (or apices to femoral heads)",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Adaptive Sequential 0%-100% (full cardiac cycle)",
      range: "THROUGH THE VALVE ONLY",
      delay: "Test bolus timing + 3s",
      notes: [
        "Only one adaptive sequential block",
        "Do not change % on trigger card",
        "All pink recon boxes cover same range — VALVE ONLY",
        "GET CONSULTANT TO CHECK SCAN RANGE"
      ]
    },
    injection: {
      protocolName: "Coronary Angio",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" }
      ]
    },
    individualDRL: false,
    deviations: ["If patient cannot understand English, use the 1+2 technique."],
    reconstructions: [
      "Multiphase reconstruction every 5% R-R interval.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  mitral_valve: {
    title: "Mitral Valve",
    getSystemName: function(bmi) {
      if (bmi === 'lt20') return "Mitral_Valve_small (BMI <20)";
      if (bmi === 'gt30') return "Mitral_Valve_large (BMI >30)";
      return "Mitral_Valve_average (BMI 20-30)";
    },
    category: "Adult > Cardiac Region",
    indications: ["Assess mitral valve suitability and motility prior to surgery"],
    note: "Check the Valve SOP for scan requirements.",
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: { betaBlockers: "No", gtn: "No" },
    topogram: "Apices to base of lungs (or apices to femoral heads)",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Adaptive Sequential 30%-90%",
      range: "Carina to domes of diaphragm (base of heart)",
      notes: [
        "Acquires both end systole and end diastole",
        "Do not change acquisition scan and range",
        "All pink recon boxes same range (carina to domes of diaphragm)"
      ],
      bodyAngio: "Delete Flash body angio/TAVI if not required. If needed: base of skull to lesser trochanter."
    },
    injection: {
      protocolName: "TAVI_Coros",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "10ml contrast" },
        { rate: "5/6 ml/s", volume: "30ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "30ml saline" },
        { rate: "5/6 ml/s", volume: "60ml mixed (50% contrast / 50% saline)" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "Multiphase first — heart only, small FOV. Select every other phase (10%, 20%, etc.).",
      "First recon: same range as multiphase, best phase (manual).",
      "All other recons: wide FOV, entire lung fields, start to end of scan.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  evoque: {
    title: "EVOQUE (Transcatheter Tricuspid Valve)",
    systemName: "EVOQUE_Average",
    category: "Adult > Cardiac Region",
    indications: ["Transcatheter tricuspid valve replacement"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: { betaBlockers: "No", gtn: "No" },
    topogram: "Apices to lesser trochanters",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Full Retrospective Spiral 0-100%",
      cardiac: "Carina to domes of diaphragm",
      cardiacNotes: [
        "Acquires throughout entire cardiac cycle",
        "Do not change the percentages",
        "Pink recon box: carina to base of heart"
      ],
      venogram: "Lung apices to lesser trochanters (include femoral veins)",
      venogramDelay: "90s post contrast — set delay after working out cardiac delay. LINK THE 2 SCANS."
    },
    injection: {
      protocolName: "EVOQUE Injection",
      contrast: "Iomeron 400 (150ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5 ml/s", volume: "15ml contrast" },
        { rate: "5 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5 ml/s", volume: "130ml (60% contrast / 40% saline)" },
        { rate: "5 ml/s", volume: "20ml saline" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique.",
      "If patient >140kg: decrease scan length.",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "Mediastinal wide FOV for Low Dose Thorax (ribs counting).",
      "Multiphase: every 10% from 0-100% for cardiac scan.",
      "Send all recons + ECG + patient protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  tendyne: {
    title: "Tendyne GFS (Research)",
    getSystemName: function(bmi) {
      return bmi === 'gt30' ? "GFS_large (BMI >30)" : "GFS_average (BMI <30)";
    },
    category: "Adult > Cardiac Region",
    indications: ["Assess mitral annulus and LV dimensions", "Rule out LVOT obstruction"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: { betaBlockers: "No", gtn: "No" },
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Full Retrospective Spiral 0-100%",
      range: "Carina to domes of diaphragm (base of heart)",
      notes: [
        "Acquires throughout entire cardiac cycle",
        "Do not change acquisition scan and range",
        "All pink recon boxes: carina to base of heart"
      ],
      lowDoseThorax: "40s after cardiac scan. Apices to bases (rib counting). PRE-PROCEDURE ONLY."
    },
    getInjection: function(bmi) {
      const isLarge = bmi === 'gt30';
      return {
        protocolName: isLarge ? "Cardiac coro large" : "Cardiac standard",
        contrast: "Iomeron 400 (100ml)",
        saline: "100ml",
        testBolus: [
          { rate: "5/6 ml/s", volume: "15ml contrast" },
          { rate: "5/6 ml/s", volume: "40ml saline" },
          { rate: "", volume: "HOLD" }
        ],
        scan: [
          { rate: "5/6 ml/s", volume: isLarge ? "80ml contrast" : "60ml contrast" },
          { rate: "5/6 ml/s", volume: "40ml saline" }
        ]
      };
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique.",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "Mediastinal wide FOV for Low Dose Thorax (rib counting).",
      "Multiphase: every 10% from 0-100% for cardiac scan.",
      "Send all recons + ECG + patient protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  gated_thoracic_aorta: {
    title: "Gated Thoracic Aorta",
    systemName: "Turbo_Flash_Gated_Thoracic_Aorta",
    category: "Adult > Cardiac Region",
    indications: [
      "Dilated ascending aorta",
      "Marfans syndrome",
      "Ascending aortic aneurysm",
      "Coarctation of the aorta",
      "Dissection of the ascending aorta",
      "PEARS (Exostent) protocol patients"
    ],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Descending aorta",
      dynamicEval: "Add 10s into delay box, ROI in descending aorta"
    },
    acquisition: {
      mode: "Turbo Flash — Gated",
      range: "Above arch to domes of diaphragm (base of heart)",
      delay: "Test bolus timing (no extra delay)",
      recons: "First recon (cardiac) over heart; all others from above arch to base of heart"
    },
    injection: {
      protocolName: "Thoracic Aorta",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" }
      ]
    },
    dose: [{ name: "Fl_Thoracic_Ao", ctdi: "3.5 mGy", dlp: "100 mGycm" }],
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast if needed.",
      "If referrer wants carotid/COW: scan from COW to base of heart. First recon over heart; lung recon lungs only; all others COW to base with wide FOV."
    ],
    reconstructions: [
      "First recon: above arch to base of heart, small FOV.",
      "All other recons: wide FOV, entire lung fields.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  aortic_pears: {
    title: "Aortic PEARS (ExoVasc)",
    systemName: "Flash_AORTIC_PEARS_CAREKV",
    category: "Adult > Cardiac Region",
    indications: [
      "Visualise aorta and aortic valve for Aortic PEARS procedure",
      "Marfan Syndrome, Loeys-Dietz, Bicuspid Aortic Valve, Idiopathic dilation",
      "Post-operative dilation (Arterial Switch, free-standing Root Ross)"
    ],
    patientPosition: "Supine, Head first",
    patientPrep: "Perform baseline BP and SpO2. Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: {
      betaBlockers: "Yes — if HR >60 bpm and not contra-indicated",
      gtn: "No",
      note: "Contra-indications on reverse of cardiac patient questionnaire"
    },
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Flash — Gated",
      range: "Above arch to domes of diaphragm (base of heart)",
      delay: "Test bolus timing + 8s",
      important: "AORTIC VALVE SHOULD BE IMAGED BETWEEN 60-80% R-R INTERVAL. CHECK WITH RADIOLOGIST WHILST PATIENT IS ON TABLE.",
      exstentNotes: [
        "Voxel resolution: 0.5mm or 0.6mm or 0.75mm isotropic",
        "Contiguous thin slices, thinnest possible with minimum overlap",
        "Smooth kernel [B26F] with cardiac/angio window (Siemens)",
        "Image from 20mm below lowest sinus (LVOT) to 20mm up brachiocephalic",
        "Single image block — no registration artefact",
        "DICOM files to Exstent via dedicated upload link"
      ]
    },
    injection: {
      protocolName: "GRAFT Study",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "80ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast if needed."
    ],
    reconstructions: [
      "First recon: above arch to base of heart, small FOV.",
      "All other recons: wide FOV, entire lung fields.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  ross_pears: {
    title: "Ross PEARS — Pulmonary Artery (ExoVasc)",
    systemName: "Flash_ROSS_PEARS_Pulmonary_Artery_CAREKV",
    category: "Adult > Cardiac Region",
    indications: [
      "Visualise pulmonary valve/artery and aortic root for Ross PEARS procedure",
      "ExoVasc support for pulmonary autograft in Ross-PEARS operation"
    ],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: {
      betaBlockers: "Yes — if HR >60 bpm and not contra-indicated",
      note: "Contra-indications on reverse of cardiac patient questionnaire"
    },
    topogram: "Apices to base of lungs",
    acquisition: {
      mode: "USE MILLISECOND TIMINGS AS PER CHART",
      range: "Above arch to domes of diaphragm (base of heart)",
      delay: "80 seconds delay",
      exstentNotes: [
        "Cardiac gating: 10%-40% R-R (preferably 10%-25%) — ventricular systole",
        "Voxel resolution: 0.5mm or 0.6mm or 0.75mm isotropic",
        "Smooth kernel [B26F] with cardiac/angio window",
        "Image from 20mm below lowest sinus (RVOT) to pulmonary branches",
        "Also include ascending aorta from LVOT to 20mm up brachiocephalic",
        "Include spine and sternum for pulmonary marker orientation",
        "DICOM files to Exstent via dedicated upload link"
      ]
    },
    injection: {
      protocolName: "Bastion Wheel",
      note: "See attached Bastion Wheel chart for injection parameters"
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique.",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s)."
    ],
    reconstructions: [
      "First recon: above arch to base of heart, small FOV.",
      "All other recons: wide FOV, entire lung fields.",
      "Send topogram and all recons + ECG + protocol to PACS.",
      "Export all raw data."
    ]
  },

  access_routes: {
    title: "Access Routes",
    systemName: "Turbo_Flash_Access_Routes",
    category: "Adult > Cardiac Region",
    indications: [
      "Pre-surgery planning of the aorta",
      "Measuring calibre and tortuosity of access vessels",
      "Post dissection repair",
      "SCAD (spontaneous coronary artery dissection)"
    ],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "Base of skull to lesser trochanter",
    controlScan: "Level of L1",
    testBolus: {
      level: "Level of L1",
      watch: "Descending aorta",
      dynamicEval: "Add 12s into delay box, ROI in descending aorta"
    },
    acquisition: {
      mode: "Turbo Flash",
      range: "Base of skull to lesser trochanter",
      delay: "Test bolus timing + 8s",
      recons: "First recon (cardiac) over heart; all others from base of skull to lesser trochanter"
    },
    injection: {
      protocolName: "Flash_TAVI",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "3 ml/s", volume: "10ml contrast" },
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" }
      ]
    },
    dose: [{ name: "Fl_GatedBody", ctdi: "3.5 mGy", dlp: "270 mGycm" }],
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant."
    ],
    reconstructions: [
      "First recon: heart only.",
      "Lung recons: lung fields only.",
      "All other recons: wide FOV, entire scan length.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  carto: {
    title: "CARTO (Gated Pulmonary Veins)",
    systemName: "Carto",
    category: "Adult > Cardiac Region",
    indications: [
      "Pre AF ablation",
      "Pre AT/VT ablation",
      "Pre/post Watchman or Lariat procedures",
      "?Thrombus in LAA"
    ],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: "API ON. EXPIRATION",
    hrControl: null,
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Gated — Adaptive Sequential",
      range: "1cm above carina to domes of diaphragm (base of heart)",
      delay: "Test bolus timing (no extra delay)",
      recons: "All scan (blue) and recon (pink) boxes cover the same range",
      delayed: "Delayed scan: 1cm above carina to mid-heart (approx 40mm), 60s after first scan. LAA only."
    },
    getAcquisitionArch: function(arch) {
      if (arch === 'yes') {
        return {
          range: "Above arch to domes of diaphragm (base of heart)",
          note: "DO NOT ADD 3s DELAY TO TB"
        };
      }
      return null;
    },
    injection: {
      protocolName: "Carto",
      contrast: "Iomeron 400 (100ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "50ml contrast" },
        { rate: "5/6 ml/s", volume: "50ml (50% contrast / 50% saline)" },
        { rate: "5/6 ml/s", volume: "25ml saline" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (usually 8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant.",
      "If referrer wants RA/RV as well as LA: use cardiac long injection."
    ],
    reconstructions: [
      "Heart recon: small FOV, include pulmonary veins. If arch scanned, start from above arch.",
      "All other recons: large FOV, entire lung fields.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data.",
      "Burn heart recon onto CD, place in blue box in SS scanner."
    ]
  },

  vivo: {
    title: "VIVO",
    systemName: "VIVO_average (BMI 20-30)",
    category: "Adult > Cardiac Region",
    indications: ["Pre-treatment scan for patients going for ablation", "Request must state VIVO protocol"],
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: "API ON. EXPIRATION",
    hrControl: { betaBlockers: "No", gtn: "No" },
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Descending aorta",
      dynamicEval: "Add 10s into delay box, ROI in descending aorta"
    },
    acquisition: {
      mode: "Gated",
      range: "Above soft tissue of shoulders to lung bases (include top of liver)",
      delay: "Test bolus timing",
      recons: "First recon (cardiac) over heart; all others from apices to base of lungs"
    },
    injection: {
      protocolName: "Cardiac long injection",
      contrast: "Iomeron 400 (150ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml (70% contrast / 30% saline)" },
        { rate: "5/6 ml/s", volume: "30ml (50% contrast / 50% saline)" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s)."
    ],
    reconstructions: [
      "First recon: above arch to base of heart, small FOV.",
      "All other recons: wide FOV, entire lung fields.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data.",
      "Burn heart recon onto CD, place in blue box in SS scanner."
    ]
  },

  inheart: {
    title: "INHEART",
    systemName: "INHEART",
    category: "Adult > Cardiac Region",
    indications: ["Pre-ablation planning"],
    patientPosition: "Supine, Head first",
    patientPrep: null,
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "Apices to base of lungs",
    acquisition: {
      arterial: {
        mode: "END DIASTOLIC — Adaptive Sequential",
        range: "Above aortic arch to domes of diaphragm (base of heart)",
        notes: "All scans at 60-80% R-R for maximum ventricular filling. 70s delay (Bastion Wheel)."
      },
      late: "CTCA at 8 minutes post contrast. HEART ONLY."
    },
    injection: {
      protocolName: "Bastion Wheel",
      contrast: "Iomeron 400 (150ml)",
      saline: "100ml",
      note: "Refer to Bastion Wheel Chart for injection parameters."
    },
    individualDRL: false,
    reconstructions: [
      "Multiphase first — heart only, small FOV. Select all possible phases.",
      "First recon: same range as multiphase, best phase (manual).",
      "All other recons: wide FOV, start to end of scan.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  gated_ctpa: {
    title: "Gated CTPA (No Coronaries)",
    systemName: "Gated_CTPA",
    category: "Adult > Cardiac Region",
    indications: [
      "Congenital heart patients requiring cardiovascular anatomy imaging",
      "Triple rule out — PE, aortic dissection, CAD"
    ],
    note: "If coronary visualisation also needed: use Graft study with long cardiac injection protocol.",
    patientPosition: "Supine, Head first",
    patientPrep: "Attach ECG monitoring and ensure good signal.",
    breathHold: 'API ON. Flash Cardiac ("Breath in, breath out and breath in and hold it")',
    hrControl: null,
    topogram: "Apices to base of lungs",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Ascending aorta",
      dynamicEval: "Add 10s into delay box, ROI in ascending aorta"
    },
    acquisition: {
      mode: "Gated — Turbo Flash",
      range: "Apices to domes of diaphragm (base of heart)",
      delay: "Test bolus timing + 8s",
      recons: "First recon (cardiac) over heart; all others from apices to base of heart"
    },
    injection: {
      protocolName: "Cardiac long injection",
      contrast: "Iomeron 400 (150ml)",
      saline: "100ml",
      testBolus: [
        { rate: "5/6 ml/s", volume: "15ml contrast" },
        { rate: "5/6 ml/s", volume: "40ml saline" },
        { rate: "", volume: "HOLD" }
      ],
      scan: [
        { rate: "5/6 ml/s", volume: "60ml contrast" },
        { rate: "4 ml/s", volume: "40ml (70% contrast / 30% saline)" },
        { rate: "5 ml/s", volume: "30ml (50% contrast / 50% saline)" }
      ]
    },
    individualDRL: false,
    deviations: [
      "If patient cannot understand English, use the 1+2 technique (8s delay).",
      "If patient >140kg: decrease scan length, increase gantry rotation (0.28→0.33/0.5s).",
      "Extra contrast — check with reporting consultant.",
      "If referrer wants COW: scan from COW to base of heart. Heart recon over heart; lung recon lungs only; all others COW to base with wide FOV."
    ],
    reconstructions: [
      "First recon: heart only.",
      "All other recons: wide FOV, entire lung fields.",
      "Send topogram, control scan, test bolus, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  // ============================================================
  // PAEDIATRIC CARDIAC CT (Guideline-based — requires local verification)
  // Based on: SCCT Paediatric Guidelines, BSCI Standards, Siemens Force protocols
  // ============================================================
  paediatric_cardiac: {
    title: "Paediatric Cardiac CT",
    systemName: "Paed_Cardiac",
    category: "Adult > Cardiac Region",
    requiresVerification: true,
    verificationNote: "Guideline-based protocol (SCCT/BSCI) — requires local clinical team verification before use.",
    indications: [
      "Congenital heart disease (CHD) — pre/post-operative assessment",
      "Kawasaki disease — coronary artery aneurysm follow-up",
      "Anomalous coronary artery origins in young patients",
      "Vascular rings and aortic arch anomalies",
      "Coarctation of the aorta (post-stent or when MRI not feasible)",
      "Complex intracardiac anatomy (Fontan, Tetralogy, TGA post-repair)",
      "Pulmonary artery anatomy / aortopulmonary collaterals"
    ],
    note: "Weight-based protocol. The SOMATOM Force dual-source high-pitch Flash mode enables sub-second acquisition, often eliminating need for sedation. PALS-certified personnel must be available. Ensure paediatric emergency equipment is immediately accessible.",
    patientPosition: "Supine, Head first (feet first if needed for access)",
    patientPrep: "Attach ECG monitoring (paediatric leads). Ensure appropriate IV access (22–24G). Size-appropriate pulse oximetry. Fasting per ASA guidelines if sedation planned.",
    breathHold: "Age-dependent — see below",
    hrControl: {
      betaBlockers: "Generally NOT used in young children. Consider in adolescents >40 kg with HR >80 bpm — consult paediatric cardiologist.",
      gtn: "Not routinely used in paediatric patients."
    },
    topogram: "Thoracic inlet to below diaphragm (adjust to anatomy of interest)",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina or descending aorta",
      watch: "Descending aorta (or ascending aorta for coronary studies)",
      dynamicEval: "Manual bolus tracking preferred in small children due to faster circulation time. Place ROI in descending aorta, threshold 100 HU."
    },
    getAcquisitionByWeight: function(weight) {
      if (weight === 'lt10') {
        return {
          label: "Neonate / Infant (<10 kg)",
          kv: "70 kV",
          mode: "High-Pitch Flash (Turbo Flash)",
          notes: "Free-breathing acquisition — no breath-hold required. Dual-source high-pitch mode (~250 ms acquisition). No sedation usually needed if Feed-and-Wrap technique used. Temporal resolution ~75 ms.",
          gating: "Prospective ECG-triggered. High-pitch mode captures in single heartbeat.",
          rotation: "0.25s",
          contrastVolume: "1.5–2 mL/kg",
          flowRate: "1–1.5 mL/s via 24G cannula",
          saline: "5–10 mL at same rate",
          drl: "CTDIvol ≈ 2.3 mGy | DLP ≈ 55 mGy·cm",
          sedation: "Feed-and-Wrap technique preferred. If needed: chloral hydrate or dexmedetomidine.",
          recon: "0.6 mm slice, Bv40 kernel, SAFIRE strength 3–4. Small FOV centred on heart."
        };
      } else if (weight === '10-20') {
        return {
          label: "Infant / Small Child (10–20 kg)",
          kv: "70–80 kV",
          mode: "High-Pitch Flash (Turbo Flash)",
          notes: "Free-breathing preferred. High-pitch Flash mode usually sufficient. Coached quiet breathing if cooperative.",
          gating: "Prospective ECG-triggered high-pitch.",
          rotation: "0.25s",
          contrastVolume: "1.5–2 mL/kg",
          flowRate: "1.5–2 mL/s via 22–24G cannula",
          saline: "10–15 mL at same rate",
          drl: "CTDIvol ≈ 3 mGy | DLP ≈ 70 mGy·cm",
          sedation: "Often not needed with high-pitch Flash. If needed: propofol infusion 5–10 mg/kg/h or ketamine 0.5–1 mg/kg.",
          recon: "0.6 mm slice, Bv40 kernel, SAFIRE strength 3. Small FOV centred on heart."
        };
      } else if (weight === '20-40') {
        return {
          label: "Child (20–40 kg)",
          kv: "80 kV (100 kV if coronary stenosis assessment needed)",
          mode: "High-Pitch Flash or Adaptive Sequential",
          notes: "Coached breath-hold if cooperative (5–10 second hold). Otherwise high-pitch Flash free-breathing.",
          gating: "Prospective ECG-triggered. Adaptive sequential if heart rate irregular.",
          rotation: "0.25s",
          contrastVolume: "1–1.5 mL/kg (max 60 mL)",
          flowRate: "2–3 mL/s via 22G cannula",
          saline: "20 mL at same rate",
          drl: "CTDIvol ≈ 4 mGy | DLP ≈ 100 mGy·cm",
          sedation: "Usually not required. Distraction/coaching techniques.",
          recon: "0.6 mm slice, Bv40 kernel, SAFIRE strength 2–3. Medium FOV."
        };
      } else {
        return {
          label: "Adolescent (>40 kg)",
          kv: "80–100 kV",
          mode: "Adaptive Sequential or High-Pitch Flash",
          notes: "Coached breath-hold (10–15 seconds). Approach similar to adult low-dose protocol.",
          gating: "Prospective ECG-triggered. Consider retrospective if functional assessment needed.",
          rotation: "0.25s",
          contrastVolume: "1 mL/kg (max 80 mL)",
          flowRate: "3–4 mL/s via 20–22G cannula",
          saline: "30 mL at same rate",
          drl: "CTDIvol ≈ 5 mGy | DLP ≈ 150 mGy·cm",
          sedation: "Not required.",
          recon: "0.6 mm slice, Bv40 kernel, SAFIRE strength 2. Standard cardiac FOV."
        };
      }
    },
    injection: {
      protocolName: "Paediatric Weight-Based",
      contrast: "Iomeron 350 or 400 — see weight-based parameters above",
      saline: "Weight-dependent — see above",
      note: "Use lowest concentration compatible with adequate enhancement. Warm contrast to body temperature. Power injector preferred but hand injection acceptable for <10 kg with very small access."
    },
    individualDRL: true,
    deviations: [
      "PALS-certified personnel MUST be present for all paediatric scans.",
      "Paediatric emergency equipment and medications must be immediately available.",
      "If sedation used: standard monitoring (ECG, SpO2, ETCO2, BP, temp) throughout and during recovery.",
      "For complex CHD: may need non-gated helical acquisition for full thoracic/vascular anatomy — use lowest possible kV.",
      "For Kawasaki follow-up: focus on coronary arteries — use coronary-optimised protocol with smallest FOV.",
      "For vascular rings: non-gated high-pitch Flash often sufficient — coronary detail not required.",
      "If IV access difficult: consider intraosseous access in emergencies only — discuss with paediatric team.",
      "For post-Fontan/Glenn: timing differs due to altered circulation — discuss with reporting consultant."
    ],
    reconstructions: [
      "Heart recon: smallest FOV covering anatomy of interest.",
      "For coronary assessment: thin-slice (0.6 mm) with sharp kernel.",
      "For CHD anatomy: wide FOV covering entire thorax and relevant vasculature.",
      "3D volume rendering for complex anatomy — send to 3D lab.",
      "Send topogram, control scan, all recons + ECG + protocol to APS and Impax.",
      "Export all raw data."
    ]
  },

  // ============================================================
  // ECMO CT (Guideline-based — requires local verification)
  // Based on: RadioGraphics VA-ECMO CTA, Alfred ECMO Guidelines, published literature
  // ============================================================
  ecmo_ct: {
    title: "ECMO CT",
    systemName: "ECMO_CT",
    category: "Adult > Cardiac Region",
    requiresVerification: true,
    verificationNote: "Guideline-based protocol (RadioGraphics/Alfred ICU) — requires local clinical team and perfusion verification before use.",
    indications: [
      "Cannula position verification",
      "Suspected intracranial haemorrhage (ICH occurs in ~3% of ECMO patients)",
      "Pulmonary assessment during ECMO support",
      "Cardiac recovery assessment / pre-decannulation imaging",
      "Suspected limb ischaemia / vascular complication",
      "Abdominal complications (mesenteric ischaemia, hepatic dysfunction)",
      "Oxygenator thrombus assessment (declining gas exchange)"
    ],
    note: "CRITICAL: Perfusionist MUST be present for all ECMO CT scans. Never inject contrast into the distal perfusion cannula. Air embolism risk — perfusionist manages all circuit connections. ECMO flow must not drop below 1.5 L/min if patient is not anticoagulated.",
    patientPosition: "Supine, Head first. Patient transported with full ECMO circuit and perfusionist.",
    patientPrep: "Continuous monitoring: ECG, invasive BP, SpO2, ETCO2. Perfusionist manages ECMO settings. Ensure adequate battery life on ECMO pump for transport. Confirm IV access SEPARATE from ECMO circuit for peripheral injection if needed.",
    breathHold: "Usually ventilated — pause ventilation briefly if possible for chest acquisition. Coordinate with ICU team.",
    hrControl: {
      betaBlockers: "NOT used — patients are critically ill on ECMO.",
      gtn: "NOT used."
    },
    topogram: "Head to pelvis (comprehensive assessment) or targeted to clinical question",
    controlScan: "Level of carina",
    testBolus: {
      level: "Level of carina",
      watch: "Main pulmonary artery (VV-ECMO) or ascending aorta (VA-ECMO)",
      dynamicEval: "Manual ROI-based triggering preferred — standard timing unreliable due to ECMO circuit altering haemodynamics. Place ROI and trigger manually when peak/plateau opacification seen."
    },
    getAcquisitionByECMOType: function(type) {
      if (type === 'va') {
        return {
          label: "VA-ECMO (Veno-Arterial)",
          mode: "Non-gated helical (ECG gating usually not feasible due to poor signal on ECMO)",
          kv: "120 kV (higher kV needed due to beam hardening from cannulae and suboptimal contrast mixing)",
          range: "Head to pelvis — comprehensive assessment. Can be limited if specific clinical question.",
          contrastRoute: "Peripheral IV preferred. Alternatively via ECMO circuit pre-oxygenator port ONLY (perfusionist manages).",
          flowStrategy: "LOW-FLOW TECHNIQUE: Reduce ECMO pump flow to 500 mL/min for 15–25 seconds during scan acquisition. This allows native cardiac output to opacify vessels. Manual trigger when ROI shows peak enhancement.",
          contrastVolume: "100–120 mL Iomeron 400",
          flowRate: "4–5 mL/s via peripheral 18–20G IV",
          saline: "50 mL at same rate",
          timing: "Manual ROI triggering — place ROI in main pulmonary artery. Standard timing UNRELIABLE due to retrograde/antegrade blood flow mixing.",
          artifacts: "Expect: mixing artifacts (contrast + non-contrasted blood), streak from cannulae, inhomogeneous opacification. Non-opacification can mimic thrombus — interpret with caution. Mixing artifacts can mimic dissection.",
          keyNotes: [
            "CRITICAL: Reduce ECMO flow to 500 mL/min during scan (prevents thrombus while allowing contrast opacification).",
            "Perfusionist MUST manage flow changes.",
            "Simultaneous antegrade (native) and retrograde (ECMO) perfusion creates complex haemodynamics.",
            "Consider multiphasic acquisition if clinical question requires arterial + venous phases.",
            "Post-decannulation: 10–15% risk of DVT/PE — consider CTPA."
          ]
        };
      } else {
        return {
          label: "VV-ECMO (Veno-Venous)",
          mode: "Non-gated helical (ECG gating may be feasible if good signal — discuss with team)",
          kv: "100–120 kV",
          range: "Chest ± abdomen (or head-to-pelvis if comprehensive assessment needed)",
          contrastRoute: "Administer via ECMO circuit return cannula (pre-oxygenator inlet) OR peripheral IV. Some recirculation expected via drainage cannula.",
          flowStrategy: "ECMO flow can usually be MAINTAINED during scan. If pulmonary artery opacification poor: increase contrast volume/rate OR temporarily reduce ECMO flow.",
          contrastVolume: "80–100 mL Iomeron 400",
          flowRate: "4–5 mL/s",
          saline: "50 mL at same rate",
          timing: "Bolus tracking with ROI in ascending aorta. More predictable timing than VA-ECMO as native cardiac output is primary driver.",
          artifacts: "Recirculation within ECMO circuit may create biphasic enhancement. Streak artifacts from cannulae. Simultaneous contrast drainage reduces pulmonary artery enhancement.",
          keyNotes: [
            "VV-ECMO: Native cardiac output drives contrast delivery — timing more predictable than VA-ECMO.",
            "If PA opacification needed: inject via circuit return cannula.",
            "If aortic opacification needed: peripheral IV preferred.",
            "Recirculation artifact: some contrast withdrawn by drainage cannula — increase volume if needed.",
            "Post-decannulation: assess for DVT at cannulation sites."
          ]
        };
      }
    },
    injection: {
      protocolName: "ECMO — see type-specific parameters above",
      contrast: "Iomeron 400 — volume depends on ECMO type (see above)",
      saline: "50 mL",
      note: "NEVER inject into distal perfusion cannula. Perfusionist manages all ECMO circuit connections. Air embolism prevention is paramount."
    },
    individualDRL: false,
    deviations: [
      "CRITICAL: Perfusionist MUST be present and manage all ECMO flow adjustments during scanning.",
      "Transport checklist: ECMO pump battery, emergency hand crank, monitoring, airway equipment, medications.",
      "For VA-ECMO: Reduce flow to 500 mL/min ONLY with perfusionist agreement and continuous monitoring.",
      "ECMO flow must NOT drop below 1.5 L/min if patient is not anticoagulated — thrombus risk.",
      "Non-contrast CT head: consider as first acquisition if ICH suspected — no contrast timing issues.",
      "Interpret with extreme caution: mixing artifacts mimic dissection, non-opacification mimics thrombus.",
      "If cardiac recovery assessment needed: echocardiography is primary modality — CT is supplementary.",
      "Paediatric ECMO: use weight-based contrast volumes and lower kV (70–80 kV) where possible."
    ],
    reconstructions: [
      "Head: standard non-contrast brain windows (if included).",
      "Chest: lung windows + mediastinal windows. Assess cannula position.",
      "Heart: if gated — multiphase for functional assessment. If non-gated — single-phase mediastinal.",
      "Abdomen: portal venous phase, standard abdominal windows.",
      "Wide FOV for all reconstructions to include ECMO cannulae in field.",
      "Send all recons + protocol to APS and Impax.",
      "Export all raw data."
    ]
  }
};

// ============================================================
// CLINICAL QUERY — KNOWLEDGE BASE
// ============================================================
// Abbreviation expansion dictionary (whole-word matching only)
const clinicalAbbreviations = {
  "cad": "coronary artery disease",
  "af": "atrial fibrillation",
  "as": "aortic stenosis",
  "ar": "aortic regurgitation",
  "mr": "mitral regurgitation",
  "ms": "mitral stenosis",
  "tr": "tricuspid regurgitation",
  "pe": "pulmonary embolism",
  "cabg": "coronary artery bypass graft",
  "pvi": "pulmonary vein isolation",
  "laa": "left atrial appendage",
  "lvot": "left ventricular outflow tract",
  "tavr": "tavi",
  "halt": "leaflet thickening",
  "vt": "ventricular tachycardia",
  "at": "atrial tachycardia",
  "svt": "supraventricular tachycardia",
  "ccta": "coronary ct angiography",
  "ctpa": "ct pulmonary angiography",
  "bav": "bicuspid aortic valve",
  "acs": "acute coronary syndrome",
  "nstemi": "non st elevation myocardial infarction",
  "scd": "sudden cardiac death",
  "hcm": "hypertrophic cardiomyopathy",
  "drl": "dose reference level",
  "ecmo": "ecmo",
  "chd": "congenital heart disease",
  "tof": "tetralogy of fallot",
  "tga": "transposition great arteries",
  "mapca": "aortopulmonary collaterals",
  "paeds": "paediatric"
};

// Protocol-to-clinical-term mapping (SCCT/BSCI evidence-based)
const clinicalQueryMap = {
  coronary_arteries: {
    category: "coronary",
    catClass: "cat-coronary",
    title: "Coronary Arteries",
    terms: [
      { phrase: "coronary artery disease", weight: 10, abbrevs: ["cad"] },
      { phrase: "rule out cad", weight: 10 },
      { phrase: "assess cad", weight: 10 },
      { phrase: "coronary ct angiography", weight: 10, abbrevs: ["ccta", "ctca"] },
      { phrase: "chest pain", weight: 7 },
      { phrase: "stable angina", weight: 8 },
      { phrase: "atypical chest pain", weight: 8 },
      { phrase: "intermediate risk chest pain", weight: 7 },
      { phrase: "pre-op coronary assessment", weight: 6, abbrevs: ["pre op coronary", "preop coronary", "preoperative coronary"] },
      { phrase: "anomalous coronary", weight: 7, abbrevs: ["coronary anomaly", "anomalous origin"] },
      { phrase: "kawasaki", weight: 7, abbrevs: ["kawasaki disease"] },
      { phrase: "pre-surgical coronary clearance", weight: 6 },
      { phrase: "coronary screening", weight: 6 },
      { phrase: "angina", weight: 7 },
      { phrase: "new onset chest pain", weight: 7 },
      { phrase: "exertional chest pain", weight: 7 },
      { phrase: "obstructive coronary", weight: 8 }
    ],
    guideline: "SCCT 2022 Appropriate Use | NICE CG95 | BSCI Standards 2014"
  },
  calcium_score: {
    category: "coronary",
    catClass: "cat-coronary",
    title: "Calcium Score",
    terms: [
      { phrase: "calcium score", weight: 10 },
      { phrase: "agatston", weight: 10, abbrevs: ["agatston score"] },
      { phrase: "coronary calcification", weight: 9 },
      { phrase: "cad risk stratification", weight: 8 },
      { phrase: "asymptomatic cad screening", weight: 7 },
      { phrase: "calcium scoring", weight: 10 },
      { phrase: "coronary artery calcium", weight: 9 },
      { phrase: "cac score", weight: 10 },
      { phrase: "non-contrast cardiac", weight: 5 }
    ],
    guideline: "SCCT 2022 | BSCI Calcium Scoring"
  },
  grafts: {
    category: "coronary",
    catClass: "cat-coronary",
    title: "Grafts (CABG)",
    terms: [
      { phrase: "cabg assessment", weight: 10, abbrevs: ["cabg"] },
      { phrase: "bypass graft", weight: 10, abbrevs: ["graft patency", "bypass grafts"] },
      { phrase: "post cabg", weight: 9, abbrevs: ["post bypass"] },
      { phrase: "graft occlusion", weight: 8 },
      { phrase: "native coronaries post surgery", weight: 7 },
      { phrase: "congenital with coronaries", weight: 6 },
      { phrase: "coronary bypass", weight: 9 },
      { phrase: "lima graft", weight: 8 },
      { phrase: "svg graft", weight: 8, abbrevs: ["saphenous vein graft"] }
    ],
    guideline: "SCCT 2022 Appropriate Use"
  },
  tavi_no_coros: {
    category: "valve",
    catClass: "cat-valve",
    title: "TAVI (No Coronaries)",
    terms: [
      { phrase: "tavi planning", weight: 9 },
      { phrase: "tavi no coronaries", weight: 10 },
      { phrase: "tavi with recent cath", weight: 10 },
      { phrase: "tavr planning", weight: 9 },
      { phrase: "severe aortic stenosis", weight: 7 },
      { phrase: "aortic valve replacement", weight: 6 },
      { phrase: "tavi sizing", weight: 9 },
      { phrase: "annulus sizing", weight: 6 },
      { phrase: "tavi", weight: 8 },
      { phrase: "tavr", weight: 8 }
    ],
    guideline: "SCCT/BSCI TAVI Planning Guidelines"
  },
  tavi_plus_coros: {
    category: "valve",
    catClass: "cat-valve",
    title: "TAVI + Coronaries",
    terms: [
      { phrase: "tavi with coronaries", weight: 10 },
      { phrase: "tavi no recent cath", weight: 10 },
      { phrase: "tavi plus coronaries", weight: 10 },
      { phrase: "tavr with coronaries", weight: 10 },
      { phrase: "severe aortic stenosis no cath", weight: 9 },
      { phrase: "tavi and cad", weight: 9 },
      { phrase: "tavi", weight: 7 },
      { phrase: "tavr", weight: 7 },
      { phrase: "tavi coronary assessment", weight: 10 }
    ],
    guideline: "SCCT/BSCI TAVI Planning Guidelines"
  },
  "4d_valve": {
    category: "valve",
    catClass: "cat-valve",
    title: "4D Valve",
    terms: [
      { phrase: "post tavi assessment", weight: 10 },
      { phrase: "tavi thrombus", weight: 10 },
      { phrase: "prosthetic valve dysfunction", weight: 9 },
      { phrase: "halt", weight: 9, abbrevs: ["hypoattenuated leaflet thickening", "leaflet thickening"] },
      { phrase: "failing tavi", weight: 10 },
      { phrase: "valve thrombosis", weight: 9 },
      { phrase: "post tavi", weight: 8 },
      { phrase: "4d valve", weight: 10 },
      { phrase: "prosthetic valve", weight: 7 },
      { phrase: "bioprosthetic valve", weight: 7 },
      { phrase: "reduced leaflet motion", weight: 8 }
    ],
    guideline: "SCCT 2025 Prosthetic Valve Consensus"
  },
  mitral_valve: {
    category: "valve",
    catClass: "cat-valve",
    title: "Mitral Valve",
    terms: [
      { phrase: "mitral valve assessment", weight: 10 },
      { phrase: "mitral regurgitation", weight: 9, abbrevs: ["mr assessment"] },
      { phrase: "mitral stenosis", weight: 9 },
      { phrase: "mitral repair", weight: 9 },
      { phrase: "mitral replacement", weight: 9 },
      { phrase: "pre-surgery mitral", weight: 8 },
      { phrase: "mitral valve disease", weight: 9 },
      { phrase: "mitral annulus", weight: 7 },
      { phrase: "mitral", weight: 6 },
      { phrase: "mitral prolapse", weight: 8 }
    ],
    guideline: "SCCT Structural Heart Disease Guidelines"
  },
  evoque: {
    category: "valve",
    catClass: "cat-valve",
    title: "EVOQUE (Tricuspid Valve)",
    terms: [
      { phrase: "evoque", weight: 10 },
      { phrase: "tricuspid valve", weight: 9 },
      { phrase: "transcatheter tricuspid", weight: 10 },
      { phrase: "tricuspid regurgitation", weight: 8, abbrevs: ["severe tr"] },
      { phrase: "tricuspid replacement", weight: 10 },
      { phrase: "tricuspid intervention", weight: 9 },
      { phrase: "tricuspid repair", weight: 8 },
      { phrase: "tr intervention", weight: 9 }
    ],
    guideline: "SCCT Structural Heart Disease Guidelines"
  },
  tendyne: {
    category: "valve",
    catClass: "cat-valve",
    title: "Tendyne GFS (Research)",
    terms: [
      { phrase: "tendyne", weight: 10 },
      { phrase: "tendyne gfs", weight: 10 },
      { phrase: "mitral annulus dimensions", weight: 8 },
      { phrase: "lvot obstruction", weight: 7 },
      { phrase: "left ventricular outflow tract", weight: 6 },
      { phrase: "gfs research", weight: 8 }
    ],
    guideline: "SCCT Structural Heart | Research Protocol"
  },
  gated_thoracic_aorta: {
    category: "aortic",
    catClass: "cat-aortic",
    title: "Gated Thoracic Aorta",
    terms: [
      { phrase: "aortic aneurysm", weight: 10 },
      { phrase: "aortic dissection", weight: 10 },
      { phrase: "dilated aorta", weight: 9 },
      { phrase: "marfan", weight: 9, abbrevs: ["marfans", "marfan syndrome"] },
      { phrase: "aortic coarctation", weight: 9, abbrevs: ["coarctation"] },
      { phrase: "thoracic aorta", weight: 9 },
      { phrase: "aortic disease", weight: 8 },
      { phrase: "aortic root dilation", weight: 8 },
      { phrase: "ascending aorta", weight: 7 },
      { phrase: "aortic size", weight: 7 },
      { phrase: "aortic surveillance", weight: 8 },
      { phrase: "aortic root", weight: 6 },
      { phrase: "ehlers danlos", weight: 7 },
      { phrase: "loeys dietz", weight: 7 },
      { phrase: "bicuspid aortic valve aorta", weight: 7 }
    ],
    guideline: "ACC/AHA 2022 Aortic Disease | BSCI Standards"
  },
  aortic_pears: {
    category: "aortic",
    catClass: "cat-aortic",
    title: "Aortic PEARS (ExoVasc)",
    terms: [
      { phrase: "aortic pears", weight: 10 },
      { phrase: "exovasc", weight: 10 },
      { phrase: "external aortic root support", weight: 10 },
      { phrase: "personalised external aortic root", weight: 10 },
      { phrase: "pears", weight: 8 },
      { phrase: "aortic root support", weight: 8 }
    ],
    guideline: "BSCI | ExoVasc Protocol"
  },
  ross_pears: {
    category: "aortic",
    catClass: "cat-aortic",
    title: "Ross PEARS (ExoVasc)",
    terms: [
      { phrase: "ross pears", weight: 10 },
      { phrase: "ross procedure support", weight: 10 },
      { phrase: "pulmonary autograft support", weight: 10 },
      { phrase: "ross exovasc", weight: 10 },
      { phrase: "ross procedure", weight: 8 },
      { phrase: "pulmonary autograft", weight: 7 }
    ],
    guideline: "BSCI | ExoVasc Protocol"
  },
  access_routes: {
    category: "aortic",
    catClass: "cat-aortic",
    title: "Access Routes",
    terms: [
      { phrase: "access routes", weight: 10 },
      { phrase: "vascular access", weight: 9 },
      { phrase: "vessel calibre", weight: 9, abbrevs: ["vessel caliber"] },
      { phrase: "vessel tortuosity", weight: 9 },
      { phrase: "iliac assessment", weight: 8 },
      { phrase: "femoral access", weight: 8 },
      { phrase: "pre-surgery access", weight: 8, abbrevs: ["pre surgery access"] },
      { phrase: "access planning", weight: 8 },
      { phrase: "peripheral vasculature", weight: 6 },
      { phrase: "iliac arteries", weight: 7 }
    ],
    guideline: "SCCT TAVI Planning | Vascular Access"
  },
  carto: {
    category: "ep",
    catClass: "cat-ep",
    title: "CARTO (Gated PV)",
    terms: [
      { phrase: "af ablation", weight: 10, abbrevs: ["atrial fibrillation ablation"] },
      { phrase: "pulmonary vein isolation", weight: 10, abbrevs: ["pvi"] },
      { phrase: "pre-ablation", weight: 8, abbrevs: ["pre ablation", "preablation"] },
      { phrase: "left atrial appendage", weight: 8, abbrevs: ["laa"] },
      { phrase: "watchman", weight: 8 },
      { phrase: "carto", weight: 10 },
      { phrase: "carto mapping", weight: 10 },
      { phrase: "pulmonary vein anatomy", weight: 8 },
      { phrase: "at ablation", weight: 8, abbrevs: ["atrial tachycardia ablation"] },
      { phrase: "vt ablation", weight: 7, abbrevs: ["ventricular tachycardia ablation"] },
      { phrase: "atrial fibrillation", weight: 7 },
      { phrase: "ablation planning", weight: 7 },
      { phrase: "pulmonary vein", weight: 6 }
    ],
    guideline: "SCCT EP Guidelines | BSCI AF Ablation"
  },
  vivo: {
    category: "ep",
    catClass: "cat-ep",
    title: "VIVO",
    terms: [
      { phrase: "vivo", weight: 10 },
      { phrase: "vivo ablation", weight: 10 },
      { phrase: "pre-ablation vivo", weight: 10 },
      { phrase: "ablation treatment planning", weight: 7 },
      { phrase: "pre-ablation scan", weight: 6 }
    ],
    guideline: "SCCT EP Guidelines"
  },
  inheart: {
    category: "ep",
    catClass: "cat-ep",
    title: "INHEART",
    terms: [
      { phrase: "inheart", weight: 10 },
      { phrase: "late enhancement ablation", weight: 9 },
      { phrase: "scar mapping", weight: 8 },
      { phrase: "ablation late enhancement", weight: 9 },
      { phrase: "pre-ablation with late enhancement", weight: 10 },
      { phrase: "myocardial scar", weight: 6 },
      { phrase: "late enhanced", weight: 7 }
    ],
    guideline: "SCCT EP Guidelines | Late Enhancement"
  },
  gated_ctpa: {
    category: "other",
    catClass: "cat-other",
    title: "Gated CTPA (No Coro's)",
    terms: [
      { phrase: "congenital heart", weight: 9, abbrevs: ["congenital heart disease", "chd"] },
      { phrase: "triple rule out", weight: 10 },
      { phrase: "pulmonary embolism", weight: 7, abbrevs: ["pe"] },
      { phrase: "gated ctpa", weight: 10 },
      { phrase: "ct pulmonary angiography", weight: 8 },
      { phrase: "rule out pe", weight: 7 },
      { phrase: "right ventricular assessment", weight: 6, abbrevs: ["rv assessment"] },
      { phrase: "congenital anatomy", weight: 8 }
    ],
    guideline: "SCCT 2022 | BSCI CTPA Guidelines"
  },
  paediatric_cardiac: {
    category: "paediatric",
    catClass: "cat-paediatric",
    title: "Paediatric Cardiac CT",
    terms: [
      { phrase: "paediatric cardiac", weight: 10, abbrevs: ["pediatric cardiac", "paeds cardiac"] },
      { phrase: "congenital heart disease", weight: 9, abbrevs: ["chd", "congenital"] },
      { phrase: "kawasaki", weight: 10, abbrevs: ["kawasaki disease", "kawasaki follow up"] },
      { phrase: "paediatric coronary", weight: 9, abbrevs: ["pediatric coronary"] },
      { phrase: "vascular ring", weight: 9, abbrevs: ["vascular rings", "double aortic arch"] },
      { phrase: "paediatric coarctation", weight: 8, abbrevs: ["coarctation child", "paeds coarct"] },
      { phrase: "fontan", weight: 8, abbrevs: ["fontan circuit", "post fontan"] },
      { phrase: "tetralogy", weight: 8, abbrevs: ["tetralogy of fallot", "tof"] },
      { phrase: "transposition", weight: 8, abbrevs: ["tga", "transposition great arteries"] },
      { phrase: "paediatric", weight: 6, abbrevs: ["pediatric", "paeds", "child", "infant", "neonate", "neonatal"] },
      { phrase: "anomalous coronary child", weight: 8 },
      { phrase: "aortopulmonary collaterals", weight: 7, abbrevs: ["mapca", "mapcas"] },
      { phrase: "pulmonary atresia", weight: 7 },
      { phrase: "truncus arteriosus", weight: 7 },
      { phrase: "ebstein", weight: 7 }
    ],
    guideline: "SCCT Paediatric CT | BSCI Standards | Image Gently"
  },
  ecmo_ct: {
    category: "specialist",
    catClass: "cat-specialist",
    title: "ECMO CT",
    terms: [
      { phrase: "ecmo", weight: 10 },
      { phrase: "ecmo ct", weight: 10 },
      { phrase: "va ecmo", weight: 10, abbrevs: ["veno arterial ecmo", "va-ecmo"] },
      { phrase: "vv ecmo", weight: 10, abbrevs: ["veno venous ecmo", "vv-ecmo"] },
      { phrase: "cannula position", weight: 9 },
      { phrase: "pre-decannulation", weight: 9, abbrevs: ["pre decannulation", "decannulation"] },
      { phrase: "cardiac recovery ecmo", weight: 9 },
      { phrase: "ecmo complication", weight: 8, abbrevs: ["ecmo complications"] },
      { phrase: "oxygenator thrombus", weight: 8 },
      { phrase: "extracorporeal membrane oxygenation", weight: 9 },
      { phrase: "ecmo imaging", weight: 8 },
      { phrase: "limb ischaemia ecmo", weight: 7 }
    ],
    guideline: "RadioGraphics VA-ECMO CTA | Alfred ECMO Guidelines"
  }
};

// ============================================================
// CLINICAL QUERY — MATCHING ENGINE
// ============================================================

// Levenshtein distance for typo tolerance
function levenshteinDistance(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = a[i-1] === b[j-1]
        ? dp[i-1][j-1]
        : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
    }
  }
  return dp[m][n];
}

// Preprocess query: lowercase, strip punctuation, expand abbreviations
function preprocessQuery(raw) {
  const lower = raw.toLowerCase().replace(/[^a-z0-9\s\-]/g, '').trim();
  const tokens = lower.split(/\s+/);
  const expanded = tokens.map(t => clinicalAbbreviations[t] || t);
  return {
    original: lower,
    expanded: expanded.join(' '),
    tokens: tokens,
    expandedTokens: expanded.join(' ').split(/\s+/)
  };
}

// Score a single protocol against the query
function scoreProtocol(query, entry) {
  let totalScore = 0;
  const matchedTerms = [];

  for (const term of entry.terms) {
    const allPhrases = [term.phrase, ...(term.abbrevs || [])];
    let bestScore = 0;
    let bestPhrase = '';

    for (const phrase of allPhrases) {
      let score = 0;
      const phraseLower = phrase.toLowerCase();

      // 1. Exact phrase match in expanded or original query
      if (query.expanded.includes(phraseLower) || query.original.includes(phraseLower)) {
        score = term.weight * 3;
      }
      // 2. All words of phrase present in query
      else {
        const phraseWords = phraseLower.split(/[\s\-]+/);
        const queryWordSet = new Set([...query.expandedTokens, ...query.tokens]);

        const matchCount = phraseWords.filter(pw => {
          for (const qw of queryWordSet) {
            if (qw === pw) return true;
            // Allow prefix match only if lengths differ by ≤2 (e.g. "coronary"/"coronaries" but not "assess"/"assessment")
            if (pw.length > 3 && qw.length > 3 && Math.abs(pw.length - qw.length) <= 2) {
              if (qw.startsWith(pw) || pw.startsWith(qw)) return true;
            }
          }
          return false;
        }).length;

        if (matchCount === phraseWords.length && phraseWords.length > 1) {
          score = term.weight * 2;
        } else if (matchCount > 0) {
          score = term.weight * (matchCount / phraseWords.length);
        }

        // 3. Levenshtein for typo tolerance (words > 4 chars, proportional threshold)
        if (score === 0) {
          for (const qw of query.expandedTokens) {
            if (qw.length <= 4) continue;
            for (const pw of phraseWords) {
              if (pw.length <= 4) continue;
              const maxDist = Math.max(1, Math.floor(Math.min(qw.length, pw.length) * 0.2));
              if (levenshteinDistance(qw, pw) <= maxDist) {
                score = Math.max(score, term.weight * 0.5);
              }
            }
          }
        }
      }

      if (score > bestScore) {
        bestScore = score;
        bestPhrase = phrase;
      }
    }

    if (bestScore > 0) {
      totalScore += bestScore;
      matchedTerms.push(bestPhrase);
    }
  }

  return { totalScore, matchedTerms };
}

// Run the full clinical query and render results
function runClinicalQuery(inputValue) {
  const trimmed = inputValue.trim();
  const resultsEl = document.getElementById('queryResults');
  const clearBtn = document.getElementById('queryClearBtn');

  // Show/hide clear button
  clearBtn.classList.toggle('visible', trimmed.length > 0);

  if (trimmed.length < 2) {
    resultsEl.classList.remove('visible');
    resultsEl.innerHTML = '';
    return;
  }

  const query = preprocessQuery(trimmed);
  const scores = [];

  for (const [key, entry] of Object.entries(clinicalQueryMap)) {
    const result = scoreProtocol(query, entry);
    if (result.totalScore > 0) {
      scores.push({
        protocolKey: key,
        title: entry.title,
        category: entry.category,
        catClass: entry.catClass,
        guideline: entry.guideline,
        score: result.totalScore,
        matchedTerms: result.matchedTerms
      });
    }
  }

  // Sort by score descending, take top 5
  scores.sort((a, b) => b.score - a.score);
  const topResults = scores.slice(0, 5);

  renderQueryResults(topResults);
}

// Render the query results
function renderQueryResults(results) {
  const resultsEl = document.getElementById('queryResults');

  if (results.length === 0) {
    resultsEl.innerHTML = '<div class="query-no-results">No matching protocol found. Try different terms or browse below.</div>';
    resultsEl.classList.add('visible');
    return;
  }

  const maxScore = results[0].score;

  let html = '<div class="query-results-label">Recommended Protocols</div>';

  for (const r of results) {
    // Confidence level
    let confClass, confLabel;
    if (r.score >= 20) {
      confClass = 'best'; confLabel = 'Best match';
    } else if (r.score >= 10) {
      confClass = 'good'; confLabel = 'Good match';
    } else {
      confClass = 'possible'; confLabel = 'Possible match';
    }

    // Category label
    const catLabels = { coronary: 'Coronary', valve: 'Valve', aortic: 'Aortic', ep: 'EP', other: 'Other', paediatric: 'Paediatric', specialist: 'Specialist' };
    const catLabel = catLabels[r.category] || 'Other';

    // Matched terms (show up to 3)
    const termsHtml = r.matchedTerms.slice(0, 3).map(t => `<mark>${escapeHtml(t)}</mark>`).join(', ');

    html += `
      <div class="query-result-card ${r.catClass}" onclick="selectQueryResult('${r.protocolKey}')">
        <div class="query-result-header">
          <span class="ind-category">${catLabel}</span>
          <span class="query-confidence ${confClass}">${confLabel}</span>
        </div>
        <div class="query-result-title">${escapeHtml(r.title)}</div>
        <div class="query-matched-terms">Matched: ${termsHtml}</div>
        <div class="query-guideline">${escapeHtml(r.guideline)}</div>
      </div>`;
  }

  resultsEl.innerHTML = html;
  resultsEl.classList.add('visible');
}

// HTML escape helper
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Select a result and feed into existing protocol flow
function selectQueryResult(protocolKey) {
  const btn = document.querySelector(`.indication-btn[data-protocol="${protocolKey}"]`);
  if (btn) {
    selectIndication(btn);
    // Clear search UI
    document.getElementById('clinicalQueryInput').value = '';
    document.getElementById('queryClearBtn').classList.remove('visible');
    document.getElementById('queryResults').classList.remove('visible');
    document.getElementById('queryResults').innerHTML = '';
    // selectIndication already navigates to detail view
  }
}

// Clear the query
function clearQuery() {
  document.getElementById('clinicalQueryInput').value = '';
  document.getElementById('queryClearBtn').classList.remove('visible');
  document.getElementById('queryResults').classList.remove('visible');
  document.getElementById('queryResults').innerHTML = '';
  document.getElementById('clinicalQueryInput').focus();
}

// Debounced input handler
let queryTimeout = null;
function onQueryInput(value) {
  clearTimeout(queryTimeout);
  queryTimeout = setTimeout(() => runClinicalQuery(value), 250);
}

// ============================================================
// TEACHING CONTENT
// ============================================================
const teachingContent = {

  coronary_arteries: {
    clinicalPurpose: {
      summary: "Non-invasive assessment of coronary artery anatomy to identify or exclude obstructive coronary artery disease (CAD).",
      clinicalQuestion: "Does this patient have significant coronary artery stenosis that explains their symptoms or risk profile?",
      whyDone: [
        "Identify or exclude obstructive CAD in patients with chest pain of suspected cardiac origin",
        "Assess anomalous coronary artery origins that may cause myocardial ischaemia or sudden cardiac death",
        "Plan revascularisation procedures by mapping coronary anatomy pre-operatively",
        "Follow up Kawasaki disease patients for coronary artery aneurysms"
      ],
      patientScenarios: [
        "55-year-old with atypical chest pain and intermediate pre-test probability of CAD",
        "Young athlete with exertional syncope — query anomalous coronary origin",
        "Pre-operative cardiac risk assessment before major non-cardiac surgery"
      ]
    },
    anatomy: {
      structures: ["Left main stem (LMS)", "Left anterior descending (LAD) and diagonal branches", "Left circumflex (LCx) and obtuse marginal branches", "Right coronary artery (RCA) and posterior descending artery (PDA)", "Coronary sinus and great cardiac vein"],
      pathology: ["Atherosclerotic plaque (calcified, mixed, and non-calcified)", "Coronary stenosis (>50% significant, >70% severe)", "Anomalous coronary origins (e.g. RCA from left sinus, interarterial course)", "Coronary artery aneurysms (Kawasaki disease)", "Myocardial bridging"]
    },
    keyLearningPoints: [
      "Heart rate control is critical for coronary CT — motion artefact increases dramatically above 65 bpm",
      "Flash mode (HR <60 bpm) provides lowest radiation dose; adaptive sequential is used for higher rates",
      "End-systolic imaging (>65 bpm) captures the heart when coronary motion is minimal",
      "Calcium scoring is only performed if protocolled by the radiologist — adds dose without always adding diagnostic value",
      "GTN dilates coronary arteries from ~3mm to ~4mm, improving visualisation of stenoses",
      "Test bolus determines individual peak enhancement timing — critical for precise scan window"
    ],
    decisionGuide: {
      useWhen: ["Chest pain with intermediate pre-test probability of CAD", "Native (non-operated) coronary arteries need assessment", "Anomalous coronary origin suspected"],
      doNotUseWhen: ["Patient has bypass grafts — use Grafts (CABG) protocol instead", "Only calcium score requested — use Calcium Score protocol", "TAVI planning needed — use TAVI protocols"],
      alternatives: [
        { protocol: "calcium_score", reason: "Non-contrast risk stratification only" },
        { protocol: "grafts", reason: "Patient has had CABG surgery" },
        { protocol: "tavi_plus_coros", reason: "Coronary assessment needed alongside TAVI planning" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Flash mode at <60 bpm captures the entire heart in under 0.5 seconds during a single diastolic pause, minimising motion artefact and radiation dose. Above 60 bpm the diastolic pause shortens, requiring adaptive sequential acquisition over multiple heartbeats. Above 65 bpm or with irregular rhythm, end-systolic imaging provides the most motion-free window.",
      contrastProtocol: "Test bolus determines individual circulation time. The +5s delay for Flash accounts for table acceleration time. BMI >28 requires 80ml contrast (vs 60ml) to maintain adequate coronary opacification through a larger blood volume.",
      breathHold: "The Flash cardiac breath-hold command standardises lung volume and minimises diaphragmatic motion. API (Automatic Patient Instruction) ensures consistent timing across patients."
    },
    guidelines: {
      references: [
        { name: "SCCT 2022 Appropriate Use Criteria", relevance: "Defines which patients benefit most from coronary CTA" },
        { name: "NICE CG95", relevance: "Recommends CTCA as first-line investigation for stable chest pain" },
        { name: "BSCI Standards 2014", relevance: "UK national standards for cardiac CT practice and quality" }
      ],
      evidenceSummary: "NICE CG95 recommends CTCA as the first-line investigation for patients with stable chest pain and suspected CAD. The SCCT 2022 criteria support its use in low-to-intermediate risk patients. High negative predictive value (>99%) makes it excellent for ruling out significant CAD."
    }
  },

  calcium_score: {
    clinicalPurpose: {
      summary: "Non-contrast CT to quantify coronary artery calcium as a marker of atherosclerotic burden and cardiovascular risk.",
      clinicalQuestion: "What is this patient's coronary artery calcium burden and what does it tell us about their cardiovascular risk?",
      whyDone: [
        "Quantify coronary calcium (Agatston score) to stratify cardiovascular risk in asymptomatic patients",
        "Guide statin therapy decisions in intermediate-risk patients",
        "Provide baseline for monitoring atherosclerotic disease progression",
        "Screen for CAD before contrast-enhanced CTCA (if protocolled)"
      ],
      patientScenarios: [
        "Asymptomatic 50-year-old with family history of premature CAD and borderline lipid profile",
        "Patient with diabetes being assessed for cardiovascular risk stratification",
        "Pre-CTCA screening to assess calcium burden and guide reporting"
      ]
    },
    anatomy: {
      structures: ["Coronary artery tree (LMS, LAD, LCx, RCA)", "Aortic valve (incidental calcification)", "Mitral annular calcification (incidental)"],
      pathology: ["Coronary artery calcification (marker of atherosclerosis)", "Agatston score categories: 0 (no plaque), 1-100 (mild), 101-400 (moderate), >400 (severe)", "Distribution pattern — diffuse vs focal calcification"]
    },
    keyLearningPoints: [
      "No contrast agent is used — this is a non-contrast, ECG-gated scan",
      "Agatston score of 0 has >95% negative predictive value for obstructive CAD in asymptomatic patients",
      "Calcium scoring does NOT detect non-calcified (soft) plaque — a score of 0 does not exclude all coronary disease",
      "Scan is acquired at the level of carina to base of heart using Flash mode (lowest dose possible)",
      "Only performed when specifically protocolled by the radiologist — not routine for all cardiac CTs",
      "Radiation dose is very low (~1 mSv) making it suitable for screening"
    ],
    decisionGuide: {
      useWhen: ["Asymptomatic cardiovascular risk stratification is needed", "Radiologist has specifically protocolled calcium scoring", "Baseline calcium burden assessment before statin therapy"],
      doNotUseWhen: ["Symptomatic chest pain — go straight to Coronary Arteries CTCA", "Patient already has known CAD or prior CABG", "Standalone CT calcium score is not routinely added to contrast CTCA without radiologist request"],
      alternatives: [
        { protocol: "coronary_arteries", reason: "If contrast-enhanced coronary assessment is needed" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Flash mode provides the lowest possible radiation dose (~0.5 mGy CTDIvol). Since no contrast timing is needed, acquisition is straightforward — triggered by ECG, acquired in a single heartbeat.",
      contrastProtocol: "No contrast is used. This is a non-contrast scan — calcium is inherently hyperdense (>130 HU) and detectable without contrast enhancement."
    },
    guidelines: {
      references: [
        { name: "SCCT 2022 Calcium Scoring Guidelines", relevance: "Standardised methodology for calcium quantification" },
        { name: "BSCI Calcium Scoring Standards", relevance: "UK practice standards for calcium score acquisition and reporting" },
        { name: "ACC/AHA 2019 Primary Prevention", relevance: "Supports calcium scoring in intermediate-risk adults for shared decision-making" }
      ],
      evidenceSummary: "Coronary artery calcium scoring is a powerful risk stratification tool. The ACC/AHA 2019 guidelines support its use in adults aged 40-75 at intermediate risk to guide preventive therapy decisions. A score of 0 reclassifies many patients to lower risk."
    }
  },

  grafts: {
    clinicalPurpose: {
      summary: "Comprehensive assessment of bypass grafts and native coronary arteries in post-CABG patients.",
      clinicalQuestion: "Are the bypass grafts patent and are there new stenoses in the native coronary arteries?",
      whyDone: [
        "Assess bypass graft patency (open vs occluded) in post-CABG patients with recurrent symptoms",
        "Evaluate native coronary arteries beyond the graft anastomoses",
        "Plan re-do CABG or percutaneous intervention by mapping all conduits",
        "Assess congenital heart disease with coronary involvement"
      ],
      patientScenarios: [
        "65-year-old post-CABG with recurrent chest pain — query graft occlusion",
        "Pre-operative assessment before re-do cardiac surgery to map all conduits",
        "Young adult with congenital heart disease requiring coronary assessment"
      ]
    },
    anatomy: {
      structures: ["LIMA (left internal mammary artery) graft to LAD", "SVG (saphenous vein grafts) to RCA, OM, diagonal branches", "RIMA (right internal mammary artery) if used", "Native coronary arteries beyond anastomoses", "Ascending aorta (graft origin sites)"],
      pathology: ["Graft occlusion (complete blockage)", "Graft stenosis (narrowing, especially at anastomoses)", "Native vessel progression of disease", "Competitive flow (when native vessel is not severely diseased)"]
    },
    keyLearningPoints: [
      "Extended scan range is needed — from above the arch (for mammary graft origins) to the base of the heart",
      "Both arterial and venous grafts must be identified and traced from origin to anastomosis",
      "HR-dependent acquisition modes apply — same as coronary arteries protocol",
      "Larger contrast volume is often needed due to the extended scan range",
      "Graft assessment is generally easier than native coronaries as grafts are larger and have less motion",
      "Heavily calcified native vessels may be difficult to assess — report should note limitations"
    ],
    decisionGuide: {
      useWhen: ["Patient has had CABG surgery and needs graft assessment", "Congenital heart disease with coronary assessment needed", "Planning re-do cardiac surgery"],
      doNotUseWhen: ["Patient has native (non-operated) coronary arteries only — use Coronary Arteries protocol", "Only calcium score needed"],
      alternatives: [
        { protocol: "coronary_arteries", reason: "If patient has not had bypass surgery" },
        { protocol: "tavi_plus_coros", reason: "If TAVI planning is the primary indication" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Same HR-dependent modes as coronary arteries. Flash for <60 bpm, adaptive sequential for 60-65 bpm, systolic for >65 bpm. The key difference is extended scan range to cover graft origins.",
      contrastProtocol: "Larger contrast volume may be needed to maintain opacification over the longer scan range from arch to diaphragm. Congenital protocols use a modified injection with different flow rates."
    },
    guidelines: {
      references: [
        { name: "SCCT 2022 Appropriate Use", relevance: "Supports CTCA for graft assessment in symptomatic post-CABG patients" },
        { name: "BSCI Standards", relevance: "UK standards for post-surgical cardiac CT imaging" }
      ],
      evidenceSummary: "CTCA has excellent sensitivity and specificity for detecting graft occlusion (>95%). Assessment of native coronary arteries beyond anastomoses is more challenging, particularly with heavy calcification."
    }
  },

  tavi_no_coros: {
    clinicalPurpose: {
      summary: "CT planning for transcatheter aortic valve implantation (TAVI) when coronary arteries have already been assessed by catheterisation.",
      clinicalQuestion: "What are the aortic root dimensions, annular measurements, and access route suitability for TAVI?",
      whyDone: [
        "Measure aortic annulus dimensions for prosthesis sizing (critical for TAVI success)",
        "Assess aortic root anatomy including sinuses of Valsalva and coronary ostial heights",
        "Evaluate peripheral access routes (iliac and femoral arteries) for catheter delivery",
        "Identify anatomical variants that may complicate the procedure"
      ],
      patientScenarios: [
        "80-year-old with severe aortic stenosis being assessed for TAVI — had catheterisation 6 months ago",
        "Patient with porcelain aorta unsuitable for surgical AVR being evaluated for TAVI",
        "Re-do TAVI planning (valve-in-valve) requiring precise measurements"
      ]
    },
    anatomy: {
      structures: ["Aortic annulus (measured in systole)", "Sinuses of Valsalva", "Sinotubular junction", "Left ventricular outflow tract (LVOT)", "Coronary ostial heights (LMS and RCA)", "Iliac arteries and femoral arteries (access routes)", "Ascending and descending aorta"],
      pathology: ["Severe aortic stenosis (heavily calcified, bicuspid, or tricuspid valve)", "Annular calcification pattern and distribution", "Low coronary ostial height (<10mm = high risk)", "Peripheral vascular disease affecting access", "Porcelain aorta"]
    },
    keyLearningPoints: [
      "Annular measurements MUST be taken in systole — the annulus expands by 10-15% from diastole to systole",
      "Coronary ostial height measurement is critical — too low risks coronary obstruction during deployment",
      "Access route assessment includes minimum vessel diameter, calcification, and tortuosity",
      "No coronary assessment in this protocol — patient must have had recent catheterisation (<12 months)",
      "The scan range extends from the thoracic inlet to the femoral heads to capture all access routes",
      "Both gated cardiac and non-gated body angio phases are acquired in the same session"
    ],
    decisionGuide: {
      useWhen: ["Patient has had coronary catheterisation within the last 12 months", "Only TAVI structural planning and access routes are needed", "Lower radiation dose preferred when coronary data already exists"],
      doNotUseWhen: ["Patient has NOT had recent catheterisation — use TAVI + Coronaries protocol", "Only aortic root assessment needed without access routes — consider gated thoracic aorta"],
      alternatives: [
        { protocol: "tavi_plus_coros", reason: "If coronary arteries also need assessment (no recent cath)" },
        { protocol: "gated_thoracic_aorta", reason: "If only aortic root measurement is needed" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Flash mode for the cardiac phase captures the aortic root in systole. A separate non-gated body angio phase covers the access routes (iliac/femoral) without the dose penalty of ECG gating.",
      contrastProtocol: "Biphasic injection: initial cardiac phase with gating, followed by delayed access route scan. Timing optimised for aortic root opacification rather than coronary filling."
    },
    guidelines: {
      references: [
        { name: "SCCT/BSCI TAVI Planning Guidelines", relevance: "Standardised approach to pre-TAVI CT assessment and measurements" },
        { name: "BSCI Standards for Structural Heart Imaging", relevance: "UK standards for valve intervention planning CT" }
      ],
      evidenceSummary: "Pre-procedural CT is the gold standard for TAVI sizing. CT-guided annular sizing has been shown to significantly reduce paravalvular leak compared to echo-only sizing."
    }
  },

  tavi_plus_coros: {
    clinicalPurpose: {
      summary: "Combined TAVI planning CT with coronary artery assessment for patients without recent catheterisation.",
      clinicalQuestion: "What are the TAVI planning dimensions AND is there significant coronary artery disease?",
      whyDone: [
        "All TAVI planning measurements (annulus, root, access) plus coronary artery assessment in one scan",
        "Avoids the need for a separate invasive coronary angiogram before TAVI",
        "Comprehensive one-stop assessment for TAVI candidacy"
      ],
      patientScenarios: [
        "78-year-old with severe AS being assessed for TAVI — no catheterisation in last 12 months",
        "Patient referred for TAVI with unknown coronary status",
        "Frail elderly patient where minimising procedures is important"
      ]
    },
    anatomy: {
      structures: ["All TAVI structures (annulus, root, LVOT, access routes)", "Coronary arteries (LMS, LAD, LCx, RCA)", "Aortic valve leaflets and calcification distribution"],
      pathology: ["Severe aortic stenosis", "Concomitant coronary artery disease", "Combined aortic/coronary pathology requiring treatment strategy planning"]
    },
    keyLearningPoints: [
      "Combines two scans in one session — coronary assessment AND TAVI planning",
      "HR control is important for the coronary component — same beta-blocker/GTN protocol as coronary arteries",
      "The cardiac phase must capture both coronary arteries and aortic root adequately",
      "Higher contrast volume needed compared to TAVI-only protocol to ensure coronary opacification",
      "Patient selection: use this when no catheterisation within 12 months",
      "Reduces total procedures, contrast exposure, and hospital visits for elderly patients"
    ],
    decisionGuide: {
      useWhen: ["TAVI planning needed AND no coronary catheterisation in last 12 months", "One-stop shop assessment preferred for frail/elderly patients"],
      doNotUseWhen: ["Patient had catheterisation within 12 months — use TAVI (No Coronaries) protocol", "Only coronary assessment needed without TAVI planning"],
      alternatives: [
        { protocol: "tavi_no_coros", reason: "If recent catheterisation exists (<12 months)" },
        { protocol: "coronary_arteries", reason: "If only coronary assessment is needed" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Requires optimised cardiac gating for both coronary motion freeze and aortic root systolic capture. The acquisition window must be wider than TAVI-only to ensure coronary quality.",
      contrastProtocol: "Higher volume injection protocol to ensure both coronary arteries and aortic root are well opacified simultaneously."
    },
    guidelines: {
      references: [
        { name: "SCCT/BSCI TAVI Planning Guidelines", relevance: "Supports combined coronary + TAVI assessment in a single CT" },
        { name: "NICE CG95 / ESC 2021", relevance: "CT as alternative to invasive angiography for coronary assessment pre-TAVI" }
      ],
      evidenceSummary: "Recent evidence supports CT coronary assessment as a non-inferior alternative to invasive angiography in TAVI candidates. This one-stop approach reduces procedures and is particularly beneficial for frail elderly patients."
    }
  },

  "4d_valve": {
    clinicalPurpose: {
      summary: "Dynamic 4D assessment of prosthetic aortic valve leaflet motion to detect thrombus or valve dysfunction post-TAVI.",
      clinicalQuestion: "Are the TAVI prosthesis leaflets moving normally, or is there evidence of thrombus or restricted motion?",
      whyDone: [
        "Detect hypoattenuated leaflet thickening (HALT) — a sign of subclinical leaflet thrombosis",
        "Assess reduced leaflet motion (RELM) that may indicate valve dysfunction",
        "Evaluate patients with unexplained symptoms post-TAVI (stroke, TIA, rising gradients)",
        "Monitor anticoagulation response in patients with known leaflet thrombus"
      ],
      patientScenarios: [
        "Patient 6 months post-TAVI with rising transvalvular gradients on echo",
        "Post-TAVI patient who had a TIA — query leaflet thrombus",
        "Routine surveillance of bioprosthetic valve function in research protocols"
      ]
    },
    anatomy: {
      structures: ["TAVI prosthesis leaflets (3 leaflets in most designs)", "Neo-sinuses around the prosthesis", "LVOT below the prosthesis", "Ascending aorta above the prosthesis"],
      pathology: ["HALT (hypoattenuated leaflet thickening) — thrombus on leaflets", "RELM (reduced leaflet motion) — restricted opening", "Paravalvular leak", "Prosthesis malposition"]
    },
    keyLearningPoints: [
      "4D means the scan captures the entire cardiac cycle — multiple phases reconstructed to show leaflet motion",
      "Retrospective gating is used to capture all phases — higher dose than prospective gating",
      "Leaflets should open fully and symmetrically — restricted motion suggests thrombus",
      "HALT appears as a crescent-shaped hypoattenuated area on the leaflet",
      "Best assessed on thin-slice reconstructions in multiple cardiac phases",
      "Anticoagulation (warfarin or DOACs) can resolve subclinical leaflet thrombus"
    ],
    decisionGuide: {
      useWhen: ["Post-TAVI assessment for suspected valve dysfunction", "Rising gradients or new symptoms after TAVI", "Research protocol for valve surveillance"],
      doNotUseWhen: ["Pre-TAVI planning — use TAVI protocols instead", "Native valve assessment — use standard coronary or mitral valve protocols"],
      alternatives: [
        { protocol: "tavi_no_coros", reason: "If planning a new TAVI (not assessing an existing one)" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Retrospective ECG gating captures all cardiac phases (typically 0-95% R-R interval at 5% increments). This is essential for dynamic leaflet motion assessment but carries higher radiation dose.",
      contrastProtocol: "Optimised for aortic root opacification. Timing focuses on peak enhancement of the aortic root rather than coronary arteries."
    },
    guidelines: {
      references: [
        { name: "SCCT Expert Consensus on CT After TAVI", relevance: "Defines HALT/RELM assessment methodology" },
        { name: "BSCI Structural Heart Standards", relevance: "UK standards for post-procedural valve imaging" }
      ],
      evidenceSummary: "Subclinical leaflet thrombosis (HALT) is detected in 10-15% of patients post-TAVI. CT is the only imaging modality that can reliably detect leaflet thrombus. Most cases resolve with anticoagulation."
    }
  },

  mitral_valve: {
    clinicalPurpose: {
      summary: "Detailed assessment of mitral valve anatomy and motility for pre-surgical planning.",
      clinicalQuestion: "What is the mitral valve anatomy, and is the patient suitable for surgical repair or replacement?",
      whyDone: [
        "Assess mitral valve leaflet morphology and motion pre-operatively",
        "Evaluate mitral annulus dimensions for prosthesis sizing",
        "Identify calcification patterns that may affect surgical approach",
        "Plan transcatheter mitral valve interventions"
      ],
      patientScenarios: [
        "Patient with severe mitral regurgitation being assessed for surgical repair",
        "Pre-operative mitral valve assessment before minimally invasive surgery",
        "Planning for transcatheter mitral intervention (MitraClip, TMVR)"
      ]
    },
    anatomy: {
      structures: ["Anterior and posterior mitral leaflets", "Mitral annulus", "Chordae tendineae (where visible)", "Papillary muscles", "Left atrium and left ventricle"],
      pathology: ["Mitral regurgitation (prolapse, flail leaflet)", "Mitral stenosis (rheumatic, calcific)", "Mitral annular calcification (MAC)", "Barlow's disease (bileaflet prolapse)"]
    },
    keyLearningPoints: [
      "BMI-dependent protocol — smaller patients need lower kV and contrast volume",
      "Multi-phase reconstruction needed to assess leaflet motion through the cardiac cycle",
      "Mitral annulus is saddle-shaped — measurements must account for 3D geometry",
      "CT complements echocardiography — CT excels at calcification assessment and 3D relationships",
      "Access route planning may also be needed for transcatheter approaches"
    ],
    decisionGuide: {
      useWhen: ["Pre-surgical mitral valve assessment", "Transcatheter mitral intervention planning", "Mitral annular calcification quantification"],
      doNotUseWhen: ["Simple coronary assessment only — use Coronary Arteries protocol", "Aortic valve (not mitral) assessment — use TAVI protocols"],
      alternatives: [
        { protocol: "coronary_arteries", reason: "If only coronary arteries need assessment" },
        { protocol: "tavi_no_coros", reason: "If aortic (not mitral) valve planning is needed" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Retrospective gating captures all phases for leaflet motion assessment. BMI-based adjustments optimise image quality vs radiation dose.",
      contrastProtocol: "BMI-adjusted contrast volumes ensure adequate left heart opacification for valve visualisation."
    },
    guidelines: {
      references: [
        { name: "SCCT Structural Heart Guidelines", relevance: "Standards for mitral valve CT assessment" },
        { name: "BSCI Standards for Valve Imaging", relevance: "UK approach to pre-surgical cardiac CT for valves" }
      ],
      evidenceSummary: "CT provides complementary information to echocardiography for mitral valve assessment, particularly for calcification quantification, annular sizing, and 3D spatial relationships critical for surgical planning."
    }
  },

  evoque: {
    clinicalPurpose: {
      summary: "CT planning for EVOQUE transcatheter tricuspid valve replacement — assessing tricuspid annulus and right heart anatomy.",
      clinicalQuestion: "What are the tricuspid valve dimensions and is the patient anatomically suitable for EVOQUE TTVR?",
      whyDone: [
        "Measure tricuspid annulus for EVOQUE prosthesis sizing",
        "Assess right heart anatomy and relationship to surrounding structures",
        "Evaluate the IVC and SVC for catheter access planning",
        "Identify anatomical contraindications to transcatheter tricuspid replacement"
      ],
      patientScenarios: [
        "Patient with severe tricuspid regurgitation being evaluated for EVOQUE device",
        "Tricuspid valve replacement planning when surgical risk is prohibitive"
      ]
    },
    anatomy: {
      structures: ["Tricuspid valve annulus", "Right atrium and right ventricle", "IVC and SVC", "Coronary sinus (proximity to tricuspid annulus)", "Right coronary artery (runs in AV groove near tricuspid)"],
      pathology: ["Severe tricuspid regurgitation", "Tricuspid annular dilatation", "Right heart dilatation", "Functional vs organic tricuspid disease"]
    },
    keyLearningPoints: [
      "Tricuspid valve imaging requires optimised right heart opacification",
      "The right coronary artery runs close to the tricuspid annulus — important surgical relationship",
      "Contrast timing differs from left-heart protocols — needs to capture right heart filling",
      "This is a newer structural heart intervention with evolving imaging protocols",
      "Multi-phase acquisition needed for annular dynamics assessment"
    ],
    decisionGuide: {
      useWhen: ["Planning EVOQUE transcatheter tricuspid valve replacement specifically", "Tricuspid annular sizing is needed"],
      doNotUseWhen: ["Mitral valve assessment — use Mitral Valve protocol", "Aortic valve (TAVI) planning — use TAVI protocols"],
      alternatives: [
        { protocol: "mitral_valve", reason: "If mitral (not tricuspid) valve assessment needed" },
        { protocol: "tavi_no_coros", reason: "If aortic valve intervention planning" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Gated acquisition with contrast timing optimised for right heart opacification. This differs from standard left-heart protocols.",
      contrastProtocol: "Modified injection timing to ensure adequate right heart and tricuspid valve opacification rather than primarily left-sided structures."
    },
    guidelines: {
      references: [
        { name: "SCCT Structural Heart Guidelines", relevance: "Framework for tricuspid valve CT assessment" },
        { name: "BSCI Emerging Techniques", relevance: "Evolving standards for transcatheter tricuspid interventions" }
      ],
      evidenceSummary: "Transcatheter tricuspid valve replacement is an emerging field. CT planning follows similar principles to TAVI but with right-heart optimisation. Protocols are being refined as device experience grows."
    }
  },

  tendyne: {
    clinicalPurpose: {
      summary: "Research protocol for Tendyne transcatheter mitral valve replacement — assessing mitral annulus, LV dimensions, and LVOT obstruction risk.",
      clinicalQuestion: "Is this patient anatomically suitable for Tendyne mitral valve replacement, and what is the risk of LVOT obstruction?",
      whyDone: [
        "Measure mitral annulus and left ventricular dimensions for Tendyne device sizing",
        "Assess risk of LVOT obstruction post-deployment (neo-LVOT calculation)",
        "Evaluate transapical access route suitability",
        "Part of a research protocol (GFS — Global Feasibility Study)"
      ],
      patientScenarios: [
        "Patient enrolled in Tendyne GFS with severe mitral regurgitation unsuitable for surgical repair",
        "Pre-procedural assessment for transcatheter mitral replacement via transapical approach"
      ]
    },
    anatomy: {
      structures: ["Mitral annulus (D-shaped, saddle geometry)", "Left ventricle (dimensions, wall thickness)", "LVOT (outflow tract dimensions)", "LV apex (transapical access point)", "Aorto-mitral angle"],
      pathology: ["Severe mitral regurgitation", "Mitral annular calcification", "Small LVOT (obstruction risk)", "LV dilatation or hypertrophy"]
    },
    keyLearningPoints: [
      "Neo-LVOT calculation is critical — predicts whether the device will obstruct the outflow tract",
      "BMI-dependent imaging parameters optimise quality for different body habitus",
      "Transapical access requires assessment of LV apex position and chest wall thickness",
      "This is a research protocol — parameters may evolve with study requirements",
      "Aorto-mitral angle affects device positioning and LVOT risk"
    ],
    decisionGuide: {
      useWhen: ["Tendyne GFS research protocol specifically requested", "Transcatheter mitral replacement planning with LVOT assessment"],
      doNotUseWhen: ["Standard mitral valve assessment — use Mitral Valve protocol", "TAVI (aortic valve) planning"],
      alternatives: [
        { protocol: "mitral_valve", reason: "For standard mitral valve assessment" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Retrospective gating for multi-phase LV and mitral assessment. BMI-based adjustments for image quality optimisation.",
      contrastProtocol: "Left heart opacification optimised for LV cavity and LVOT visualisation. BMI-adjusted volumes."
    },
    guidelines: {
      references: [
        { name: "Tendyne GFS Protocol Requirements", relevance: "Research-specific imaging requirements for device sizing" },
        { name: "SCCT Structural Heart Guidelines", relevance: "General framework for transcatheter mitral CT planning" }
      ],
      evidenceSummary: "Tendyne is one of several transcatheter mitral valve replacement devices under investigation. CT-based neo-LVOT prediction is essential to avoid life-threatening outflow obstruction post-deployment."
    }
  },

  gated_thoracic_aorta: {
    clinicalPurpose: {
      summary: "ECG-gated CT of the thoracic aorta for accurate measurement of aortic dimensions, particularly the ascending aorta and root.",
      clinicalQuestion: "What are the true aortic dimensions, and is the dilatation progressing or at a threshold requiring intervention?",
      whyDone: [
        "Measure ascending aorta and root dimensions accurately (gating eliminates cardiac motion artefact)",
        "Monitor aortic aneurysm progression in connective tissue disorders (Marfan, Ehlers-Danlos)",
        "Assess coarctation of the aorta",
        "Evaluate aortic dissection (particularly involving the ascending aorta)"
      ],
      patientScenarios: [
        "Young patient with Marfan syndrome — annual aortic surveillance",
        "45-year-old with incidentally found dilated ascending aorta (48mm) — baseline gated CT",
        "Acute chest pain with suspected type A aortic dissection involving the root"
      ]
    },
    anatomy: {
      structures: ["Aortic root (annulus to sinotubular junction)", "Ascending aorta", "Aortic arch and great vessels", "Descending thoracic aorta", "Aortic valve (bicuspid assessment)"],
      pathology: ["Aortic root dilatation (>40mm = dilated)", "Ascending aortic aneurysm (>45mm in Marfan = consider surgery)", "Aortic dissection (intimal flap, true and false lumen)", "Coarctation (narrowing, usually distal to left subclavian)", "Bicuspid aortic valve (associated with aortopathy)"]
    },
    keyLearningPoints: [
      "ECG gating is essential for ascending aorta measurement — ungated CT overestimates dimensions due to cardiac motion",
      "Measurements should be made at reproducible anatomical landmarks for serial comparison",
      "Double-oblique measurements perpendicular to the aortic centreline are the gold standard",
      "Marfan patients have specific surgical thresholds different from degenerative aneurysms",
      "No coronary assessment in this protocol — it focuses on the aorta",
      "Beta-blockers help with image quality but are less critical than for coronary imaging"
    ],
    decisionGuide: {
      useWhen: ["Accurate ascending aortic measurement is needed (gating required for root/ascending)", "Aortic surveillance in connective tissue disorders", "Suspected ascending aortic dissection"],
      doNotUseWhen: ["Only descending aorta needs assessment — standard CTA may suffice", "Coronary assessment is the primary indication — use Coronary Arteries protocol"],
      alternatives: [
        { protocol: "aortic_pears", reason: "If ExoVasc PEARS procedure is planned" },
        { protocol: "access_routes", reason: "If full aortic and peripheral access mapping needed" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "ECG-gated Flash or sequential acquisition eliminates pulsation artefact from the ascending aorta. This allows accurate measurements that would be unreliable on ungated CT.",
      contrastProtocol: "Contrast timing optimised for aortic opacification rather than coronary arteries. Test bolus monitored in the ascending aorta."
    },
    guidelines: {
      references: [
        { name: "SCCT Aortic Imaging Guidelines", relevance: "Standardised approach to thoracic aortic CT" },
        { name: "ESC 2014 Aortic Diseases", relevance: "European guidelines for aortic disease management and surveillance intervals" },
        { name: "BSCI Standards", relevance: "UK standards for aortic CT including gated techniques" }
      ],
      evidenceSummary: "ECG-gated CT is the gold standard for ascending aortic measurement. Ungated CT can overestimate aortic dimensions by 2-4mm due to cardiac motion, which can significantly impact surgical decision-making at threshold measurements."
    }
  },

  aortic_pears: {
    clinicalPurpose: {
      summary: "Specialised CT for ExoVasc Personalised External Aortic Root Support (PEARS) — a bespoke mesh sleeve to prevent aortic root dilatation.",
      clinicalQuestion: "What is the precise 3D geometry of the aortic root for manufacturing a personalised ExoVasc support device?",
      whyDone: [
        "Create a patient-specific 3D model of the aortic root for ExoVasc sleeve manufacture",
        "The PEARS sleeve is a mesh support that wraps around the dilated aortic root to prevent further expansion",
        "Alternative to prophylactic root replacement in Marfan and related aortopathies"
      ],
      patientScenarios: [
        "Marfan patient with moderate aortic root dilatation being considered for PEARS rather than root replacement",
        "Patient with aortic root dilatation who wishes to avoid mechanical valve replacement"
      ]
    },
    anatomy: {
      structures: ["Aortic root from annulus to sinotubular junction (precise 3D geometry)", "Sinuses of Valsalva (individual sinus dimensions)", "Coronary ostia (must be preserved by the sleeve)", "Ascending aorta (extent of support needed)"],
      pathology: ["Aortic root dilatation in connective tissue disorders", "Progressive root enlargement at risk of dissection", "Moderate dilatation not yet meeting surgical replacement criteria"]
    },
    keyLearningPoints: [
      "Extremely high precision is required — the CT data is used to manufacture a bespoke medical device",
      "ECG gating is essential for motion-free aortic root images",
      "Multi-phase reconstruction may be needed to capture root geometry at specific cardiac phases",
      "The ExoVasc PEARS procedure is performed at a limited number of centres (Brompton is a specialist centre)",
      "Different from standard aortic CT — the manufacturing process needs specific image quality standards"
    ],
    decisionGuide: {
      useWhen: ["ExoVasc PEARS procedure is specifically planned", "Patient has been assessed by the PEARS surgical team"],
      doNotUseWhen: ["Standard aortic surveillance — use Gated Thoracic Aorta protocol", "TAVI planning — use TAVI protocols"],
      alternatives: [
        { protocol: "gated_thoracic_aorta", reason: "For standard aortic root measurement and surveillance" },
        { protocol: "ross_pears", reason: "If the Ross-PEARS variant is planned (pulmonary autograft)" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "High-resolution gated acquisition optimised for 3D reconstruction. The data must be suitable for CAD/CAM manufacturing processes.",
      contrastProtocol: "Optimised for aortic root opacification with clear delineation of the root geometry."
    },
    guidelines: {
      references: [
        { name: "ExoVasc PEARS Imaging Protocol", relevance: "Device-specific imaging requirements for manufacturing" },
        { name: "Brompton PEARS Programme", relevance: "Local institutional protocol for PEARS CT acquisition" }
      ],
      evidenceSummary: "PEARS is an innovative approach to preventing aortic root complications in connective tissue disorders. Long-term data shows stable aortic dimensions post-procedure with preservation of the native aortic valve."
    }
  },

  ross_pears: {
    clinicalPurpose: {
      summary: "Specialised CT for Ross-PEARS — ExoVasc support for the pulmonary autograft following the Ross procedure.",
      clinicalQuestion: "What is the 3D geometry of the pulmonary autograft for manufacturing a personalised support sleeve?",
      whyDone: [
        "Create a 3D model of the neo-aortic root (pulmonary autograft) after Ross procedure",
        "The Ross procedure replaces the aortic valve with the patient's own pulmonary valve",
        "The autograft can dilate over time — PEARS support prevents this",
        "Preserves the living autograft valve rather than requiring re-replacement"
      ],
      patientScenarios: [
        "Patient post-Ross procedure with progressive neo-aortic root dilatation",
        "Young patient wanting to preserve their pulmonary autograft long-term"
      ]
    },
    anatomy: {
      structures: ["Neo-aortic root (pulmonary autograft in aortic position)", "Pulmonary homograft (in pulmonary position)", "Coronary button reimplantation sites", "Ascending aorta"],
      pathology: ["Progressive neo-aortic root dilatation post-Ross", "Autograft regurgitation due to root dilatation", "Risk of autograft failure requiring re-operation"]
    },
    keyLearningPoints: [
      "The Ross procedure swaps the pulmonary valve into the aortic position — unique post-surgical anatomy",
      "Autograft dilatation is the Achilles heel of the Ross procedure — occurs in 10-20% of patients long-term",
      "Same precision requirements as Aortic PEARS — data used for device manufacture",
      "Understanding the surgically altered anatomy is critical for accurate imaging"
    ],
    decisionGuide: {
      useWhen: ["Ross-PEARS procedure specifically planned for pulmonary autograft support"],
      doNotUseWhen: ["Standard aortic PEARS (non-Ross) — use Aortic PEARS protocol", "Standard aortic surveillance — use Gated Thoracic Aorta"],
      alternatives: [
        { protocol: "aortic_pears", reason: "For standard PEARS (non-Ross anatomy)" },
        { protocol: "gated_thoracic_aorta", reason: "For standard aortic surveillance" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Same high-precision gated acquisition as Aortic PEARS, but focused on the neo-aortic root (pulmonary autograft).",
      contrastProtocol: "Identical to Aortic PEARS — optimised for root geometry delineation."
    },
    guidelines: {
      references: [
        { name: "ExoVasc PEARS Programme", relevance: "Device manufacturing imaging requirements" },
        { name: "Brompton Ross Surgery Programme", relevance: "Institutional expertise in Ross procedure follow-up" }
      ],
      evidenceSummary: "Ross-PEARS combines two Brompton specialisms: the Ross procedure and ExoVasc PEARS technology. Supporting the pulmonary autograft with an external sleeve may extend autograft longevity and avoid re-operation."
    }
  },

  access_routes: {
    clinicalPurpose: {
      summary: "CT assessment of aortic and peripheral vascular anatomy for pre-surgical access planning.",
      clinicalQuestion: "What is the peripheral vascular anatomy, and are the vessels suitable for catheter-based or surgical access?",
      whyDone: [
        "Map vessel calibre, tortuosity, and calcification from aorta to femoral arteries",
        "Plan access routes for structural heart interventions (TAVI, EVAR, etc.)",
        "Assess for aortic dissection repair planning",
        "Evaluate iliac artery disease that may preclude transfemoral access",
        "SCAD (spontaneous coronary artery dissection) imaging"
      ],
      patientScenarios: [
        "Pre-TAVI patient with known peripheral vascular disease — dedicated access assessment",
        "Aortic dissection patient being planned for endovascular repair",
        "Iliac assessment for planned transfemoral procedure"
      ]
    },
    anatomy: {
      structures: ["Descending thoracic aorta", "Abdominal aorta", "Common iliac arteries", "External and internal iliac arteries", "Common femoral arteries", "Aortic bifurcation"],
      pathology: ["Peripheral vascular disease (calcification, stenosis)", "Iliac tortuosity (may preclude large-bore access)", "Aortic dissection (extent, branch involvement)", "Aneurysmal disease", "SCAD (spontaneous coronary artery dissection)"]
    },
    keyLearningPoints: [
      "Non-gated CTA covers the full aorta and peripheral vessels — no cardiac gating needed",
      "Minimum vessel diameter is critical for device sheath sizing (typically 5-6mm for TAVI)",
      "Calcification and tortuosity increase access complications",
      "Both sides (left and right iliac/femoral) must be assessed — operators choose the best side",
      "3D centreline reconstructions help measure true vessel diameter and length"
    ],
    decisionGuide: {
      useWhen: ["Dedicated access route assessment is needed", "Pre-surgical aortic and peripheral mapping", "Aortic dissection assessment"],
      doNotUseWhen: ["Only cardiac/coronary assessment needed — use Coronary Arteries protocol", "Access routes already assessed in a TAVI protocol"],
      alternatives: [
        { protocol: "tavi_no_coros", reason: "If TAVI planning (which includes access routes) is the primary indication" },
        { protocol: "gated_thoracic_aorta", reason: "If only the thoracic aorta needs gated assessment" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Non-gated body CTA provides adequate quality for peripheral vessels without the radiation penalty of ECG gating. Fast acquisition covers the large scan range efficiently.",
      contrastProtocol: "Optimised for arterial opacification throughout the aorta and peripheral vessels. Bolus tracking or test bolus ensures peak enhancement timing."
    },
    guidelines: {
      references: [
        { name: "SCCT Guidelines for Vascular CT", relevance: "Standards for peripheral vascular CT assessment" },
        { name: "BSCI Standards", relevance: "UK approach to vascular access CT imaging" }
      ],
      evidenceSummary: "CT angiography is the gold standard for pre-procedural access route assessment. It has largely replaced diagnostic catheter angiography for vascular mapping."
    }
  },

  carto: {
    clinicalPurpose: {
      summary: "ECG-gated CT of the pulmonary veins and left atrium for pre-ablation mapping and LAA assessment.",
      clinicalQuestion: "What is the pulmonary vein anatomy, is there LAA thrombus, and what are the 3D relationships for ablation planning?",
      whyDone: [
        "Map pulmonary vein anatomy (number, size, branching pattern) for AF ablation planning",
        "Detect left atrial appendage (LAA) thrombus before ablation (contraindication to procedure)",
        "Create 3D models for CARTO electroanatomical mapping systems",
        "Pre-Watchman/Lariat device planning for LAA occlusion"
      ],
      patientScenarios: [
        "Patient with drug-refractory AF scheduled for pulmonary vein isolation ablation",
        "Pre-Watchman assessment — LAA sizing and thrombus exclusion",
        "Patient with AT (atrial tachycardia) or VT requiring 3D mapping"
      ]
    },
    anatomy: {
      structures: ["Left and right superior pulmonary veins", "Left and right inferior pulmonary veins", "Common pulmonary vein trunk (variant)", "Left atrium and left atrial appendage", "Oesophageal relationship (posterior wall risk)", "Phrenic nerve course (near right PVs)"],
      pathology: ["Pulmonary vein anatomical variants (common trunk, accessory veins)", "LAA thrombus (contraindication to ablation)", "Left atrial dilatation", "Prior ablation scarring"]
    },
    keyLearningPoints: [
      "Variant PV anatomy is common — 30-40% of patients have a variant pattern",
      "LAA thrombus exclusion is critical — ablation with thrombus risks stroke",
      "The oesophagus lies posterior to the LA — important relationship for thermal injury risk",
      "CT data is imported into the CARTO system to create a 3D shell for navigation",
      "The arch can optionally be included for retrograde ablation approaches",
      "Gated acquisition freezes cardiac motion for accurate PV ostial measurements"
    ],
    decisionGuide: {
      useWhen: ["Pre-AF/AT/VT ablation mapping is needed", "LAA thrombus exclusion before cardioversion or ablation", "Watchman/Lariat LAA occlusion planning"],
      doNotUseWhen: ["The VIVO or INHEART systems are specified instead — use those protocols", "Only coronary assessment needed"],
      alternatives: [
        { protocol: "vivo", reason: "If VIVO mapping system is specifically requested" },
        { protocol: "inheart", reason: "If INHEART mapping system is requested" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "ECG-gated acquisition for motion-free PV imaging. The arch extension (optional) uses the same gated technique to cover retrograde access anatomy.",
      contrastProtocol: "Timing optimised for left atrial opacification. Dual-phase or delayed imaging may be used for LAA thrombus assessment (thrombus remains hypoattenuated on delayed images)."
    },
    guidelines: {
      references: [
        { name: "HRS/EHRA/ECAS Expert Consensus on AF Ablation", relevance: "Recommends pre-procedural imaging for PV anatomy" },
        { name: "SCCT EP Imaging Guidelines", relevance: "Standards for pre-ablation cardiac CT" },
        { name: "BSCI Standards for EP CT", relevance: "UK approach to electrophysiology CT imaging" }
      ],
      evidenceSummary: "Pre-procedural CT significantly reduces ablation time and improves outcomes by providing detailed anatomical information. Knowledge of PV variants and LA anatomy is essential for safe and effective ablation."
    }
  },

  vivo: {
    clinicalPurpose: {
      summary: "Pre-ablation CT specifically for the VIVO electroanatomical mapping system.",
      clinicalQuestion: "What is the cardiac anatomy for integration with the VIVO mapping and navigation platform?",
      whyDone: [
        "Acquire CT data in the specific format required by the VIVO system",
        "Create a 3D cardiac model for electrophysiology navigation",
        "Must be specifically requested — the VIVO protocol has different acquisition requirements"
      ],
      patientScenarios: [
        "Patient scheduled for ablation where the EP team uses the VIVO system",
        "Referral specifically states 'VIVO protocol required'"
      ]
    },
    anatomy: {
      structures: ["Same as CARTO — pulmonary veins, left atrium, LAA", "Extended anatomy may be required depending on the arrhythmia substrate"],
      pathology: ["Same as CARTO — PV variants, LAA thrombus, atrial substrate assessment"]
    },
    keyLearningPoints: [
      "The request MUST specifically state VIVO protocol — do not assume",
      "Acquisition parameters differ from standard CARTO protocol",
      "The VIVO system has specific data import requirements",
      "Always confirm with the EP team which mapping system they are using"
    ],
    decisionGuide: {
      useWhen: ["EP team specifically requests VIVO protocol", "The referral explicitly states VIVO"],
      doNotUseWhen: ["CARTO system is being used — use CARTO protocol", "INHEART system is being used — use INHEART protocol"],
      alternatives: [
        { protocol: "carto", reason: "If CARTO mapping system is used instead" },
        { protocol: "inheart", reason: "If INHEART system is used" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "System-specific acquisition parameters. The VIVO platform has its own requirements for data compatibility.",
      contrastProtocol: "Similar to CARTO but may have specific timing requirements for the VIVO import process."
    },
    guidelines: {
      references: [
        { name: "VIVO System Technical Requirements", relevance: "System-specific imaging parameters" },
        { name: "BSCI EP Standards", relevance: "UK standards for pre-ablation imaging" }
      ],
      evidenceSummary: "Different EP mapping systems have different CT data requirements. Using the wrong protocol may result in incompatible data that cannot be imported. Always verify the system being used."
    }
  },

  inheart: {
    clinicalPurpose: {
      summary: "Pre-ablation CT for the INHEART system — arterial phase plus late enhanced imaging for substrate assessment.",
      clinicalQuestion: "What is the cardiac anatomy AND myocardial substrate (scar/fibrosis) for INHEART ablation planning?",
      whyDone: [
        "Provide both anatomical (arterial phase) and substrate (late enhanced) data for INHEART",
        "Late enhancement shows myocardial scar/fibrosis — the substrate for ventricular arrhythmias",
        "Particularly valuable for VT ablation planning where scar mapping is critical"
      ],
      patientScenarios: [
        "Patient with ischaemic VT scheduled for ablation using INHEART mapping",
        "Complex arrhythmia requiring both anatomical and substrate information"
      ]
    },
    anatomy: {
      structures: ["Standard cardiac anatomy (chambers, great vessels, PVs)", "Myocardial wall (for scar assessment on late enhancement)", "Coronary arteries (arterial phase)"],
      pathology: ["Myocardial scar from prior infarction (VT substrate)", "Fibrosis patterns (ischaemic vs non-ischaemic)", "Arrhythmogenic substrate localisation"]
    },
    keyLearningPoints: [
      "Two-phase protocol: arterial phase (anatomy) + late enhanced phase (substrate)",
      "Late enhancement CT is analogous to late gadolinium enhancement on MRI",
      "The late phase is acquired ~7 minutes after contrast injection — iodine accumulates in scar tissue",
      "This dual-phase approach provides information similar to cardiac MRI but with better spatial resolution",
      "Particularly valuable when MRI is contraindicated (pacemaker, claustrophobia)"
    ],
    decisionGuide: {
      useWhen: ["INHEART system is specifically requested", "VT ablation requiring substrate mapping", "Dual-phase (anatomy + scar) assessment needed"],
      doNotUseWhen: ["CARTO or VIVO systems are being used", "Only anatomical mapping is needed — use CARTO"],
      alternatives: [
        { protocol: "carto", reason: "If only anatomical mapping needed (CARTO system)" },
        { protocol: "vivo", reason: "If VIVO system is specified" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Arterial phase: standard gated acquisition. Late enhanced phase: acquired after a delay to allow iodine redistribution into scar tissue — similar principle to gadolinium-enhanced MRI.",
      contrastProtocol: "Standard arterial phase injection followed by a waiting period (~7 min) then a second delayed scan without additional contrast injection."
    },
    guidelines: {
      references: [
        { name: "INHEART System Requirements", relevance: "System-specific dual-phase imaging protocol" },
        { name: "SCCT EP Imaging Guidelines", relevance: "Standards for substrate assessment with CT" }
      ],
      evidenceSummary: "CT late enhancement for myocardial scar detection is an emerging technique that provides complementary information to MRI. The INHEART system integrates both anatomical and substrate data for comprehensive ablation planning."
    }
  },

  gated_ctpa: {
    clinicalPurpose: {
      summary: "ECG-gated CT pulmonary angiography for complex cardiac/pulmonary assessment — triple rule-out or congenital heart disease.",
      clinicalQuestion: "Does this patient have pulmonary embolism, aortic dissection, OR coronary disease (triple rule-out), or what is the congenital cardiac anatomy?",
      whyDone: [
        "Triple rule-out: simultaneously assess coronary arteries, aorta, and pulmonary arteries in acute chest pain",
        "Congenital heart disease assessment requiring ECG gating for cardiac structures",
        "Complex cardiac anatomy where standard ungated CTPA is insufficient"
      ],
      patientScenarios: [
        "Acute chest pain with unclear aetiology — need to assess PE, dissection, and CAD simultaneously",
        "Adult congenital heart disease requiring comprehensive cardiac CT",
        "Complex pulmonary vascular anatomy needing gated assessment"
      ]
    },
    anatomy: {
      structures: ["Main, right and left pulmonary arteries", "Segmental and subsegmental pulmonary arteries", "Ascending and descending aorta", "Right ventricle (RV strain assessment)", "Cardiac chambers and septa (congenital)"],
      pathology: ["Pulmonary embolism (acute or chronic)", "Aortic dissection", "Congenital heart defects (ASD, VSD, complex)", "RV dilatation/strain from PE", "Pulmonary hypertension signs"]
    },
    keyLearningPoints: [
      "Gated CTPA differs from standard CTPA — ECG gating reduces cardiac motion for better cardiac assessment",
      "No coronary assessment in this protocol despite gating — contrast timing optimised for pulmonary arteries",
      "Triple rule-out scans have higher radiation dose due to extended range and gating",
      "Standard CTPA is preferred for isolated PE query — gated CTPA is reserved for complex cases",
      "Congenital heart disease often requires multi-phase reconstruction for detailed anatomy"
    ],
    decisionGuide: {
      useWhen: ["Triple rule-out is clinically indicated", "Congenital heart disease requires gated cardiac CT", "Complex cardiopulmonary assessment beyond standard CTPA"],
      doNotUseWhen: ["Simple PE query — standard ungated CTPA is more appropriate", "Only coronary assessment needed — use Coronary Arteries protocol"],
      alternatives: [
        { protocol: "coronary_arteries", reason: "If only coronary assessment is needed" },
        { protocol: "gated_thoracic_aorta", reason: "If only aortic assessment is needed" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "ECG-gated acquisition allows cardiac structure assessment alongside pulmonary angiography. The gating adds dose compared to standard CTPA but provides diagnostic quality for cardiac structures.",
      contrastProtocol: "Contrast timing targets pulmonary artery opacification rather than left heart/coronary filling. Modified from standard CTPA to account for gated acquisition timing."
    },
    guidelines: {
      references: [
        { name: "SCCT Triple Rule-Out Guidelines", relevance: "Appropriate use criteria for combined cardiac/vascular CT" },
        { name: "BSCI Standards", relevance: "UK standards for cardiac CT in acute settings and congenital disease" }
      ],
      evidenceSummary: "Triple rule-out CT can be valuable in selected patients with acute undifferentiated chest pain. However, it should not replace targeted imaging when the clinical probability favours a specific diagnosis."
    }
  },

  paediatric_cardiac: {
    clinicalPurpose: {
      summary: "Weight-based cardiac CT for paediatric patients — congenital heart disease, Kawasaki, anomalous coronaries, and vascular rings.",
      clinicalQuestion: "What is the congenital cardiac anatomy, and are there coronary artery abnormalities?",
      whyDone: [
        "Assess complex congenital heart disease anatomy where echocardiography is insufficient",
        "Evaluate coronary arteries in Kawasaki disease (aneurysm detection and surveillance)",
        "Identify anomalous coronary artery origins in symptomatic children",
        "Diagnose vascular rings and slings causing airway compression"
      ],
      patientScenarios: [
        "Neonate with complex CHD requiring surgical planning CT",
        "5-year-old with history of Kawasaki disease — coronary aneurysm surveillance",
        "Teenager with exertional symptoms — query anomalous coronary origin"
      ]
    },
    anatomy: {
      structures: ["Cardiac chambers and great vessel connections (for CHD)", "Coronary arteries (anomalies, Kawasaki aneurysms)", "Aortic arch (coarctation, vascular rings)", "Pulmonary arteries and veins", "Systemic and pulmonary venous connections"],
      pathology: ["Tetralogy of Fallot (TOF)", "Transposition of great arteries (TGA)", "Major aortopulmonary collateral arteries (MAPCAs)", "Kawasaki coronary artery aneurysms", "Vascular rings (double aortic arch, pulmonary sling)", "Anomalous pulmonary venous drainage"]
    },
    keyLearningPoints: [
      "WEIGHT-BASED protocol — kV, contrast volume, and flow rate all scale with patient weight",
      "Radiation dose must be minimised (ALARA) — paediatric patients are more radiosensitive",
      "Sedation may be required for younger children who cannot cooperate with breath-holding",
      "Free-breathing techniques may be needed for neonates and infants",
      "Image Gently principles should be followed — lowest achievable dose",
      "Consultation with paediatric cardiologist is essential for scan planning",
      "This protocol requires local clinical team verification before use"
    ],
    decisionGuide: {
      useWhen: ["Paediatric patient (any age) needs cardiac CT", "Congenital heart disease assessment", "Kawasaki disease coronary surveillance", "Vascular ring assessment"],
      doNotUseWhen: ["Adult patient — use appropriate adult protocol", "Non-cardiac paediatric CT (use standard paediatric body CT)"],
      alternatives: [
        { protocol: "coronary_arteries", reason: "For adult coronary assessment (not paediatric)" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Weight categories determine kV and acquisition mode. Lower kV (70-80kV) for smaller children improves contrast enhancement and reduces dose. Flash mode preferred where possible for lowest dose.",
      contrastProtocol: "Strictly weight-based: 1-2 ml/kg of contrast at appropriate flow rates for tiny veins. Hand injection may be needed for neonates. Saline chase volumes also weight-adjusted."
    },
    guidelines: {
      references: [
        { name: "SCCT Paediatric CT Guidelines", relevance: "Standards for paediatric cardiac CT acquisition and dose management" },
        { name: "Image Gently Campaign", relevance: "Radiation dose reduction principles for paediatric imaging" },
        { name: "BSCI Paediatric Standards", relevance: "UK standards for paediatric cardiac CT" }
      ],
      evidenceSummary: "Cardiac CT is increasingly used in paediatric congenital heart disease as an alternative to invasive catheterisation. Weight-based protocols and modern CT scanners can achieve diagnostic quality at sub-millisievert doses."
    }
  },

  ecmo_ct: {
    clinicalPurpose: {
      summary: "CT imaging for patients on ECMO (extracorporeal membrane oxygenation) — assessing cannula position, complications, and cardiac recovery.",
      clinicalQuestion: "Is the ECMO cannula correctly positioned, are there complications, and is there evidence of cardiac recovery?",
      whyDone: [
        "Verify cannula position (malposition can cause inadequate support or vascular injury)",
        "Detect ECMO complications: intracranial haemorrhage (ICH), limb ischaemia, oxygenator thrombus",
        "Assess cardiac recovery to guide timing of decannulation",
        "Evaluate for pulmonary complications (PE, consolidation, haemorrhage)"
      ],
      patientScenarios: [
        "Patient on VA-ECMO with suspected ICH — urgent CT head and chest",
        "VA-ECMO patient being assessed for weaning — cardiac recovery scan",
        "VV-ECMO patient with declining oxygenation — query oxygenator thrombus or recirculation"
      ]
    },
    anatomy: {
      structures: ["ECMO cannula positions (arterial and venous)", "Heart chambers (contractility assessment)", "Ascending aorta and great vessels", "Pulmonary arteries (PE assessment)", "Brain (ICH screening)"],
      pathology: ["Cannula malposition", "Intracranial haemorrhage (3% of ECMO patients)", "Limb ischaemia (distal perfusion assessment)", "Cardiac recovery signs (improving contractility)", "Oxygenator thrombus (gas exchange failure)", "Pulmonary embolism on ECMO"]
    },
    keyLearningPoints: [
      "CRITICAL: Perfusionist MUST be present for all ECMO CT scans",
      "Never inject contrast into the distal perfusion cannula — air embolism risk",
      "VA-ECMO uses low-flow technique (reduce ECMO flow to 500 ml/min during scan) for better cardiac opacification",
      "VV-ECMO maintains flow — more predictable contrast enhancement",
      "ECMO flow creates unique contrast dynamics — timing differs from standard cardiac CT",
      "Streak artefact from cannulae must be anticipated and managed",
      "This protocol requires local clinical team and perfusion verification before use"
    ],
    decisionGuide: {
      useWhen: ["Any CT needed on a patient currently on ECMO support", "Cannula position verification", "Complication assessment (ICH, limb ischaemia, PE)", "Pre-decannulation cardiac recovery assessment"],
      doNotUseWhen: ["Patient is NOT on ECMO — use standard protocols", "Standard cardiac CT for non-ECMO patients"],
      alternatives: [
        { protocol: "coronary_arteries", reason: "For standard (non-ECMO) coronary assessment" },
        { protocol: "gated_ctpa", reason: "For standard (non-ECMO) pulmonary assessment" }
      ]
    },
    parameterRationale: {
      acquisitionMode: "Non-gated acquisition due to the complexity of ECMO flow dynamics. 120kV ensures adequate penetration through cannulae and circuit components.",
      contrastProtocol: "VA-ECMO: Flow reduced to 500 ml/min to allow contrast to reach the heart via native circulation. VV-ECMO: Flow maintained but contrast timing adjusted for the altered venous return pathway."
    },
    guidelines: {
      references: [
        { name: "RadioGraphics VA-ECMO CTA Guidelines", relevance: "Published approach to CT imaging during VA-ECMO support" },
        { name: "Alfred ICU ECMO Imaging Protocol", relevance: "Established institutional ECMO imaging guidelines" },
        { name: "ELSO Guidelines", relevance: "Extracorporeal Life Support Organization imaging recommendations" }
      ],
      evidenceSummary: "CT imaging on ECMO requires close coordination with the perfusion team. The altered haemodynamics significantly affect contrast opacification. VA-ECMO low-flow technique has been shown to provide diagnostic quality cardiac imaging."
    }
  }

};

// ============================================================
// CHECKLIST TEMPLATES (per protocol)
// ============================================================
const checklistTemplates = {
  _defaults: {
    preScan: [
      { id: 'egfr', label: 'eGFR checked and documented' },
      { id: 'allergies', label: 'Allergies verified (contrast and medications)' },
      { id: 'fasting', label: 'Fasting status confirmed (if required)' },
      { id: 'iv_access', label: 'IV access established (18–20G antecubital preferred)' },
      { id: 'consent', label: 'Consent obtained and documented' },
      { id: 'pregnancy', label: 'Pregnancy status confirmed (females of childbearing age)' }
    ],
    intraScan: [
      { id: 'breathhold', label: 'Breath-hold coaching completed with patient' },
      { id: 'ecg_signal', label: 'ECG gating signal adequate and stable' },
      { id: 'positioning', label: 'Patient positioning verified (isocentre check)' },
      { id: 'contrast_timing', label: 'Contrast timing / test bolus reviewed' }
    ],
    postScan: [
      { id: 'cannula_removed', label: 'Cannula removed and site checked' },
      { id: 'pacs_sent', label: 'Images sent to PACS (APS and Impax)' },
      { id: 'recons_complete', label: 'All reconstructions completed and verified' },
      { id: 'raw_data', label: 'Raw data exported' },
      { id: 'discharge', label: 'Patient discharge criteria met' }
    ]
  },
  coronary_arteries: {
    preScanAdd: [
      { id: 'beta_blocker', label: 'Beta-blocker administered (if HR >60 and no contraindications)' },
      { id: 'gtn', label: 'GTN administered (if protocolled and no contraindications)' },
      { id: 'baseline_obs', label: 'Baseline BP and SpO₂ recorded' }
    ],
    postScanAdd: [
      { id: 'post_obs', label: 'Post-observation BP and SpO₂ (if beta-blocker/GTN given)' }
    ]
  },
  calcium_score: {
    preScanRemove: ['iv_access', 'fasting'],
    intraScanRemove: ['contrast_timing'],
    postScanRemove: ['cannula_removed']
  },
  grafts: {
    preScanAdd: [
      { id: 'beta_blocker', label: 'Beta-blocker administered (if HR >60 and no contraindications)' },
      { id: 'gtn', label: 'GTN administered (if protocolled and no contraindications)' },
      { id: 'baseline_obs', label: 'Baseline BP and SpO₂ recorded' },
      { id: 'surgical_hx', label: 'Surgical history reviewed (graft type and number confirmed)' }
    ],
    postScanAdd: [
      { id: 'post_obs', label: 'Post-observation BP and SpO₂ (if beta-blocker/GTN given)' }
    ]
  },
  tavi_no_coros: {
    preScanAdd: [
      { id: 'tavi_referral', label: 'TAVI referral and clinical question confirmed with team' }
    ]
  },
  tavi_plus_coros: {
    preScanAdd: [
      { id: 'beta_blocker', label: 'Beta-blocker administered (if HR >60 and no contraindications)' },
      { id: 'gtn', label: 'GTN administered (if protocolled and no contraindications)' },
      { id: 'baseline_obs', label: 'Baseline BP and SpO₂ recorded' },
      { id: 'tavi_referral', label: 'TAVI referral confirmed — coronaries included in scan' }
    ],
    postScanAdd: [
      { id: 'post_obs', label: 'Post-observation BP and SpO₂ (if beta-blocker/GTN given)' }
    ]
  },
  '4d_valve': {
    preScanAdd: [
      { id: 'valve_question', label: 'Clinical question confirmed (which valve, what pathology)' }
    ],
    intraScanAdd: [
      { id: 'retro_gating', label: 'Retrospective gating confirmed for 4D reconstruction' }
    ]
  },
  mitral_valve: {
    preScanAdd: [
      { id: 'valve_question', label: 'Mitral valve pathology and clinical question confirmed' }
    ]
  },
  evoque: {
    preScanAdd: [
      { id: 'evoque_team', label: 'Evoque valve team consultation documented' }
    ]
  },
  tendyne: {
    preScanAdd: [
      { id: 'tendyne_team', label: 'Tendyne valve team consultation documented' }
    ]
  },
  gated_thoracic_aorta: {
    preScanAdd: [
      { id: 'aorta_question', label: 'Aortic pathology and clinical question confirmed' }
    ]
  },
  aortic_pears: {
    preScanAdd: [
      { id: 'pears_team', label: 'PEARS surgical team consultation confirmed' },
      { id: 'beta_blocker', label: 'Beta-blocker administered (if HR >60 and no contraindications)' },
      { id: 'baseline_obs', label: 'Baseline BP and SpO₂ recorded' }
    ],
    postScanAdd: [
      { id: 'post_obs', label: 'Post-observation BP and SpO₂ (if beta-blocker given)' }
    ]
  },
  ross_pears: {
    preScanAdd: [
      { id: 'ross_team', label: 'Ross/PEARS surgical team consultation confirmed' },
      { id: 'beta_blocker', label: 'Beta-blocker administered (if HR >60 and no contraindications)' },
      { id: 'baseline_obs', label: 'Baseline BP and SpO₂ recorded' }
    ],
    postScanAdd: [
      { id: 'post_obs', label: 'Post-observation BP and SpO₂ (if beta-blocker given)' }
    ]
  },
  access_routes: {
    preScanAdd: [
      { id: 'access_question', label: 'Access route assessment requirements confirmed (femoral, subclavian, etc.)' }
    ]
  },
  carto: {
    preScanAdd: [
      { id: 'ep_team', label: 'EP team consultation — mapping requirements confirmed' },
      { id: 'arch_decision', label: 'Arch inclusion decision confirmed with EP team' }
    ],
    intraScanRemove: ['ecg_signal']
  },
  vivo: {
    preScanAdd: [
      { id: 'ep_team', label: 'EP team consultation — Vivo mapping requirements confirmed' }
    ],
    intraScanRemove: ['ecg_signal']
  },
  inheart: {
    preScanAdd: [
      { id: 'ep_team', label: 'EP team consultation — InHeart mapping requirements confirmed' }
    ],
    intraScanRemove: ['ecg_signal']
  },
  gated_ctpa: {
    preScanAdd: [
      { id: 'clinical_question', label: 'Clinical question confirmed (PE vs right heart vs both)' }
    ]
  },
  paediatric_cardiac: {
    preScanAdd: [
      { id: 'sedation', label: 'Sedation arranged if needed (per weight band and age)' },
      { id: 'paed_cardio', label: 'Paediatric cardiologist consulted for scan plan' },
      { id: 'weight_confirmed', label: 'Patient weight confirmed for dose and contrast calculation' },
      { id: 'parent_consent', label: 'Parental consent obtained and documented' }
    ],
    preScanRemove: ['fasting']
  },
  ecmo_ct: {
    preScanAdd: [
      { id: 'perfusionist', label: 'CRITICAL: Perfusionist present and confirmed for transport' },
      { id: 'ecmo_battery', label: 'ECMO pump battery life adequate for transport duration' },
      { id: 'separate_iv', label: 'IV access SEPARATE from ECMO circuit confirmed' },
      { id: 'transport_checklist', label: 'Transport checklist completed (monitoring, airway, meds)' },
      { id: 'ecmo_type_confirmed', label: 'ECMO type confirmed (VV / VA / ECPELLA)' }
    ],
    preScanRemove: ['fasting'],
    intraScanAdd: [
      { id: 'ecmo_flow', label: 'ECMO flow rate adjustments discussed with perfusionist' }
    ],
    postScanAdd: [
      { id: 'ecmo_flow_restored', label: 'ECMO flow restored to pre-scan settings' },
      { id: 'safe_return', label: 'Patient safely returned to ICU/ward' }
    ]
  }
};

function getChecklistForProtocol(protocolKey) {
  const d = checklistTemplates._defaults;
  const o = checklistTemplates[protocolKey] || {};
  function merge(defaults, add, remove) {
    let items = [...defaults];
    if (remove && remove.length) items = items.filter(i => !remove.includes(i.id));
    if (add && add.length) items = items.concat(add);
    return items;
  }
  return {
    preScan: merge(d.preScan, o.preScanAdd, o.preScanRemove),
    intraScan: merge(d.intraScan, o.intraScanAdd, o.intraScanRemove),
    postScan: merge(d.postScan, o.postScanAdd, o.postScanRemove)
  };
}

// ============================================================
// CALCULATOR CONSTANTS
// ============================================================
const CKD_EPI = {
  kappa: { male: 0.9, female: 0.7 },
  alpha: { male: -0.302, female: -0.241 },
  sexCoeff: { male: 1.0, female: 1.012 }
};

const DOSE_CONSTANTS = {
  bgMsvYear: 2.4,
  chestXrayMsv: 0.02,
  kChest: 0.014,
  kAbdomen: 0.015
};

// ============================================================
// CONTRAST & TIMING METADATA (per-protocol classification)
// ============================================================
const contrastMetadata = {
  coronary_arteries: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: function(hr) {
      if (hr < 60) return "Test bolus timing + 5 seconds delay";
      return "Test bolus timing + 3 seconds delay";
    },
    contrastAgent: "Iomeron 400",
    notes: "BMI-dependent volume: Standard (<28 BMI) or Large (≥28 BMI). Always use test bolus with 10s dynamic evaluation at carina level, ROI ascending aorta."
  },
  calcium_score: {
    injectionType: "Non-Contrast",
    injectionClass: "none",
    phaseType: "N/A",
    timingMethod: "N/A",
    timingDetail: "No contrast injection required",
    contrastAgent: "None",
    notes: "Non-contrast prospective ECG-gated sequential acquisition for calcium scoring."
  },
  grafts: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: function(hr) {
      if (hr < 65) return "Test bolus timing — no extra delay (diastolic adaptive)";
      return "Test bolus timing + 3 seconds delay (systolic adaptive)";
    },
    contrastAgent: "Iomeron 400",
    notes: "Standard cardiac injection for grafts. For congenital patients requiring R+L heart + coronaries: switch to Cardiac Long Injection (150ml)."
  },
  tavi_no_coros: {
    injectionType: "Flash TAVI",
    injectionClass: "flash",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing + 8 seconds delay",
    contrastAgent: "Iomeron 400",
    notes: "Three-phase injection: 10ml at 3 ml/s, then 60ml at 5-6 ml/s contrast, followed by 40ml saline chase. Test bolus at L1 level, ROI in descending aorta."
  },
  tavi_plus_coros: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial (dual-phase)",
    timingMethod: "Test Bolus",
    timingDetail: "CTCA: Test bolus + 3s | Body angio: minimum 6 seconds after CTCA complete",
    contrastAgent: "Iomeron 400",
    notes: "Two-stage acquisition: cardiac phase with CTCA delay, then body angiogram with minimum 6s inter-scan delay. Test bolus at carina, ROI in descending aorta."
  },
  '4d_valve': {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing + 3 seconds delay",
    contrastAgent: "Iomeron 400",
    notes: "Adaptive Sequential 0%-100% full cardiac cycle. Single adaptive block through valve only. Multiphase reconstruction at every 5% R-R interval."
  },
  mitral_valve: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing (cardiac phase)",
    contrastAgent: "Iomeron 400",
    notes: "Adaptive Sequential 30%-90% R-R for end systole + end diastole. Test bolus at carina, ROI in ascending aorta."
  },
  evoque: {
    injectionType: "Long Injection",
    injectionClass: "long-injection",
    phaseType: "Arterial + Venous (dual-phase)",
    timingMethod: "Test Bolus + Set Delay",
    timingDetail: "Cardiac: Test bolus timing | Venogram: 90 seconds post-contrast start",
    contrastAgent: "Iomeron 400",
    notes: "Two linked scans — first cardiac with full retrospective spiral (0-100% R-R), then delayed venogram at 90 seconds for iliofemoral access planning."
  },
  tendyne: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial + Delayed",
    timingMethod: "Test Bolus + Set Delay",
    timingDetail: "Cardiac: Test bolus timing | Low-dose thorax: 40 seconds post-contrast",
    contrastAgent: "Iomeron 400",
    notes: "BMI-dependent volume. Full Retrospective Spiral 0-100%. Research protocol with additional low-dose thorax at 40s delay."
  },
  gated_thoracic_aorta: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing — no extra delay",
    contrastAgent: "Iomeron 400",
    notes: "Turbo Flash Gated. Test bolus at carina level, ROI in descending aorta. No additional delay beyond test bolus timing."
  },
  aortic_pears: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing + 8 seconds delay",
    contrastAgent: "Iomeron 400",
    notes: "Flash Gated acquisition. Aortic valve imaging 60-80% R-R interval. Exstent-specific DICOM requirements."
  },
  ross_pears: {
    injectionType: "Bastion Wheel",
    injectionClass: "bastion-wheel",
    phaseType: "Set Delay",
    timingMethod: "Set Delay (Bastion Wheel)",
    timingDetail: "80 seconds fixed delay — per Bastion Wheel chart",
    contrastAgent: "Iomeron 400",
    notes: "Uses Bastion Wheel chart for injection parameters and timing. Millisecond timings as per chart. Cardiac gating 10%-40% R-R (preferably 10%-25%) for ventricular systole."
  },
  access_routes: {
    injectionType: "Flash TAVI",
    injectionClass: "flash",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing + 8 seconds delay",
    contrastAgent: "Iomeron 400",
    notes: "Flash TAVI injection protocol. Test bolus at L1 level, ROI in descending aorta. Three-phase injection strategy for access route coverage."
  },
  carto: {
    injectionType: "Standard Cardiac",
    injectionClass: "standard",
    phaseType: "Arterial + Delayed",
    timingMethod: "Test Bolus + Set Delay",
    timingDetail: "Main scan: Test bolus timing (no extra delay) | Delayed LAA: 60 seconds after first scan",
    contrastAgent: "Iomeron 400",
    notes: "Gated Adaptive Sequential for pulmonary veins. Delayed LAA scan at 60s to assess left atrial appendage filling/thrombus."
  },
  vivo: {
    injectionType: "Long Injection",
    injectionClass: "long-injection",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing (no specified extra delay)",
    contrastAgent: "Iomeron 400",
    notes: "Cardiac Long Injection protocol (150ml). Extended injection time for comprehensive cardiovascular assessment. Test bolus at carina, ROI in descending aorta."
  },
  inheart: {
    injectionType: "Bastion Wheel",
    injectionClass: "bastion-wheel",
    phaseType: "Arterial + Late Enhancement",
    timingMethod: "Set Delay (Bastion Wheel)",
    timingDetail: "Arterial scan: 70 seconds (Bastion Wheel) | Late CTCA: 8 minutes post-contrast",
    contrastAgent: "Iomeron 400",
    notes: "Two-phase Bastion Wheel protocol: arterial phase at 60-80% R-R for ventricular filling, then late CTCA at 8 minutes for myocardial late enhancement. Heart only for late phase."
  },
  gated_ctpa: {
    injectionType: "Long Injection",
    injectionClass: "long-injection",
    phaseType: "Arterial",
    timingMethod: "Test Bolus",
    timingDetail: "Test bolus timing + 8 seconds delay",
    contrastAgent: "Iomeron 400",
    notes: "Cardiac Long Injection (150ml) for congenital heart or triple rule out (PE, aortic dissection, CAD). Test bolus at carina, ROI in ascending aorta."
  },
  paediatric_cardiac: {
    injectionType: "Weight-Based Paediatric",
    injectionClass: "weight-based",
    phaseType: "Arterial",
    timingMethod: "Bolus Tracking",
    timingDetail: "Manual bolus tracking — 100 HU threshold in descending aorta",
    contrastAgent: "Iomeron 350 or 400",
    notes: "Weight-based contrast volume (1.5-2 ml/kg). Manual bolus tracking preferred over test bolus in paediatrics. Monitor descending aorta for 100 HU trigger."
  },
  ecmo_ct: {
    injectionType: "Manual ECMO",
    injectionClass: "manual",
    phaseType: "Manual ROI Trigger",
    timingMethod: "Manual ROI",
    timingDetail: "Manual ROI triggering at peak enhancement — standard timing UNRELIABLE",
    contrastAgent: "Iomeron 400",
    notes: "ECMO haemodynamics make standard test bolus unreliable. VA-ECMO: retrograde/antegrade mixing requires manual peak detection. VV-ECMO: more predictable timing but still manual ROI recommended."
  }
};

// ============================================================
// QUIZ BANK (MCQs by category)
// ============================================================
const quizBank = {
  coronary: {
    label: 'Coronary Protocols',
    icon: '♥',
    questions: [
      {
        id: 'qc1', question: 'A 52-year-old presents with atypical chest pain and intermediate pre-test probability of CAD. Which protocol is most appropriate?',
        options: [
          { text: 'Coronary Arteries CTCA', correct: true },
          { text: 'Calcium Score only', correct: false },
          { text: 'Grafts (CABG) protocol', correct: false },
          { text: 'Gated CTPA', correct: false }
        ],
        explanation: 'NICE CG95 recommends CTCA as the first-line investigation for stable chest pain with intermediate pre-test probability. Calcium score alone cannot detect non-calcified (soft) plaque.', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qc2', question: 'For coronary CTCA, what acquisition mode gives the lowest radiation dose when HR is <60 bpm and regular?',
        options: [
          { text: 'Turbo Flash (single heartbeat)', correct: true },
          { text: 'End-diastolic Adaptive Sequential', correct: false },
          { text: 'End-systolic Adaptive Sequential', correct: false },
          { text: 'Retrospective spiral', correct: false }
        ],
        explanation: 'Flash mode captures the entire heart in <0.5 seconds during a single diastolic pause. It requires HR <60 bpm with regular rhythm for optimal results and provides the lowest radiation dose.', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qc3', question: 'A patient who had CABG 10 years ago presents with recurrent chest pain. Which protocol should you use?',
        options: [
          { text: 'Grafts (CABG + Native Coronaries)', correct: true },
          { text: 'Standard Coronary Arteries CTCA', correct: false },
          { text: 'Calcium Score', correct: false },
          { text: 'Gated Thoracic Aorta', correct: false }
        ],
        explanation: 'Patients with bypass grafts require the Grafts protocol which uses a wider scan range (from above the subclavian to below the diaphragm) to capture both graft origins and native coronaries.', protocolRef: 'grafts'
      },
      {
        id: 'qc4', question: 'What is the primary purpose of a test bolus in coronary CTCA?',
        options: [
          { text: 'Determine individual contrast circulation time for optimal opacification', correct: true },
          { text: 'Check for contrast allergy', correct: false },
          { text: 'Measure cardiac output', correct: false },
          { text: 'Calculate the required contrast volume', correct: false }
        ],
        explanation: 'A test bolus determines the time taken for contrast to travel from the injection site to the ascending aorta. This patient-specific timing ensures optimal coronary opacification during the scan acquisition.', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qc5', question: 'A patient has a resting HR of 72 bpm before coronary CTCA. What should you do?',
        options: [
          { text: 'Administer oral beta-blocker (if no contraindications) and recheck HR', correct: true },
          { text: 'Proceed with Flash acquisition — it works at any HR', correct: false },
          { text: 'Cancel the scan — HR is too high', correct: false },
          { text: 'Switch to a non-gated protocol', correct: false }
        ],
        explanation: 'HR >65 bpm requires beta-blocker preparation for coronary CTCA. Oral metoprolol 50–100mg 1 hour pre-scan, or IV metoprolol 5mg increments (max 15mg). HR 72 is manageable with appropriate preparation.', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qc6', question: 'When is a Calcium Score study most appropriately used as a standalone investigation?',
        options: [
          { text: 'For cardiovascular risk stratification in asymptomatic patients', correct: true },
          { text: 'To diagnose acute coronary syndrome', correct: false },
          { text: 'To replace CTCA in patients with chest pain', correct: false },
          { text: 'To assess bypass graft patency', correct: false }
        ],
        explanation: 'Calcium scoring is a non-contrast, low-dose scan used for cardiovascular risk stratification. It cannot detect soft plaque or assess graft patency, so it is not a replacement for CTCA in symptomatic patients.', protocolRef: 'calcium_score'
      }
    ]
  },
  valve: {
    label: 'Valve & Structural',
    icon: '⚙',
    questions: [
      {
        id: 'qv1', question: 'A patient with severe aortic stenosis is being evaluated for TAVI. Coronary assessment was done by catheterisation. Which protocol?',
        options: [
          { text: 'Turbo Flash TAVI (No Coronaries)', correct: true },
          { text: 'TAVI Plus Coronaries', correct: false },
          { text: 'Standard Coronary Arteries CTCA', correct: false },
          { text: 'Gated Thoracic Aorta', correct: false }
        ],
        explanation: 'When coronary arteries have already been assessed by catheterisation, the TAVI (No Coronaries) protocol is used. It focuses on aortic root dimensions, annular measurements, and access route suitability without the need for coronary-quality imaging.', protocolRef: 'tavi_no_coros'
      },
      {
        id: 'qv2', question: 'What additional scan range is required for TAVI planning compared to standard coronary CTCA?',
        options: [
          { text: 'From above the aortic arch to the femoral arteries (access routes)', correct: true },
          { text: 'Only the aortic root', correct: false },
          { text: 'From the neck to the diaphragm', correct: false },
          { text: 'The same range as coronary CTCA', correct: false }
        ],
        explanation: 'TAVI planning requires assessment of peripheral access routes (iliac and femoral arteries) for catheter delivery. The scan extends from the subclavian arteries down to the common femoral arteries.', protocolRef: 'tavi_no_coros'
      },
      {
        id: 'qv3', question: 'For 4D valve assessment, which gating mode is required and why?',
        options: [
          { text: 'Retrospective gating — enables reconstruction at all phases of the cardiac cycle', correct: true },
          { text: 'Prospective triggering — lower dose', correct: false },
          { text: 'No gating needed — valve motion is slow', correct: false },
          { text: 'Flash mode — captures the valve in one heartbeat', correct: false }
        ],
        explanation: '4D valve assessment requires retrospective gating to reconstruct images at multiple phases throughout the cardiac cycle. This allows dynamic assessment of valve opening, closing, and leaflet motion.', protocolRef: '4d_valve'
      },
      {
        id: 'qv4', question: 'A patient needs both TAVI planning AND coronary assessment. No prior catheterisation has been done. Which protocol?',
        options: [
          { text: 'TAVI Plus Coronaries', correct: true },
          { text: 'Turbo Flash TAVI (No Coronaries) followed by a separate Coronary CTCA', correct: false },
          { text: 'Standard Coronary Arteries CTCA only', correct: false },
          { text: 'Gated Thoracic Aorta', correct: false }
        ],
        explanation: 'TAVI Plus Coronaries combines TAVI planning with coronary assessment in a single scan session, requiring beta-blocker preparation for coronary quality imaging alongside the TAVI measurements.', protocolRef: 'tavi_plus_coros'
      },
      {
        id: 'qv5', question: 'What key measurements are obtained from TAVI CT planning?',
        options: [
          { text: 'Aortic annulus dimensions, sinus of Valsalva heights, coronary ostial heights, access route diameters', correct: true },
          { text: 'Coronary artery calcium score only', correct: false },
          { text: 'Left ventricular ejection fraction only', correct: false },
          { text: 'Pulmonary artery pressures', correct: false }
        ],
        explanation: 'TAVI CT provides critical measurements for prosthesis sizing (annulus), risk assessment (coronary heights, sinus dimensions), and procedural planning (access route diameters for catheter selection).', protocolRef: 'tavi_no_coros'
      }
    ]
  },
  aortic: {
    label: 'Aortic Protocols',
    icon: '🫀',
    questions: [
      {
        id: 'qa1', question: 'Why is ECG gating used for thoracic aorta CT rather than a non-gated scan?',
        options: [
          { text: 'To eliminate cardiac motion artefact at the aortic root and ascending aorta', correct: true },
          { text: 'To measure coronary arteries simultaneously', correct: false },
          { text: 'To reduce radiation dose', correct: false },
          { text: 'Gating is not needed for aortic imaging', correct: false }
        ],
        explanation: 'The ascending aorta and aortic root move significantly with each heartbeat. ECG gating freezes this motion, preventing pulsation artefact that can mimic or obscure dissection flaps, aneurysmal measurements, and root pathology.', protocolRef: 'gated_thoracic_aorta'
      },
      {
        id: 'qa2', question: 'What is the PEARS procedure and why does it need specific CT planning?',
        options: [
          { text: 'Personalised External Aortic Root Support — requires a 3D model of the aortic root for custom mesh manufacture', correct: true },
          { text: 'Percutaneous Endovascular Aortic Repair — standard CT angiography is sufficient', correct: false },
          { text: 'Post-operative Evaluation of Aortic Root Stent — only needs a chest X-ray', correct: false },
          { text: 'Pulmonary Embolism Assessment and Risk Scoring — uses a CTPA protocol', correct: false }
        ],
        explanation: 'PEARS is a patient-specific external aortic root support mesh used in Marfan syndrome and other connective tissue disorders. The CT scan provides a 3D model of the aortic root from which the custom support mesh is manufactured.', protocolRef: 'aortic_pears'
      },
      {
        id: 'qa3', question: 'For access route assessment, what vessel territory must be covered?',
        options: [
          { text: 'From the subclavian arteries to the common femoral arteries bilaterally', correct: true },
          { text: 'Only the thoracic aorta', correct: false },
          { text: 'Only the iliac arteries', correct: false },
          { text: 'From the aortic arch to the knees', correct: false }
        ],
        explanation: 'Access route assessment evaluates the entire path a TAVI/structural heart catheter would take: subclavian, aorta, iliac arteries, and femoral arteries. Vessel diameter, tortuosity, and calcification all affect catheter selection and approach.', protocolRef: 'access_routes'
      }
    ]
  },
  ep: {
    label: 'Electrophysiology',
    icon: '⚡',
    questions: [
      {
        id: 'qe1', question: 'What is the primary purpose of CT for EP mapping (CARTO/Vivo/InHeart)?',
        options: [
          { text: 'Create a 3D anatomical model of cardiac chambers for electroanatomical mapping integration', correct: true },
          { text: 'Assess coronary artery disease', correct: false },
          { text: 'Measure cardiac valve function', correct: false },
          { text: 'Detect pulmonary embolism', correct: false }
        ],
        explanation: 'EP mapping CT creates a detailed 3D model of the left atrium and pulmonary veins (or other chambers) that is imported into the electroanatomical mapping system. This allows the electrophysiologist to navigate catheters within an accurate anatomical framework.', protocolRef: 'carto'
      },
      {
        id: 'qe2', question: 'When performing a CARTO CT, when should the aortic arch be included in the scan?',
        options: [
          { text: 'When the EP team plans a retrograde aortic approach for left-sided ablation', correct: true },
          { text: 'Always — it is mandatory for all EP mapping CTs', correct: false },
          { text: 'Never — only the heart is needed', correct: false },
          { text: 'Only if the patient has aortic disease', correct: false }
        ],
        explanation: 'The arch is included when a retrograde aortic approach is planned, so the mapping system has anatomical data for catheter navigation through the aortic arch into the left ventricle.', protocolRef: 'carto'
      },
      {
        id: 'qe3', question: 'Why is ECG gating less critical for EP mapping CT than for coronary CTCA?',
        options: [
          { text: 'EP mapping needs chamber shape/volume rather than coronary artery detail — some motion is acceptable', correct: true },
          { text: 'EP mapping systems cannot use gated data', correct: false },
          { text: 'Heart rate does not affect EP mapping quality', correct: false },
          { text: 'Gating is equally critical for both', correct: false }
        ],
        explanation: 'EP mapping requires accurate chamber geometry (pulmonary vein anatomy, left atrial shape) rather than sub-millimetre coronary detail. While gating improves quality, the spatial resolution requirements are less demanding than for coronary assessment.', protocolRef: 'carto'
      }
    ]
  },
  general: {
    label: 'General CT Knowledge',
    icon: '📚',
    questions: [
      {
        id: 'qg1', question: 'What eGFR threshold should prompt consideration of contrast dose reduction and hydration for cardiac CT?',
        options: [
          { text: 'eGFR <60 mL/min (CKD stage 3 and below)', correct: true },
          { text: 'eGFR <90 mL/min', correct: false },
          { text: 'eGFR <30 mL/min only', correct: false },
          { text: 'eGFR is not relevant for IV contrast', correct: false }
        ],
        explanation: 'eGFR <60 mL/min (CKD stage 3+) increases the risk of contrast-induced nephropathy. Volume reduction (~20%) and pre/post hydration protocols should be considered. eGFR <30 requires senior discussion.', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qg2', question: 'Which of these is an absolute contraindication to beta-blocker administration before cardiac CT?',
        options: [
          { text: 'Acute decompensated heart failure', correct: true },
          { text: 'Heart rate of 80 bpm', correct: false },
          { text: 'Age over 70 years', correct: false },
          { text: 'BMI over 30', correct: false }
        ],
        explanation: 'Acute decompensated heart failure is an absolute contraindication to beta-blockers. Other contraindications include severe asthma, second/third-degree heart block, and severe bradycardia (<50 bpm).', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qg3', question: 'What is the advantage of prospective ECG triggering over retrospective gating?',
        options: [
          { text: 'Significantly lower radiation dose (X-ray on only during target cardiac phase)', correct: true },
          { text: 'Better image quality in all cases', correct: false },
          { text: 'Allows scanning at any heart rate', correct: false },
          { text: 'No ECG connection is required', correct: false }
        ],
        explanation: 'Prospective triggering only exposes the patient to radiation during the target cardiac phase window, resulting in significantly lower dose. Retrospective gating irradiates throughout the entire cardiac cycle but allows reconstruction at any phase.', protocolRef: 'coronary_arteries'
      },
      {
        id: 'qg4', question: 'A child with suspected congenital heart disease needs cardiac CT. What special consideration is most important?',
        options: [
          { text: 'Weight-based contrast dosing and reduced tube voltage/current for radiation reduction', correct: true },
          { text: 'Use the same adult protocol — children are small adults', correct: false },
          { text: 'Calcium scoring should be done first', correct: false },
          { text: 'Beta-blockers are always required in children', correct: false }
        ],
        explanation: 'Paediatric cardiac CT requires weight-based contrast dosing (typically 1.5–2 mL/kg), reduced kV (70–80kV for small children), and adapted scan parameters. The ALARA principle is particularly important in children due to higher lifetime radiation risk.', protocolRef: 'paediatric_cardiac'
      },
      {
        id: 'qg5', question: 'Why is contrast injection via the ECMO circuit contraindicated for CT scanning?',
        options: [
          { text: 'The circuit would dilute and recirculate contrast, giving unpredictable opacification', correct: true },
          { text: 'Contrast damages the ECMO membrane oxygenator', correct: false },
          { text: 'The ECMO pump cannot handle the injection pressure', correct: false },
          { text: 'It is not contraindicated — ECMO circuit injection is preferred', correct: false }
        ],
        explanation: 'Injecting contrast into the ECMO circuit results in dilution by the circuit volume and recirculation, making contrast timing unpredictable and opacification unreliable. A separate peripheral IV must be used for contrast injection.', protocolRef: 'ecmo_ct'
      },
      {
        id: 'qg6', question: 'What post-scan monitoring is required after administering IV beta-blockers for cardiac CT?',
        options: [
          { text: 'Post-observation BP and SpO₂ until values return to baseline', correct: true },
          { text: 'No monitoring is required for IV beta-blockers', correct: false },
          { text: '24-hour Holter monitor', correct: false },
          { text: 'Repeat ECG only', correct: false }
        ],
        explanation: 'After IV beta-blocker administration, patients must have post-observation BP and SpO₂ monitoring. Values should return to baseline before discharge. This is particularly important if GTN was also administered.', protocolRef: 'coronary_arteries'
      }
    ]
  }
};

// ============================================================
// CLINICAL CASES (branching vignettes)
// ============================================================
const clinicalCases = [
  {
    id: 'case_chest_pain',
    title: 'Stable Chest Pain Assessment',
    category: 'coronary',
    difficulty: 'Foundation',
    description: 'A 58-year-old man with a 3-month history of exertional chest tightness is referred for cardiac CT.',
    steps: [
      {
        id: 's1',
        prompt: 'The GP referral states: "Atypical chest pain, intermediate pre-test probability, please assess for CAD." Which protocol would you select?',
        options: [
          { text: 'Coronary Arteries CTCA', nextStep: 's2', correct: true, feedback: 'Correct! NICE CG95 recommends CTCA as the first-line investigation for stable chest pain with intermediate pre-test probability of CAD.' },
          { text: 'Calcium Score only', nextStep: null, correct: false, feedback: 'Calcium score alone cannot detect non-calcified (soft) plaque, which is a significant cause of ACS. For symptomatic patients with intermediate risk, CTCA is the appropriate investigation.' },
          { text: 'Gated CTPA', nextStep: null, correct: false, feedback: 'Gated CTPA is used for suspected pulmonary embolism with right heart assessment, not for coronary artery disease evaluation.' }
        ]
      },
      {
        id: 's2',
        prompt: 'On arrival, the patient\'s resting heart rate is 74 bpm and regular. Systolic BP is 138 mmHg. He has no known asthma, no heart failure, and no heart block. What is your next step?',
        options: [
          { text: 'Administer oral metoprolol 50–100mg and recheck HR in 1 hour', nextStep: 's3', correct: true, feedback: 'Correct! HR >65 bpm requires beta-blocker preparation. With no contraindications and adequate BP, oral metoprolol is appropriate. Recheck in 1 hour.' },
          { text: 'Proceed directly with Flash acquisition', nextStep: null, correct: false, feedback: 'Flash mode requires HR <60 bpm. At 74 bpm, motion artefact would significantly degrade coronary image quality.' },
          { text: 'Administer IV metoprolol 15mg immediately', nextStep: null, correct: false, feedback: 'Starting with the maximum IV dose is inappropriate. Oral metoprolol first is safer; IV is used for fine-tuning if oral is insufficient.' }
        ]
      },
      {
        id: 's3',
        prompt: 'After metoprolol, HR is now 56 bpm. The blood results show eGFR 42 mL/min. How should you proceed?',
        options: [
          { text: 'Proceed with reduced contrast volume (~20% less) and ensure hydration protocol', nextStep: 's4', correct: true, feedback: 'Correct! eGFR 42 = CKD stage 3b. The scan can proceed, but contrast volume should be reduced by ~20% and pre/post hydration ensured to minimise nephropathy risk.' },
          { text: 'Cancel the scan — eGFR is too low', nextStep: null, correct: false, feedback: 'eGFR 42 is not an absolute contraindication. With contrast volume reduction and hydration, the scan can safely proceed. Cancellation would deny the patient a clinically indicated investigation.' },
          { text: 'Use standard contrast volume — eGFR 42 is fine', nextStep: null, correct: false, feedback: 'eGFR <60 requires precautions. Standard contrast volume increases the risk of contrast-induced nephropathy. Volume reduction and hydration are recommended.' }
        ]
      },
      {
        id: 's4',
        prompt: 'HR is 56 bpm, regular rhythm. Contrast adjusted. Which acquisition mode will you use?',
        options: [
          { text: 'Turbo Flash — HR <60 and regular', nextStep: 'complete', correct: true, feedback: 'Excellent! HR <60 bpm with regular rhythm is ideal for Flash acquisition. This gives the lowest radiation dose and best image quality in a single heartbeat.' },
          { text: 'Adaptive Sequential — safer option', nextStep: null, correct: false, feedback: 'Adaptive Sequential is used for HR 60–65 bpm. At HR 56 with regular rhythm, Flash mode is optimal and delivers lower dose.' },
          { text: 'Retrospective spiral — covers all phases', nextStep: null, correct: false, feedback: 'Retrospective spiral delivers the highest radiation dose and is reserved for high/irregular heart rates where prospective methods would fail.' }
        ]
      },
      {
        id: 'complete',
        prompt: null,
        summary: 'Excellent work! You correctly identified the Coronary Arteries protocol, managed the heart rate with oral beta-blocker, adjusted contrast for renal impairment (CKD 3b), and selected the optimal acquisition mode. This patient received a safe, low-dose, high-quality coronary CTCA.',
        protocolRef: 'coronary_arteries'
      }
    ]
  },
  {
    id: 'case_tavi',
    title: 'TAVI Planning Decision',
    category: 'valve',
    difficulty: 'Intermediate',
    description: 'An 82-year-old woman with severe aortic stenosis is being assessed by the structural heart team for TAVI.',
    steps: [
      {
        id: 's1',
        prompt: 'The structural heart team referral says: "TAVI assessment please. Patient had diagnostic angiography last week — coronaries are normal." Which protocol?',
        options: [
          { text: 'Turbo Flash TAVI (No Coronaries)', nextStep: 's2', correct: true, feedback: 'Correct! Coronaries have already been assessed by catheterisation, so the TAVI protocol without coronary assessment is appropriate. This avoids unnecessary beta-blocker preparation in an elderly patient.' },
          { text: 'TAVI Plus Coronaries', nextStep: null, correct: false, feedback: 'Since coronary arteries were already assessed by catheterisation and found to be normal, adding coronary assessment would mean unnecessary beta-blocker preparation and additional radiation.' },
          { text: 'Standard Coronary CTCA', nextStep: null, correct: false, feedback: 'This patient needs TAVI planning measurements (aortic root, annulus, access routes), not just coronary assessment. The wrong protocol entirely.' }
        ]
      },
      {
        id: 's2',
        prompt: 'The scan is completed. Which of the following is NOT a standard measurement from the TAVI planning CT?',
        options: [
          { text: 'Left ventricular ejection fraction', nextStep: 's3', correct: true, feedback: 'Correct! LVEF is measured by echocardiography, not CT TAVI planning. Key CT measurements include: annulus dimensions (area, perimeter), sinus of Valsalva dimensions, coronary ostial heights, sinotubular junction, and access route diameters.' },
          { text: 'Aortic annulus perimeter and area', nextStep: null, correct: false, feedback: 'Annulus measurements are one of the most critical TAVI CT measurements — they determine prosthesis sizing.' },
          { text: 'Coronary ostial heights above the annulus', nextStep: null, correct: false, feedback: 'Coronary ostial heights are essential — low coronary ostia increase the risk of coronary obstruction during valve deployment.' }
        ]
      },
      {
        id: 's3',
        prompt: 'The iliac artery measurements show the right common iliac is 5.8mm minimum diameter with moderate calcification. The left is 7.2mm with minimal calcification. The proposed valve requires a 14Fr (4.7mm outer diameter) delivery system. What is your assessment?',
        options: [
          { text: 'Left femoral approach preferred — wider lumen and less calcification', nextStep: 'complete', correct: true, feedback: 'Correct! The left iliac artery has adequate diameter (7.2mm > 4.7mm) with minimal calcification. The right side, while technically passable, has more calcification which increases the risk of vascular complications.' },
          { text: 'Both sides are too small — alternative access needed', nextStep: null, correct: false, feedback: 'Both sides have lumens larger than the 4.7mm sheath. The left side at 7.2mm provides comfortable clearance. Vessel size alone does not necessitate alternative access.' },
          { text: 'Right side is preferred because it is the standard approach', nextStep: null, correct: false, feedback: 'While right femoral is conventionally preferred, the left side has a wider lumen and less calcification, making it the safer choice in this patient.' }
        ]
      },
      {
        id: 'complete',
        prompt: null,
        summary: 'Well done! You correctly selected the TAVI (No Coronaries) protocol based on prior catheterisation, identified that LVEF is not a CT measurement, and made an appropriate access route recommendation based on vessel size and calcification.',
        protocolRef: 'tavi_no_coros'
      }
    ]
  },
  {
    id: 'case_ep_mapping',
    title: 'EP Mapping Request',
    category: 'ep',
    difficulty: 'Intermediate',
    description: 'A 45-year-old with drug-refractory paroxysmal atrial fibrillation is scheduled for pulmonary vein isolation ablation.',
    steps: [
      {
        id: 's1',
        prompt: 'The EP team requests: "Pre-ablation CT for CARTO mapping — we plan transseptal access for PVI." Which protocol do you select?',
        options: [
          { text: 'CARTO mapping protocol', nextStep: 's2', correct: true, feedback: 'Correct! The CARTO protocol creates a 3D model of the left atrium and pulmonary veins for import into the CARTO electroanatomical mapping system.' },
          { text: 'Standard Coronary CTCA', nextStep: null, correct: false, feedback: 'Coronary CTCA focuses on coronary artery visualisation, not chamber anatomy. EP mapping requires specific reconstruction parameters for the mapping system import.' },
          { text: 'Gated CTPA', nextStep: null, correct: false, feedback: 'CTPA assesses for pulmonary embolism and right heart function. It does not provide the specific left atrial and pulmonary vein detail needed for ablation planning.' }
        ]
      },
      {
        id: 's2',
        prompt: 'The EP consultant asks: "We may need a retrograde aortic approach as a backup. Should we include the arch?" What is your answer?',
        options: [
          { text: 'Yes — include the aortic arch so the mapping system has anatomical data for retrograde catheter navigation', nextStep: 's3', correct: true, feedback: 'Correct! When a retrograde aortic approach is possible, including the arch provides the mapping system with the anatomical framework needed for catheter navigation through the aortic arch into the left ventricle.' },
          { text: 'No — the arch is never needed for EP mapping', nextStep: null, correct: false, feedback: 'The arch should be included when a retrograde aortic approach is planned. The CARTO protocol has this as a configurable option specifically for this reason.' },
          { text: 'Always include the arch regardless of approach', nextStep: null, correct: false, feedback: 'The arch is only included when a retrograde approach is planned. Including it unnecessarily adds radiation dose without clinical benefit for transseptal-only procedures.' }
        ]
      },
      {
        id: 's3',
        prompt: 'The scan is complete. What key anatomical structures must be clearly visualised for the EP team to plan PVI ablation?',
        options: [
          { text: 'Pulmonary vein number, branching pattern, ostial dimensions, and left atrial anatomy', nextStep: 'complete', correct: true, feedback: 'Correct! The EP team needs: number of pulmonary veins (variants include common ostia), branching patterns, ostial dimensions for catheter selection, and overall left atrial anatomy including any ridges or pouches near the veins.' },
          { text: 'Coronary artery anatomy only', nextStep: null, correct: false, feedback: 'PVI ablation targets the pulmonary vein ostia in the left atrium. While coronary proximity is relevant for safety, the primary structures of interest are the pulmonary veins and left atrium.' },
          { text: 'Aortic valve morphology', nextStep: null, correct: false, feedback: 'Aortic valve assessment is not the purpose of EP mapping CT. The focus is on left atrial and pulmonary vein anatomy for ablation planning.' }
        ]
      },
      {
        id: 'complete',
        prompt: null,
        summary: 'Great work! You correctly selected the CARTO mapping protocol, made the right decision about arch inclusion for retrograde access, and identified the key anatomical structures for PVI ablation planning.',
        protocolRef: 'carto'
      }
    ]
  },
  {
    id: 'case_ecmo',
    title: 'ECMO Patient CT',
    category: 'specialist',
    difficulty: 'Advanced',
    description: 'A 38-year-old on VA-ECMO in the cardiac ICU needs urgent cardiac CT to assess LV recovery.',
    steps: [
      {
        id: 's1',
        prompt: 'The ICU team requests cardiac CT for a patient on VA-ECMO. What is your first critical action before any scan planning?',
        options: [
          { text: 'Confirm perfusionist availability and agree transport plan', nextStep: 's2', correct: true, feedback: 'Correct! An ECMO patient CANNOT be transported to CT without a perfusionist present. The perfusionist manages circuit flows during transport and any required adjustments during scanning.' },
          { text: 'Immediately book the CT scanner slot', nextStep: null, correct: false, feedback: 'Before booking anything, you must confirm perfusionist availability. No perfusionist = no scan. This is a patient safety critical requirement.' },
          { text: 'Order contrast and prepare the standard protocol', nextStep: null, correct: false, feedback: 'ECMO CT requires specific planning around circuit configuration and IV access. Standard protocols are not appropriate without circuit-specific modifications.' }
        ]
      },
      {
        id: 's2',
        prompt: 'The perfusionist is confirmed. For contrast injection, where should the IV cannula be placed?',
        options: [
          { text: 'In a peripheral vein SEPARATE from the ECMO circuit', nextStep: 's3', correct: true, feedback: 'Correct! Contrast must NEVER be injected via the ECMO circuit. The circuit would dilute the bolus and recirculate contrast unpredictably. A separate peripheral IV is essential for reliable contrast timing.' },
          { text: 'Into the ECMO circuit venous line — faster delivery', nextStep: null, correct: false, feedback: 'NEVER inject contrast into the ECMO circuit. The large circuit volume would dilute the contrast bolus, and recirculation would make timing completely unpredictable.' },
          { text: 'It does not matter — any access point is fine', nextStep: null, correct: false, feedback: 'Access point is critical for ECMO patients. Only a separate peripheral IV will give predictable contrast opacification.' }
        ]
      },
      {
        id: 's3',
        prompt: 'The patient is on VA-ECMO with femoral cannulation. For the cardiac CT assessment, the perfusionist can temporarily reduce ECMO flow. Why might this be necessary?',
        options: [
          { text: 'Reduced ECMO flow allows more blood to pass through the heart, improving cardiac opacification', nextStep: 'complete', correct: true, feedback: 'Correct! In VA-ECMO, blood is diverted away from the heart. High ECMO flows mean less blood (and contrast) passes through the cardiac chambers, resulting in poor opacification. Temporary flow reduction allows more contrast to pass through the heart for diagnostic imaging.' },
          { text: 'To save power on the ECMO battery during transport', nextStep: null, correct: false, feedback: 'While battery life matters for transport, flow reduction during scanning is specifically to improve cardiac opacification by allowing more contrast-bearing blood to pass through the heart.' },
          { text: 'ECMO flow should never be adjusted during CT', nextStep: null, correct: false, feedback: 'ECMO flow adjustment is a recognised technique for improving cardiac CT image quality in VA-ECMO patients, done under perfusionist supervision.' }
        ]
      },
      {
        id: 'complete',
        prompt: null,
        summary: 'Excellent! You demonstrated understanding of the critical safety requirements for ECMO CT: perfusionist involvement, separate IV access for contrast, and the rationale for temporary flow reduction in VA-ECMO. These are high-stakes decisions that directly affect patient safety.',
        protocolRef: 'ecmo_ct'
      }
    ]
  }
];

// Protocol to category mapping for learning pages
const protocolCategories = {
  coronary_arteries: 'coronary', calcium_score: 'coronary', grafts: 'coronary',
  tavi_no_coros: 'valve', tavi_plus_coros: 'valve', '4d_valve': 'valve',
  mitral_valve: 'valve', evoque: 'valve', tendyne: 'valve',
  gated_thoracic_aorta: 'aortic', aortic_pears: 'aortic', ross_pears: 'aortic', access_routes: 'aortic',
  carto: 'ep', vivo: 'ep', inheart: 'ep',
  gated_ctpa: 'other', paediatric_cardiac: 'paediatric', ecmo_ct: 'specialist'
};

const categoryLabelsLearn = {
  coronary: 'Coronary', valve: 'Valve', aortic: 'Aortic',
  ep: 'Electrophysiology', other: 'Other', paediatric: 'Paediatric', specialist: 'Specialist'
};

// Category display order
const categoryOrder = ['coronary', 'valve', 'aortic', 'ep', 'other', 'paediatric', 'specialist'];

// ============================================================
// STATE
// ============================================================
let state = {
  protocol: null,
  hr: null,
  bmi: null,
  cath: null,
  arch: null,
  tendyne_bmi: null,
  mitral_bmi: null,
  paed_weight: null,
  ecmo_type: null
};

// Stores browse-view scroll position so we can restore it on back
let browseScrollPos = 0;

// ============================================================
// HASH ROUTER
// ============================================================
function navigateTo(view, options) {
  options = options || {};
  // Save scroll position when leaving views
  const currentView = getCurrentView();
  if (currentView === 'browse') {
    browseScrollPos = window.scrollY;
  } else if (currentView === 'learn') {
    learnScrollPos = window.scrollY;
  }
  location.hash = '/' + view;
  if (options.slideBack) {
    const activeView = document.querySelector('.view.active');
    if (activeView) activeView.classList.add('slide-back');
  }
}

function getCurrentView() {
  const hash = location.hash.slice(2) || 'browse';
  if (hash.startsWith('learn')) return 'learn';
  if (hash.startsWith('detail')) return 'detail';
  if (hash.startsWith('tools')) return 'tools';
  if (hash.startsWith('quiz')) return 'quiz';
  return 'browse';
}

let learnScrollPos = 0;

function renderView() {
  const hash = location.hash.slice(2) || 'browse';

  document.querySelectorAll('.view').forEach(v => {
    v.classList.remove('active', 'no-animate', 'slide-back');
  });

  if (hash === 'browse' || hash === '') {
    const el = document.getElementById('browseView');
    el.classList.add('active', 'slide-back');
    setTimeout(() => window.scrollTo(0, browseScrollPos), 10);
  } else if (hash === 'learn') {
    const el = document.getElementById('learnView');
    el.classList.add('active', 'slide-back');
    renderLearnHub();
    setTimeout(() => window.scrollTo(0, learnScrollPos), 10);
  } else if (hash.startsWith('learn/')) {
    const slug = hash.replace('learn/', '');
    const el = document.getElementById('learnDetailView');
    el.classList.add('active');
    renderLearnDetail(slug);
    window.scrollTo(0, 0);
  } else if (hash.startsWith('detail')) {
    const el = document.getElementById('detailView');
    el.classList.add('active');
    window.scrollTo(0, 0);
  } else if (hash === 'tools') {
    const el = document.getElementById('toolsView');
    el.classList.add('active');
    renderToolsHub();
    window.scrollTo(0, 0);
  } else if (hash === 'quiz') {
    const el = document.getElementById('quizView');
    el.classList.add('active');
    renderQuizHub();
    window.scrollTo(0, 0);
  } else if (hash.startsWith('quiz/case/')) {
    const caseId = hash.replace('quiz/case/', '');
    const el = document.getElementById('quizCaseView');
    el.classList.add('active');
    renderQuizCase(caseId);
    window.scrollTo(0, 0);
  }
}

// Navigate back from learn detail to learn hub
function navigateLearnBack() {
  navigateTo('learn');
}

window.addEventListener('hashchange', renderView);

// On initial load
window.addEventListener('DOMContentLoaded', () => {
  if (!location.hash || location.hash === '#/' || location.hash === '#/browse') {
    location.hash = '/browse';
    const el = document.getElementById('browseView');
    el.classList.add('active', 'no-animate');
  } else {
    renderView();
  }
});

// Back button handler
function goBack() {
  // Clear protocol state
  state.protocol = null;
  state.hr = null; state.bmi = null; state.cath = null; state.arch = null;
  state.tendyne_bmi = null; state.mitral_bmi = null;
  state.paed_weight = null; state.ecmo_type = null;

  // Deselect buttons
  document.querySelectorAll('.indication-btn').forEach(b => b.classList.remove('selected'));
  document.querySelectorAll('.radio-option').forEach(r => r.classList.remove('selected'));
  document.querySelectorAll('.sub-question').forEach(q => q.classList.remove('visible'));
  document.getElementById('subQuestionsSection').style.display = 'none';
  document.getElementById('resultSection').classList.remove('visible');

  // Navigate back to browse
  if (history.length > 1) {
    history.back();
  } else {
    navigateTo('browse');
  }
}

// ============================================================
// UI LOGIC
// ============================================================
function selectIndication(btn) {
  document.querySelectorAll('.indication-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.protocol = btn.dataset.protocol;
  state.hr = null; state.bmi = null; state.cath = null; state.arch = null;
  state.tendyne_bmi = null; state.mitral_bmi = null;
  state.paed_weight = null; state.ecmo_type = null;

  // Hide all sub-questions
  document.querySelectorAll('.sub-question').forEach(q => q.classList.remove('visible'));
  document.querySelectorAll('.radio-option').forEach(r => r.classList.remove('selected'));

  const subSection = document.getElementById('subQuestionsSection');
  const needsSub = showSubQuestions(state.protocol);
  subSection.style.display = needsSub ? 'block' : 'none';

  if (!needsSub) {
    renderProtocol();
  } else {
    document.getElementById('resultSection').classList.remove('visible');
  }

  // Navigate to detail view
  navigateTo('detail');
}

function showSubQuestions(protocol) {
  let needed = false;
  if (protocol === 'coronary_arteries') {
    show('q_hr'); show('q_bmi'); needed = true;
  } else if (protocol === 'grafts') {
    show('q_hr'); needed = true;
  } else if (protocol === 'carto') {
    show('q_arch'); needed = true;
  } else if (protocol === 'tendyne') {
    show('q_tendyne_bmi'); needed = true;
  } else if (protocol === 'mitral_valve') {
    show('q_mitral_bmi'); needed = true;
  } else if (protocol === 'paediatric_cardiac') {
    show('q_paed_weight'); needed = true;
  } else if (protocol === 'ecmo_ct') {
    show('q_ecmo_type'); needed = true;
  }
  return needed;
}

function show(id) {
  document.getElementById(id).classList.add('visible');
}

function selectRadio(el, group) {
  el.parentElement.querySelectorAll('.radio-option').forEach(r => r.classList.remove('selected'));
  el.classList.add('selected');
  state[group] = el.querySelector('input').value;
  tryRender();
}

function tryRender() {
  const p = state.protocol;
  if (p === 'coronary_arteries' && state.hr && state.bmi) renderProtocol();
  else if (p === 'grafts' && state.hr) renderProtocol();
  else if (p === 'carto' && state.arch !== null) renderProtocol();
  else if (p === 'tendyne' && state.tendyne_bmi) renderProtocol();
  else if (p === 'mitral_valve' && state.mitral_bmi) renderProtocol();
  else if (p === 'paediatric_cardiac' && state.paed_weight) renderProtocol();
  else if (p === 'ecmo_ct' && state.ecmo_type) renderProtocol();
}

function resetAll() {
  state = { protocol: null, hr: null, bmi: null, cath: null, arch: null, tendyne_bmi: null, mitral_bmi: null, paed_weight: null, ecmo_type: null };
  document.querySelectorAll('.indication-btn').forEach(b => b.classList.remove('selected'));
  document.querySelectorAll('.radio-option').forEach(r => r.classList.remove('selected'));
  document.querySelectorAll('.sub-question').forEach(q => q.classList.remove('visible'));
  document.getElementById('subQuestionsSection').style.display = 'none';
  document.getElementById('resultSection').classList.remove('visible');
  // Clear clinical query
  document.getElementById('clinicalQueryInput').value = '';
  document.getElementById('queryClearBtn').classList.remove('visible');
  document.getElementById('queryResults').classList.remove('visible');
  document.getElementById('queryResults').innerHTML = '';
  // Navigate back to browse view
  browseScrollPos = 0;
  // Clear checklist session data
  sessionStorage.removeItem('ctca_checklists');
  navigateTo('browse');
}

// ============================================================
// LEARNING CENTRE — RENDERING
// ============================================================
let currentLearnFilter = 'all';
let currentLearnSearch = '';

function renderLearnHub() {
  const grid = document.getElementById('learnCardGrid');
  let html = '';
  let lastCat = '';

  // Build ordered list
  const orderedSlugs = Object.keys(teachingContent).sort((a, b) => {
    const catA = categoryOrder.indexOf(protocolCategories[a]);
    const catB = categoryOrder.indexOf(protocolCategories[b]);
    return catA - catB;
  });

  const searchLower = currentLearnSearch.toLowerCase().trim();

  for (const slug of orderedSlugs) {
    const cat = protocolCategories[slug];
    if (currentLearnFilter !== 'all' && !matchesFilter(cat, currentLearnFilter)) continue;

    const teaching = teachingContent[slug];
    const protocol = protocols[slug];
    if (!teaching || !protocol) continue;

    // Search filter
    if (searchLower) {
      const searchable = (protocol.title + ' ' + teaching.clinicalPurpose.summary + ' ' + teaching.clinicalPurpose.clinicalQuestion + ' ' + (teaching.keyLearningPoints || []).join(' ')).toLowerCase();
      if (!searchable.includes(searchLower)) continue;
    }

    // Category heading (when showing all)
    if (currentLearnFilter === 'all' && cat !== lastCat) {
      html += `<div class="learn-category-heading" style="grid-column:1/-1">${categoryLabelsLearn[cat] || cat}</div>`;
      lastCat = cat;
    }

    html += `<div class="learn-card cat-${cat}" onclick="learnScrollPos=window.scrollY;navigateTo('learn/${slug}')">
      <div class="learn-card-category ind-category">${categoryLabelsLearn[cat] || cat}</div>
      <h3>${protocol.title}</h3>
      <div class="learn-card-summary">${teaching.clinicalPurpose.summary}</div>
      <div class="learn-card-question">"${teaching.clinicalPurpose.clinicalQuestion}"</div>
    </div>`;
  }

  if (!html) {
    html = '<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-light);">No protocols match your search.</div>';
  }

  grid.innerHTML = html;
}

function matchesFilter(cat, filter) {
  if (filter === 'other') return cat === 'other' || cat === 'paediatric' || cat === 'specialist';
  return cat === filter;
}

function filterLearnCategory(cat, btn) {
  currentLearnFilter = cat;
  document.querySelectorAll('.learn-filter-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderLearnHub();
}

function searchLearnContent(term) {
  currentLearnSearch = term;
  renderLearnHub();
}

function renderLearnDetail(slug) {
  const teaching = teachingContent[slug];
  const protocol = protocols[slug];
  const container = document.getElementById('learnDetailContent');

  if (!teaching || !protocol) {
    navigateTo('learn');
    return;
  }

  const cat = protocolCategories[slug];
  let html = '';

  // Header
  html += `<div class="learn-detail-header">
    <div class="learn-detail-category ind-category cat-${cat}">${categoryLabelsLearn[cat] || cat}</div>
    <h2>${protocol.title}</h2>
    <div class="learn-detail-summary">${teaching.clinicalPurpose.summary}</div>
    <div class="learn-detail-question">"${teaching.clinicalPurpose.clinicalQuestion}"</div>
  </div>`;

  // Section nav
  html += `<div class="learn-section-nav">
    <button onclick="scrollToLearnSection('ls-purpose')">Purpose</button>
    <button onclick="scrollToLearnSection('ls-anatomy')">Anatomy</button>
    <button onclick="scrollToLearnSection('ls-keypoints')">Key Points</button>
    <button onclick="scrollToLearnSection('ls-decision')">Decision</button>
    <button onclick="scrollToLearnSection('ls-params')">Parameters</button>
    <button onclick="scrollToLearnSection('ls-evidence')">Evidence</button>
  </div>`;

  // === CLINICAL PURPOSE ===
  let purposeHtml = '';
  purposeHtml += '<h4 style="font-size:0.85rem;color:var(--primary);margin-bottom:10px;">Why is this scan done?</h4>';
  purposeHtml += `<ul class="learn-list">${teaching.clinicalPurpose.whyDone.map(w => `<li>${w}</li>`).join('')}</ul>`;
  if (teaching.clinicalPurpose.patientScenarios && teaching.clinicalPurpose.patientScenarios.length) {
    purposeHtml += '<h4 style="font-size:0.85rem;color:var(--primary);margin-top:16px;margin-bottom:10px;">Example Patient Scenarios</h4>';
    purposeHtml += teaching.clinicalPurpose.patientScenarios.map((s, i) =>
      `<div class="learn-scenario-card"><strong>Scenario ${i + 1}</strong><br>${s}</div>`
    ).join('');
  }
  html += buildLearnSection('ls-purpose', 'Clinical Purpose', purposeHtml, true);

  // === ANATOMY & PATHOLOGY ===
  let anatomyHtml = '';
  anatomyHtml += '<h4 style="font-size:0.85rem;color:var(--primary);margin-bottom:10px;">Structures Assessed</h4>';
  anatomyHtml += `<ul class="learn-list">${teaching.anatomy.structures.map(s => `<li>${s}</li>`).join('')}</ul>`;
  anatomyHtml += '<h4 style="font-size:0.85rem;color:var(--primary);margin-top:16px;margin-bottom:10px;">Pathology to Identify</h4>';
  anatomyHtml += `<ul class="learn-list">${teaching.anatomy.pathology.map(p => `<li>${p}</li>`).join('')}</ul>`;
  html += buildLearnSection('ls-anatomy', 'Anatomy & Pathology', anatomyHtml, false);

  // === KEY LEARNING POINTS ===
  let keypointsHtml = `<ol class="learn-numbered-list">${teaching.keyLearningPoints.map(p => `<li>${p}</li>`).join('')}</ol>`;
  html += buildLearnSection('ls-keypoints', 'Key Learning Points', keypointsHtml, false);

  // === DECISION GUIDE ===
  let decisionHtml = '';
  decisionHtml += `<div class="learn-decision-use"><h4>Use This Protocol When</h4><ul class="learn-list">${teaching.decisionGuide.useWhen.map(u => `<li>${u}</li>`).join('')}</ul></div>`;
  decisionHtml += `<div class="learn-decision-avoid"><h4>Do NOT Use When</h4><ul class="learn-list">${teaching.decisionGuide.doNotUseWhen.map(d => `<li>${d}</li>`).join('')}</ul></div>`;
  if (teaching.decisionGuide.alternatives && teaching.decisionGuide.alternatives.length) {
    decisionHtml += '<h4 style="font-size:0.85rem;color:var(--primary);margin-top:14px;margin-bottom:10px;">Consider Instead</h4>';
    decisionHtml += teaching.decisionGuide.alternatives.map(a => {
      const altProtocol = protocols[a.protocol];
      const altTitle = altProtocol ? altProtocol.title : a.protocol;
      return `<div class="learn-alternative-card" onclick="navigateTo('learn/${a.protocol}')">
        <div><div class="alt-name">${altTitle}</div><div class="alt-reason">${a.reason}</div></div>
      </div>`;
    }).join('');
  }
  html += buildLearnSection('ls-decision', 'Decision Guide', decisionHtml, false);

  // === PARAMETER RATIONALE ===
  let paramsHtml = '';
  if (teaching.parameterRationale.acquisitionMode) {
    paramsHtml += `<div class="learn-rationale-block"><h4>Acquisition Mode</h4><p>${teaching.parameterRationale.acquisitionMode}</p></div>`;
  }
  if (teaching.parameterRationale.contrastProtocol) {
    paramsHtml += `<div class="learn-rationale-block"><h4>Contrast Protocol</h4><p>${teaching.parameterRationale.contrastProtocol}</p></div>`;
  }
  if (teaching.parameterRationale.breathHold) {
    paramsHtml += `<div class="learn-rationale-block"><h4>Breath Hold</h4><p>${teaching.parameterRationale.breathHold}</p></div>`;
  }
  if (teaching.parameterRationale.gating) {
    paramsHtml += `<div class="learn-rationale-block"><h4>ECG Gating</h4><p>${teaching.parameterRationale.gating}</p></div>`;
  }
  if (teaching.parameterRationale.hrControl) {
    paramsHtml += `<div class="learn-rationale-block"><h4>Heart Rate Control</h4><p>${teaching.parameterRationale.hrControl}</p></div>`;
  }
  html += buildLearnSection('ls-params', 'Parameter Rationale', paramsHtml, false);

  // === GUIDELINES & EVIDENCE ===
  let evidenceHtml = '';
  evidenceHtml += teaching.guidelines.references.map(r =>
    `<div class="learn-guideline-card"><div class="guide-name">${r.name}</div><div class="guide-relevance">${r.relevance}</div></div>`
  ).join('');
  evidenceHtml += `<div class="learn-evidence-summary"><strong>Evidence Summary:</strong> ${teaching.guidelines.evidenceSummary}</div>`;
  html += buildLearnSection('ls-evidence', 'Guidelines & Evidence', evidenceHtml, false);

  // CTA — View Protocol Parameters
  html += `<div class="learn-to-protocol-link" onclick="openProtocolFromLearn('${slug}')">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
    View Protocol Parameters
  </div>`;

  container.innerHTML = html;
}

function buildLearnSection(id, title, contentHtml, startOpen) {
  const openClass = startOpen ? ' open' : '';
  const chevron = `<svg class="learn-section-chevron" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
  return `<div class="learn-section${openClass}" id="${id}">
    <div class="learn-section-header" onclick="toggleLearnSection('${id}')">
      <h3>${title}</h3>
      ${chevron}
    </div>
    <div class="learn-section-body">${contentHtml}</div>
  </div>`;
}

function toggleLearnSection(id) {
  const section = document.getElementById(id);
  if (section) section.classList.toggle('open');
}

function scrollToLearnSection(id) {
  const el = document.getElementById(id);
  if (el) {
    // Open it first
    if (!el.classList.contains('open')) el.classList.add('open');
    setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
  }
}

function openProtocolFromLearn(slug) {
  const btn = document.querySelector(`.indication-btn[data-protocol="${slug}"]`);
  if (btn) {
    selectIndication(btn);
  }
}

// ============================================================
// RENDER PROTOCOL
// ============================================================
function renderProtocol() {
  const p = protocols[state.protocol];
  if (!p) return;

  const titleEl = document.getElementById('resultTitle');
  const sysEl = document.getElementById('resultSystemName');
  const bodyEl = document.getElementById('resultBody');

  titleEl.textContent = p.title;

  // System name
  let sysName = p.systemName;
  if (p.getSystemName) {
    if (state.protocol === 'tendyne') sysName = p.getSystemName(state.tendyne_bmi);
    else if (state.protocol === 'mitral_valve') sysName = p.getSystemName(state.mitral_bmi);
  }
  sysEl.textContent = sysName || '';

  let html = '';

  // Verification badge for guideline-based protocols
  if (p.requiresVerification) {
    html += `<div class="verification-badge">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
      ${p.verificationNote}
    </div>`;
  }

  html += '<div class="param-grid">';

  // INDICATIONS
  html += `<div class="param-group">
    <h3>Indications</h3>
    <ul class="recon-list">${p.indications.map(i => `<li>${i}</li>`).join('')}</ul>
    ${p.note ? `<div class="alert-box warning" style="margin-top:10px"><span class="alert-icon">&#9888;</span><span>${p.note}</span></div>` : ''}
  </div>`;

  // PATIENT SETUP
  html += `<div class="param-group">
    <h3>Patient Setup</h3>
    <div class="param-row"><span class="param-label">Position</span><span class="param-value">${p.patientPosition}</span></div>
    ${p.patientPrep ? `<div class="param-row"><span class="param-label">Prep</span><span class="param-value">${p.patientPrep}</span></div>` : ''}
    <div class="param-row"><span class="param-label">Breath Hold</span><span class="param-value">${p.breathHold}</span></div>`;

  if (p.hrControl) {
    html += `<div class="param-row"><span class="param-label">Beta Blockers</span><span class="param-value">${p.hrControl.betaBlockers}</span></div>`;
    if (p.hrControl.gtn !== undefined) {
      html += `<div class="param-row"><span class="param-label">GTN</span><span class="param-value">${p.hrControl.gtn}</span></div>`;
    }
  }
  html += `</div>`;

  // TOPOGRAM & SCOUTS
  html += `<div class="param-group">
    <h3>Topogram & Scouts</h3>
    <div class="param-row"><span class="param-label">Topogram</span><span class="param-value">${p.topogram}</span></div>`;
  if (p.controlScan) html += `<div class="param-row"><span class="param-label">Control Scan</span><span class="param-value">${p.controlScan}</span></div>`;
  if (p.calciumScore) html += `<div class="param-row"><span class="param-label">Calcium Score</span><span class="param-value">${p.calciumScore}</span></div>`;
  if (p.testBolus) {
    html += `<div class="param-row"><span class="param-label">Test Bolus Level</span><span class="param-value">${p.testBolus.level}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Watch</span><span class="param-value">${p.testBolus.watch}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Dynamic Eval</span><span class="param-value">${p.testBolus.dynamicEval}</span></div>`;
  }
  html += `</div>`;

  // ACQUISITION
  html += `<div class="param-group full-width"><h3>Scan Acquisition</h3>`;

  // ── SCAN RANGE & CONTRAST TIMING HIGHLIGHTS ──
  const cm = contrastMetadata[state.protocol];
  let _hlRange = null;
  let _hlDelay = null;

  // Extract scan range from protocol data
  if (state.protocol === 'paediatric_cardiac' && p.getAcquisitionByWeight) {
    _hlRange = 'Weight-dependent — see acquisition parameters below';
  } else if (state.protocol === 'ecmo_ct' && p.getAcquisitionByECMOType) {
    const _ea = p.getAcquisitionByECMOType(state.ecmo_type);
    _hlRange = _ea.range;
    _hlDelay = _ea.timing;
  } else if (p.getAcquisition) {
    const _acq = p.getAcquisition(state.hr);
    _hlRange = _acq.range;
    _hlDelay = _acq.delay;
  } else if (p.acquisition) {
    const _sa = p.acquisition;
    // Multi-range protocols
    const _ranges = [];
    if (_sa.range) _ranges.push(_sa.range);
    if (_sa.ctca) _ranges.push('CTCA: ' + _sa.ctca);
    if (_sa.bodyAngio) _ranges.push('Body Angio: ' + _sa.bodyAngio);
    if (_sa.cardiac) _ranges.push('Cardiac: ' + _sa.cardiac);
    if (_sa.venogram) _ranges.push('Venogram: ' + _sa.venogram);
    if (_sa.arterial && _sa.arterial.range) _ranges.push('Arterial: ' + _sa.arterial.range);
    if (_ranges.length > 0) _hlRange = _ranges.join('<br>');

    // Multi-delay protocols
    const _delays = [];
    if (_sa.delay) _delays.push(_sa.delay);
    if (_sa.ctcaDelay) _delays.push('CTCA: ' + _sa.ctcaDelay);
    if (_sa.bodyAngioDelay) _delays.push('Body Angio: ' + _sa.bodyAngioDelay);
    if (_sa.venogramDelay) _delays.push('Venogram: ' + _sa.venogramDelay);
    if (_sa.delayed) _delays.push('Delayed: ' + _sa.delayed);
    if (_sa.arterial && _sa.arterial.notes) _delays.push('Arterial: ' + _sa.arterial.notes);
    if (_sa.late) _delays.push('Late Enhancement: ' + _sa.late);
    if (_delays.length > 0) _hlDelay = _delays.join('<br>');
  } else if (p.scanRange) {
    _hlRange = p.scanRange;
  }

  // Build the highlight row
  if (_hlRange || (cm && cm.timingDetail)) {
    html += `<div class="highlight-row">`;

    // Scan Range highlight
    if (_hlRange) {
      html += `<div class="scan-range-highlight">
        <span class="hl-icon">📍</span>
        <div class="hl-content">
          <div class="hl-label">Scan Range</div>
          <div class="hl-value">${_hlRange}</div>
        </div>
      </div>`;
    }

    // Contrast Timing highlight
    if (cm && cm.timingDetail) {
      let _timingText = typeof cm.timingDetail === 'function' ? cm.timingDetail(state.hr) : cm.timingDetail;
      html += `<div class="contrast-timing-highlight">
        <span class="hl-icon">⏱️</span>
        <div class="hl-content">
          <div class="hl-label">Contrast Timing — ${cm.phaseType}</div>
          <div class="hl-value">${_timingText}</div>
          ${cm.timingMethod !== 'N/A' ? `<div class="hl-sub">Method: ${cm.timingMethod}</div>` : ''}
        </div>
      </div>`;
    }

    html += `</div>`;
  }

  // Injection Protocol Type highlight
  if (cm && cm.injectionType !== 'Non-Contrast') {
    html += `<div class="injection-type-highlight">
      <span class="hl-icon">💉</span>
      <div class="hl-content">
        <div class="hl-label">Injection Protocol<span class="injection-type-badge ${cm.injectionClass}">${cm.injectionType}</span></div>
        <div class="hl-value">${cm.contrastAgent}${cm.notes ? ` — ${cm.notes}` : ''}</div>
      </div>
    </div>`;
  } else if (cm && cm.injectionType === 'Non-Contrast') {
    html += `<div class="injection-type-highlight" style="border-color:#94a3b8;background:linear-gradient(135deg,#f8fafc,#e2e8f0);">
      <span class="hl-icon">🚫</span>
      <div class="hl-content">
        <div class="hl-label" style="color:#475569;">Injection Protocol<span class="injection-type-badge none">Non-Contrast</span></div>
        <div class="hl-value" style="color:#334155;">${cm.notes}</div>
      </div>
    </div>`;
  }

  // PAEDIATRIC weight-based acquisition
  if (state.protocol === 'paediatric_cardiac' && p.getAcquisitionByWeight) {
    const wacq = p.getAcquisitionByWeight(state.paed_weight);
    html += `<div class="alert-box info" style="margin-bottom:12px"><span class="alert-icon">&#128118;</span><span><strong>${wacq.label}</strong></span></div>`;
    html += `<div class="param-row"><span class="param-label">Tube Voltage</span><span class="param-value">${wacq.kv}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Mode</span><span class="param-value">${wacq.mode}</span></div>`;
    html += `<div class="param-row"><span class="param-label">ECG Gating</span><span class="param-value">${wacq.gating}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Rotation Time</span><span class="param-value">${wacq.rotation}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Contrast Volume</span><span class="param-value">${wacq.contrastVolume}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Flow Rate</span><span class="param-value">${wacq.flowRate}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Saline Chase</span><span class="param-value">${wacq.saline}</span></div>`;
    html += `<div class="param-row"><span class="param-label">DRL</span><span class="param-value">${wacq.drl}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Sedation</span><span class="param-value">${wacq.sedation}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Reconstruction</span><span class="param-value">${wacq.recon}</span></div>`;
    html += `<div class="alert-box info" style="margin-top:10px"><span class="alert-icon">&#8505;</span><span>${wacq.notes}</span></div>`;
  }
  // ECMO type-based acquisition
  else if (state.protocol === 'ecmo_ct' && p.getAcquisitionByECMOType) {
    const eacq = p.getAcquisitionByECMOType(state.ecmo_type);
    html += `<div class="alert-box danger" style="margin-bottom:12px"><span class="alert-icon">&#9888;</span><span><strong>${eacq.label}</strong></span></div>`;
    html += `<div class="param-row"><span class="param-label">Mode</span><span class="param-value">${eacq.mode}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Tube Voltage</span><span class="param-value">${eacq.kv}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Range</span><span class="param-value">${eacq.range}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Contrast Route</span><span class="param-value">${eacq.contrastRoute}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Contrast Volume</span><span class="param-value">${eacq.contrastVolume}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Flow Rate</span><span class="param-value">${eacq.flowRate}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Saline</span><span class="param-value">${eacq.saline}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Timing</span><span class="param-value">${eacq.timing}</span></div>`;
    html += `<div class="alert-box warning" style="margin-top:10px"><span class="alert-icon">&#9888;</span><div><strong>Flow Strategy:</strong> ${eacq.flowStrategy}</div></div>`;
    html += `<div class="alert-box warning" style="margin-top:8px"><span class="alert-icon">&#9888;</span><div><strong>Artifacts:</strong> ${eacq.artifacts}</div></div>`;
    if (eacq.keyNotes && eacq.keyNotes.length > 0) {
      html += `<div class="alert-box danger" style="margin-top:10px"><span class="alert-icon">&#9888;</span><div><strong>Key Notes:</strong><ul class="recon-list" style="margin-top:6px">${eacq.keyNotes.map(n => `<li>${n}</li>`).join('')}</ul></div></div>`;
    }
  }
  else if (p.getAcquisition) {
    const acq = p.getAcquisition(state.hr);
    html += `<div class="param-row"><span class="param-label">Mode</span><span class="param-value">${acq.badge || ''} ${acq.mode}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Range</span><span class="param-value">${acq.range}</span></div>`;
    html += `<div class="param-row"><span class="param-label">Delay</span><span class="param-value">${acq.delay}</span></div>`;
    if (acq.trigger) html += `<div class="param-row"><span class="param-label">Trigger</span><span class="param-value">${acq.trigger}</span></div>`;
  } else if (p.acquisition) {
    const acq = p.acquisition;
    if (acq.mode) html += `<div class="param-row"><span class="param-label">Mode</span><span class="param-value">${acq.mode}</span></div>`;
    if (acq.range) html += `<div class="param-row"><span class="param-label">Range</span><span class="param-value">${acq.range}</span></div>`;
    if (acq.cardiac) html += `<div class="param-row"><span class="param-label">Cardiac</span><span class="param-value">${acq.cardiac}</span></div>`;
    if (acq.ctca) html += `<div class="param-row"><span class="param-label">CTCA</span><span class="param-value">${acq.ctca}</span></div>`;
    if (acq.ctcaDelay) html += `<div class="param-row"><span class="param-label">CTCA Delay</span><span class="param-value">${acq.ctcaDelay}</span></div>`;
    if (acq.delay) html += `<div class="param-row"><span class="param-label">Delay</span><span class="param-value">${acq.delay}</span></div>`;
    if (acq.bodyAngio) html += `<div class="param-row"><span class="param-label">Body Angio</span><span class="param-value">${acq.bodyAngio}</span></div>`;
    if (acq.bodyAngioDelay) html += `<div class="param-row"><span class="param-label">Body Angio Delay</span><span class="param-value">${acq.bodyAngioDelay}</span></div>`;
    if (acq.recons) html += `<div class="param-row"><span class="param-label">Recon Layout</span><span class="param-value">${acq.recons}</span></div>`;
    if (acq.venogram) html += `<div class="param-row"><span class="param-label">Venogram</span><span class="param-value">${acq.venogram}</span></div>`;
    if (acq.venogramDelay) html += `<div class="param-row"><span class="param-label">Venogram Delay</span><span class="param-value">${acq.venogramDelay}</span></div>`;
    if (acq.delayed) html += `<div class="param-row"><span class="param-label">Delayed Scan</span><span class="param-value">${acq.delayed}</span></div>`;
    if (acq.lowDoseThorax) html += `<div class="param-row"><span class="param-label">Low Dose Thorax</span><span class="param-value">${acq.lowDoseThorax}</span></div>`;

    if (acq.notes) {
      const notes = Array.isArray(acq.notes) ? acq.notes : [acq.notes];
      html += `<div class="alert-box info" style="margin-top:10px"><span class="alert-icon">&#8505;</span><div>${notes.map(n => `<div>${n}</div>`).join('')}</div></div>`;
    }
    if (acq.cardiacNotes) {
      html += `<div class="alert-box info" style="margin-top:10px"><span class="alert-icon">&#8505;</span><div>${acq.cardiacNotes.map(n => `<div>${n}</div>`).join('')}</div></div>`;
    }
    if (acq.important) {
      html += `<div class="alert-box danger" style="margin-top:10px"><span class="alert-icon">&#9888;</span><span>${acq.important}</span></div>`;
    }
    if (acq.exstentNotes) {
      html += `<div class="alert-box warning" style="margin-top:10px"><span class="alert-icon">&#9733;</span><div><strong>Exstent Requirements:</strong><ul class="recon-list" style="margin-top:6px">${acq.exstentNotes.map(n => `<li>${n}</li>`).join('')}</ul></div></div>`;
    }

    // INHEART special
    if (acq.arterial) {
      html += `<div class="param-row"><span class="param-label">Arterial Mode</span><span class="param-value">${acq.arterial.mode}</span></div>`;
      html += `<div class="param-row"><span class="param-label">Arterial Range</span><span class="param-value">${acq.arterial.range}</span></div>`;
      html += `<div class="param-row"><span class="param-label">Notes</span><span class="param-value">${acq.arterial.notes}</span></div>`;
      html += `<div class="param-row"><span class="param-label">Late Enhanced</span><span class="param-value">${acq.late}</span></div>`;
    }
  }

  // CARTO arch modification
  if (state.protocol === 'carto' && state.arch === 'yes') {
    const archMod = p.getAcquisitionArch('yes');
    if (archMod) {
      html += `<div class="alert-box warning" style="margin-top:10px"><span class="alert-icon">&#9888;</span><span><strong>Arch included:</strong> Scan range from ${archMod.range}. ${archMod.note}</span></div>`;
    }
  }

  html += `</div>`;

  // INJECTION PROTOCOL
  html += `<div class="param-group full-width"><h3>Injection Protocol</h3>`;

  let inj = p.injection;
  if (p.getInjection) {
    if (state.protocol === 'coronary_arteries') inj = p.getInjection(state.bmi);
    else if (state.protocol === 'tendyne') inj = p.getInjection(state.tendyne_bmi);
  }

  if (inj) {
    if (inj.protocolName) html += `<div class="param-row"><span class="param-label">Protocol</span><span class="param-value">${inj.protocolName}</span></div>`;
    if (inj.contrast) html += `<div class="param-row"><span class="param-label">Contrast</span><span class="param-value">${inj.contrast}</span></div>`;
    if (inj.saline) html += `<div class="param-row"><span class="param-label">Saline</span><span class="param-value">${inj.saline}</span></div>`;
    if (inj.note) html += `<div class="alert-box info" style="margin-top:8px;margin-bottom:8px"><span class="alert-icon">&#8505;</span><span>${inj.note}</span></div>`;

    if (inj.testBolus) {
      html += `<table class="injection-table"><thead><tr><th colspan="2">Test Bolus</th></tr><tr><th>Rate</th><th>Volume</th></tr></thead><tbody>`;
      inj.testBolus.forEach(r => { html += `<tr><td>${r.rate}</td><td>${r.volume}</td></tr>`; });
      html += `</tbody></table>`;
    }
    if (inj.scan) {
      html += `<table class="injection-table" style="margin-top:10px"><thead><tr><th colspan="2">Scan Injection</th></tr><tr><th>Rate</th><th>Volume</th></tr></thead><tbody>`;
      inj.scan.forEach(r => { html += `<tr><td>${r.rate}</td><td>${r.volume}</td></tr>`; });
      html += `</tbody></table>`;
    }

    html += `<div class="alert-box info" style="margin-top:10px"><span class="alert-icon">&#8505;</span><span>Cannula size and position should be considered when selecting the flow rate.</span></div>`;
  }

  // Congenital injection for grafts
  if (p.congenitalInjection) {
    const ci = p.congenitalInjection;
    html += `<div class="alert-box warning" style="margin-top:12px"><span class="alert-icon">&#9888;</span><div><strong>${ci.note}</strong><br>Protocol: ${ci.protocolName} | Contrast: ${ci.contrast} | Saline: ${ci.saline}</div></div>`;
    if (ci.scan) {
      html += `<table class="injection-table" style="margin-top:8px"><thead><tr><th colspan="2">Congenital Scan Injection</th></tr><tr><th>Rate</th><th>Volume</th></tr></thead><tbody>`;
      ci.scan.forEach(r => { html += `<tr><td>${r.rate}</td><td>${r.volume}</td></tr>`; });
      html += `</tbody></table>`;
    }
  }

  html += `</div>`;

  // DOSE
  if (p.dose && p.dose.length > 0) {
    html += `<div class="param-group"><h3>Dose Reference Levels</h3>`;
    html += `<table class="injection-table"><thead><tr><th>Protocol</th><th>CTDIvol</th><th>DLP</th></tr></thead><tbody>`;
    p.dose.forEach(d => {
      html += `<tr><td>${d.name}${d.weight ? ` (${d.weight})` : ''}</td><td>${d.ctdi}</td><td>${d.dlp}</td></tr>`;
    });
    html += `</tbody></table>`;
    if (p.individualDRL) html += `<div style="margin-top:8px;font-size:0.8rem;color:var(--text-light)">Individual DRLs available</div>`;
    html += `</div>`;
  }

  // DEVIATIONS
  if (p.deviations && p.deviations.length > 0) {
    html += `<div class="param-group"><h3>Possible Deviations</h3>
      <ul class="deviations-list">${p.deviations.map(d => `<li>${d}</li>`).join('')}</ul>
    </div>`;
  }

  // RECONSTRUCTIONS
  if (p.reconstructions && p.reconstructions.length > 0) {
    html += `<div class="param-group full-width"><h3>Reconstructions</h3>
      <ul class="recon-list">${p.reconstructions.map(r => `<li>${r}</li>`).join('')}</ul>
    </div>`;
  }

  // POST CARE
  if (p.postCare) {
    html += `<div class="param-group full-width"><h3>Post Patient Care</h3>
      <div class="alert-box warning"><span class="alert-icon">&#9888;</span><span>${p.postCare}</span></div>
    </div>`;
  }

  html += '</div>';

  // "Why this protocol?" link to learning page
  if (teachingContent[state.protocol]) {
    html += `<div class="learn-why-link" onclick="navigateTo('learn/${state.protocol}')">
      <div class="why-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      </div>
      <div class="why-text">
        <strong>Why this protocol?</strong>
        <span>Learn about the clinical rationale and key decisions</span>
      </div>
    </div>`;
  }

  // Scan checklists
  html += renderChecklistSection(state.protocol);

  bodyEl.innerHTML = html;

  const resultSection = document.getElementById('resultSection');
  resultSection.classList.add('visible');
  // Smooth scroll to protocol card within the detail view
  setTimeout(() => resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
}

// ============================================================
// CLINICAL TOOLS HUB
// ============================================================
let activeToolId = null;

function renderToolsHub() {
  const grid = document.getElementById('toolsCardGrid');
  const tools = [
    { id: 'contrast', title: 'Contrast Volume Calculator', desc: 'Recommended contrast volume adjusted for protocol and renal function', icon: '💉' },
    { id: 'betablocker', title: 'Beta-Blocker Dosing', desc: 'Dosing recommendations based on HR, BP, and contraindications', icon: '💊' },
    { id: 'egfr', title: 'eGFR & Renal Risk', desc: 'CKD-EPI 2021 equation with CKD staging and hydration advice', icon: '🧪' },
    { id: 'radiation', title: 'Radiation Dose Estimator', desc: 'Estimated dose with chest X-ray and background radiation comparisons', icon: '☢️' },
    { id: 'contrastref', title: 'Contrast Protocol Reference', desc: 'Injection types, timing methods, and protocol-specific contrast guidance', icon: '📋' }
  ];
  grid.innerHTML = tools.map(t => `
    <div class="tool-card ${activeToolId === t.id ? 'active' : ''}" onclick="selectTool('${t.id}')">
      <div class="tool-icon">${t.icon}</div>
      <h3>${t.title}</h3>
      <p>${t.desc}</p>
    </div>
  `).join('');
  if (activeToolId) renderActiveTool(activeToolId);
  else document.getElementById('toolActiveContent').innerHTML = '';
}

function selectTool(id) {
  activeToolId = id;
  renderToolsHub();
}

function renderActiveTool(id) {
  const c = document.getElementById('toolActiveContent');
  if (id === 'contrast') c.innerHTML = renderContrastCalc();
  else if (id === 'betablocker') c.innerHTML = renderBetaBlockerGuide();
  else if (id === 'egfr') c.innerHTML = renderEgfrCalc();
  else if (id === 'radiation') c.innerHTML = renderRadiationCalc();
  else if (id === 'contrastref') c.innerHTML = renderContrastReference();
  setTimeout(() => c.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

// --- Contrast Calculator ---
function renderContrastCalc() {
  const opts = Object.keys(protocols).map(k =>
    `<option value="${k}">${protocols[k].title}</option>`
  ).join('');
  return `<div class="calc-section">
    <h3>💉 Contrast Volume Calculator</h3>
    <div class="calc-row">
      <div class="calc-form-group"><label>Patient Weight (kg)</label><input class="calc-input" type="number" id="ccWeight" placeholder="e.g. 70" min="20" max="250"></div>
      <div class="calc-form-group"><label>eGFR (mL/min)</label><input class="calc-input" type="number" id="ccEgfr" placeholder="e.g. 60" min="5" max="150"></div>
    </div>
    <div class="calc-form-group"><label>Protocol</label><select class="calc-select" id="ccProtocol">${opts}</select></div>
    <button class="calc-btn" onclick="calculateContrast()">Calculate</button>
    <div class="calc-result" id="ccResult"></div>
  </div>`;
}

function calculateContrast() {
  const weight = parseFloat(document.getElementById('ccWeight').value);
  const egfr = parseFloat(document.getElementById('ccEgfr').value);
  const pk = document.getElementById('ccProtocol').value;
  if (!weight || !egfr) { alert('Please enter weight and eGFR'); return; }
  const p = protocols[pk];
  let baseVol = 0, flowRate = '', saline = '';
  // Try to extract from injection data
  let inj = p.injection;
  if (p.getInjection) inj = p.getInjection('20-28');
  if (inj && inj.scan) {
    inj.scan.forEach(row => {
      const txt = (row.contrast || row.volume || '').toString().toLowerCase();
      const m = txt.match(/([\d.]+)\s*ml/);
      if (m) baseVol += parseFloat(m[1]);
      const rm = txt.match(/([\d.]+)\s*ml\/s/);
      if (rm && !flowRate) flowRate = rm[1] + ' mL/s';
    });
    if (inj.scan.length > 0) {
      const lastRow = inj.scan[inj.scan.length - 1];
      const salTxt = (lastRow.contrast || lastRow.volume || '').toString().toLowerCase();
      if (salTxt.includes('saline')) {
        const sm = salTxt.match(/([\d.]+)\s*ml/);
        if (sm) saline = sm[1] + ' mL';
      }
    }
  }
  if (baseVol === 0) baseVol = Math.round(weight * 1.0);
  let adjVol = baseVol, warning = '';
  if (egfr >= 30 && egfr < 60) {
    adjVol = Math.round(baseVol * 0.8);
    warning = `<div class="calc-warning">⚠️ <strong>eGFR ${Math.round(egfr)} (CKD stage 3):</strong> Contrast volume reduced by 20%. Ensure pre- and post-hydration protocol (IV NaCl 0.9% 1 mL/kg/hr for 6–12 hours).</div>`;
  } else if (egfr < 30) {
    adjVol = Math.round(baseVol * 0.6);
    warning = `<div class="calc-danger">🚨 <strong>eGFR ${Math.round(egfr)} (CKD stage 4/5):</strong> HIGH RISK for contrast-induced nephropathy. Discuss with reporting consultant. Consider alternative imaging. If proceeding: aggressive hydration mandatory.</div>`;
  }
  const r = document.getElementById('ccResult');
  r.className = 'calc-result visible';
  r.innerHTML = `<h4>Results for ${p.title}</h4>
    <div class="calc-result-row"><span class="calc-result-label">Base contrast volume</span><span class="calc-result-value">${baseVol} mL</span></div>
    <div class="calc-result-row"><span class="calc-result-label">Adjusted volume</span><span class="calc-result-value" style="color:var(--accent);font-size:1.1rem;">${adjVol} mL</span></div>
    ${flowRate ? `<div class="calc-result-row"><span class="calc-result-label">Flow rate</span><span class="calc-result-value">${flowRate}</span></div>` : ''}
    ${saline ? `<div class="calc-result-row"><span class="calc-result-label">Saline chase</span><span class="calc-result-value">${saline}</span></div>` : ''}
    <div class="calc-result-row"><span class="calc-result-label">Patient weight</span><span class="calc-result-value">${weight} kg</span></div>
    <div class="calc-result-row"><span class="calc-result-label">Contrast-to-weight ratio</span><span class="calc-result-value">${(adjVol/weight).toFixed(1)} mL/kg</span></div>
    ${warning}`;
}

// --- Beta-Blocker Dosing Guide ---
function renderBetaBlockerGuide() {
  return `<div class="calc-section">
    <h3>💊 Beta-Blocker Dosing Guide</h3>
    <div class="calc-row">
      <div class="calc-form-group"><label>Current Heart Rate (bpm)</label><input class="calc-input" type="number" id="bbHr" placeholder="e.g. 72" min="30" max="200"></div>
      <div class="calc-form-group"><label>Systolic BP (mmHg)</label><input class="calc-input" type="number" id="bbSbp" placeholder="e.g. 130" min="60" max="250"></div>
    </div>
    <div class="calc-form-group"><label style="margin-bottom:10px;">Contraindications (check all that apply)</label>
      <div class="calc-contra-grid">
        <label class="calc-contra-item"><input type="checkbox" id="bbAsthma"> Asthma / severe COPD</label>
        <label class="calc-contra-item"><input type="checkbox" id="bbBrady"> Severe bradycardia (&lt;50)</label>
        <label class="calc-contra-item"><input type="checkbox" id="bbBlock"> 2nd/3rd degree heart block</label>
        <label class="calc-contra-item"><input type="checkbox" id="bbHf"> Decompensated heart failure</label>
      </div>
    </div>
    <button class="calc-btn" onclick="calculateBetaBlocker()">Get Recommendation</button>
    <div class="calc-result" id="bbResult"></div>
  </div>`;
}

function calculateBetaBlocker() {
  const hr = parseInt(document.getElementById('bbHr').value);
  const sbp = parseInt(document.getElementById('bbSbp').value);
  if (!hr || !sbp) { alert('Please enter heart rate and systolic BP'); return; }
  const contras = [];
  if (document.getElementById('bbAsthma').checked) contras.push('Asthma / severe COPD');
  if (document.getElementById('bbBrady').checked) contras.push('Severe bradycardia');
  if (document.getElementById('bbBlock').checked) contras.push('2nd/3rd degree heart block');
  if (document.getElementById('bbHf').checked) contras.push('Decompensated heart failure');
  const r = document.getElementById('bbResult');
  r.className = 'calc-result visible';
  if (contras.length > 0) {
    r.innerHTML = `<div class="calc-danger">🚫 <strong>DO NOT ADMINISTER BETA-BLOCKER</strong><br>Contraindication(s) identified:<ul style="margin:8px 0 0 16px;">${contras.map(c => `<li>${c}</li>`).join('')}</ul><br>Consider alternative HR control strategies or proceed with higher HR acquisition mode (Adaptive Sequential or Systolic).</div>`;
    return;
  }
  let html = '';
  if (hr < 60) {
    html = `<h4>Recommendation</h4>
      <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:14px;color:#166534;font-size:0.9rem;">
      ✅ <strong>No beta-blocker needed.</strong> HR ${hr} bpm is within target range (&lt;60 bpm). Flash acquisition can be used if rhythm is regular.</div>`;
  } else if (hr >= 60 && hr <= 65) {
    html = `<h4>Recommendation</h4>
      <div style="background:#fefce8;border:1px solid #fde68a;border-radius:8px;padding:14px;color:#854d0e;font-size:0.9rem;">
      ⚠️ <strong>HR ${hr} bpm — borderline.</strong> Consider oral metoprolol 25–50mg if rhythm is irregular. Adaptive Sequential acquisition may be suitable. Recheck HR before scanning.</div>`;
  } else {
    html = `<h4>Recommendation</h4>`;
    if (sbp < 100) {
      html += `<div class="calc-warning">⚠️ <strong>Caution: Systolic BP ${sbp} mmHg is low.</strong> Start with lower oral dose (25mg) and monitor closely. Avoid IV beta-blocker.</div>`;
    }
    html += `<div class="calc-result-row"><span class="calc-result-label">Oral route (preferred)</span><span class="calc-result-value">Metoprolol 50–100mg PO, 1hr pre-scan</span></div>
      <div class="calc-result-row"><span class="calc-result-label">IV route (if oral insufficient)</span><span class="calc-result-value">Metoprolol 5mg IV, repeat q5min (max 15mg)</span></div>
      <div class="calc-result-row"><span class="calc-result-label">Target HR</span><span class="calc-result-value">&lt;60 bpm, regular rhythm</span></div>
      <div class="calc-result-row"><span class="calc-result-label">Monitor</span><span class="calc-result-value">BP and HR before, during, and after administration</span></div>
      <div style="margin-top:12px;font-size:0.82rem;color:var(--text-light);">
        Also consider sublingual GTN 400μg × 2 sprays (if SBP &gt;100mmHg) for coronary vasodilation, administered 3–5 minutes before scan.
      </div>`;
  }
  r.innerHTML = html;
}

// --- eGFR Calculator ---
function renderEgfrCalc() {
  return `<div class="calc-section">
    <h3>🧪 eGFR & Renal Risk Calculator</h3>
    <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:16px;">CKD-EPI 2021 (race-free equation)</p>
    <div class="calc-row">
      <div class="calc-form-group"><label>Serum Creatinine (μmol/L)</label><input class="calc-input" type="number" id="egfrCreat" placeholder="e.g. 90" min="20" max="2000"></div>
      <div class="calc-form-group"><label>Age (years)</label><input class="calc-input" type="number" id="egfrAge" placeholder="e.g. 55" min="18" max="110"></div>
    </div>
    <div class="calc-form-group"><label>Sex</label>
      <select class="calc-select" id="egfrSex"><option value="male">Male</option><option value="female">Female</option></select>
    </div>
    <button class="calc-btn" onclick="calculateEgfr()">Calculate eGFR</button>
    <div class="calc-result" id="egfrResult"></div>
  </div>`;
}

function calculateEgfr() {
  const creat = parseFloat(document.getElementById('egfrCreat').value);
  const age = parseInt(document.getElementById('egfrAge').value);
  const sex = document.getElementById('egfrSex').value;
  if (!creat || !age) { alert('Please enter creatinine and age'); return; }
  const kappa = CKD_EPI.kappa[sex];
  const alpha = CKD_EPI.alpha[sex];
  const sexC = CKD_EPI.sexCoeff[sex];
  const creatMgDl = creat / 88.4;
  const minR = Math.min(creatMgDl / kappa, 1);
  const maxR = Math.max(creatMgDl / kappa, 1);
  const egfr = Math.round(142 * Math.pow(minR, alpha) * Math.pow(maxR, -1.200) * Math.pow(0.9938, age) * sexC);
  let stage, risk, hydration = '';
  if (egfr >= 90) { stage = 'G1 (Normal)'; risk = 'low'; }
  else if (egfr >= 60) { stage = 'G2 (Mildly decreased)'; risk = 'low'; }
  else if (egfr >= 45) { stage = 'G3a (Mild-moderate)'; risk = 'moderate'; hydration = 'Pre/post hydration: IV NaCl 0.9% at 1 mL/kg/hr for 6–12 hours. Reduce contrast volume by ~20%.'; }
  else if (egfr >= 30) { stage = 'G3b (Moderate-severe)'; risk = 'moderate'; hydration = 'Pre/post hydration: IV NaCl 0.9% at 1 mL/kg/hr for 6–12 hours. Reduce contrast volume by ~20%. Close monitoring of renal function post-procedure.'; }
  else if (egfr >= 15) { stage = 'G4 (Severe)'; risk = 'high'; hydration = 'HIGH RISK: Discuss with nephrologist. Aggressive IV hydration mandatory if proceeding. Consider withholding nephrotoxic drugs 48hrs pre/post. Check creatinine at 48–72hrs.'; }
  else { stage = 'G5 (Kidney failure)'; risk = 'high'; hydration = 'CRITICAL: Discuss with nephrologist urgently. Consider alternative non-contrast imaging. If contrast essential: dialysis coordination may be required.'; }
  const r = document.getElementById('egfrResult');
  r.className = 'calc-result visible';
  r.innerHTML = `<h4>Results</h4>
    <div class="calc-result-row"><span class="calc-result-label">Estimated GFR</span><span class="calc-result-value" style="font-size:1.2rem;">${egfr} mL/min/1.73m²</span></div>
    <div class="calc-result-row"><span class="calc-result-label">CKD Stage</span><span class="calc-result-value">${stage}</span></div>
    <div class="calc-result-row"><span class="calc-result-label">Contrast Risk</span><span class="calc-result-value"><span class="risk-badge ${risk}">${risk}</span></span></div>
    ${hydration ? `<div style="margin-top:12px;padding:12px 16px;background:${risk==='high'?'#fef2f2':'#fefce8'};border-radius:8px;font-size:0.85rem;color:${risk==='high'?'#991b1b':'#854d0e'};line-height:1.5;">
      <strong>${risk==='high'?'🚨':'⚠️'} Hydration Protocol:</strong> ${hydration}</div>` : ''}`;
}

// --- Radiation Dose Estimator ---
function renderRadiationCalc() {
  const opts = Object.keys(protocols).filter(k => protocols[k].dose && protocols[k].dose.length > 0)
    .map(k => `<option value="${k}">${protocols[k].title}</option>`).join('');
  return `<div class="calc-section">
    <h3>☢️ Radiation Dose Estimator</h3>
    <div class="calc-form-group"><label>Protocol</label><select class="calc-select" id="radProtocol">${opts}</select></div>
    <div class="calc-form-group"><label>Patient BMI Category</label>
      <select class="calc-select" id="radBmi">
        <option value="lt20">&lt;20 (Small)</option>
        <option value="20-28" selected>20–28 (Average)</option>
        <option value="28-30">28–30 (Above average)</option>
        <option value="gt30">&gt;30 (Large)</option>
      </select>
    </div>
    <button class="calc-btn" onclick="calculateRadiation()">Estimate Dose</button>
    <div class="calc-result" id="radResult"></div>
  </div>`;
}

function calculateRadiation() {
  const pk = document.getElementById('radProtocol').value;
  const bmiCat = document.getElementById('radBmi').value;
  const p = protocols[pk];
  if (!p.dose || p.dose.length === 0) return;
  let totalDlp = 0;
  p.dose.forEach(d => {
    const dlpStr = (d.dlp || '').toString();
    const m = dlpStr.match(/([\d.]+)/);
    if (m) totalDlp += parseFloat(m[1]);
  });
  const bmiFactors = { 'lt20': 0.7, '20-28': 1.0, '28-30': 1.3, 'gt30': 1.6 };
  const adjDlp = Math.round(totalDlp * (bmiFactors[bmiCat] || 1.0));
  const effDose = (adjDlp * DOSE_CONSTANTS.kChest).toFixed(1);
  const xrayEquiv = Math.round(effDose / DOSE_CONSTANTS.chestXrayMsv);
  const bgDays = Math.round((effDose / DOSE_CONSTANTS.bgMsvYear) * 365);
  const r = document.getElementById('radResult');
  r.className = 'calc-result visible';
  r.innerHTML = `<h4>Dose Estimate for ${p.title}</h4>
    <div class="calc-result-row"><span class="calc-result-label">Reference DLP</span><span class="calc-result-value">${totalDlp} mGy·cm</span></div>
    <div class="calc-result-row"><span class="calc-result-label">BMI-adjusted DLP</span><span class="calc-result-value">${adjDlp} mGy·cm</span></div>
    <div class="calc-result-row"><span class="calc-result-label">Estimated effective dose</span><span class="calc-result-value" style="font-size:1.1rem;color:var(--accent);">${effDose} mSv</span></div>
    <div class="calc-result-row"><span class="calc-result-label">Chest X-ray equivalent</span><span class="calc-result-value">≈ ${xrayEquiv} chest X-rays</span></div>
    <div class="calc-result-row"><span class="calc-result-label">Background radiation equivalent</span><span class="calc-result-value">≈ ${bgDays} days of natural background</span></div>
    <div style="margin-top:12px;font-size:0.78rem;color:var(--text-light);line-height:1.5;">
      Note: This is an estimate based on diagnostic reference levels. Actual dose depends on scanner settings, scan range, and patient habitus. Individual DRLs should be verified on the scanner console.
    </div>`;
}

// --- Contrast Protocol Reference ---
function renderContrastReference() {
  // Build protocol-to-injection-type lookup table
  const injTypeRows = Object.keys(contrastMetadata).map(pk => {
    const cm = contrastMetadata[pk];
    const p = protocols[pk];
    if (!p) return '';
    return `<tr>
      <td style="font-weight:600;">${p.title}</td>
      <td><span class="injection-type-badge ${cm.injectionClass}" style="font-size:0.68rem;">${cm.injectionType}</span></td>
      <td>${cm.phaseType}</td>
      <td style="font-size:0.82rem;">${typeof cm.timingDetail === 'function' ? cm.timingDetail(65) : cm.timingDetail}</td>
    </tr>`;
  }).join('');

  return `<div class="calc-section">
    <h3>📋 Contrast Protocol Reference Guide</h3>
    <p style="color:var(--text-light);font-size:0.88rem;margin-bottom:20px;">
      This reference guide documents all contrast injection protocol types and timing methods used at the Royal Brompton.
    </p>

    <h4 style="color:var(--primary);margin:20px 0 12px;font-size:0.95rem;">Injection Protocol Types</h4>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
      <div style="background:#f0fdf4;border-left:4px solid #22c55e;padding:12px 16px;border-radius:6px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="injection-type-badge standard">Standard Cardiac</span>
        </div>
        <div style="font-size:0.85rem;color:#334155;line-height:1.5;">
          <strong>Typical volume:</strong> 80–100 ml Iomeron 400 (BMI-dependent).<br>
          <strong>Used for:</strong> Coronary arteries, grafts, mitral valve, TAVI + coros, 4D valve, tendyne, thoracic aorta, PEARS, CARTO.<br>
          <strong>Method:</strong> Single-phase bolus with saline chase. Flow rate 5–6 ml/s via antecubital 18G cannula. Standard test bolus evaluation.
        </div>
      </div>

      <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:12px 16px;border-radius:6px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="injection-type-badge long-injection">Long Injection</span>
        </div>
        <div style="font-size:0.85rem;color:#334155;line-height:1.5;">
          <strong>Typical volume:</strong> 120–150 ml Iomeron 400.<br>
          <strong>Used for:</strong> EVOQUE, VIVO, Gated CTPA, congenital heart patients requiring R+L heart + coronaries.<br>
          <strong>Method:</strong> Extended injection duration for sustained opacification of both right and left heart chambers. Higher total contrast volume to maintain enhancement throughout longer acquisition windows. Essential for protocols requiring simultaneous arterial and venous opacification.
        </div>
      </div>

      <div style="background:#fdf2f8;border-left:4px solid #ec4899;padding:12px 16px;border-radius:6px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="injection-type-badge bastion-wheel">Bastion Wheel</span>
        </div>
        <div style="font-size:0.85rem;color:#334155;line-height:1.5;">
          <strong>Typical volume:</strong> 100–150 ml Iomeron 400 (per chart).<br>
          <strong>Used for:</strong> Ross PEARS, INHEART.<br>
          <strong>Method:</strong> Injection parameters determined from the Bastion Wheel chart based on patient weight, scan duration, and desired enhancement. Uses fixed delay timing (e.g. 70–80 seconds) rather than test bolus. Provides optimised contrast timing for complex multi-phase acquisitions including late myocardial enhancement.
        </div>
      </div>

      <div style="background:#f5f3ff;border-left:4px solid #8b5cf6;padding:12px 16px;border-radius:6px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="injection-type-badge erasmus">Erasmus</span>
        </div>
        <div style="font-size:0.85rem;color:#334155;line-height:1.5;">
          <strong>Typical volume:</strong> Variable (split-bolus technique).<br>
          <strong>Used for:</strong> Not currently standard at Brompton — available as alternative for combined arterial + portal venous phase imaging.<br>
          <strong>Method:</strong> Split-bolus (biphasic) injection technique originating from Erasmus MC. First bolus for portal venous/parenchymal phase, followed by second bolus for arterial phase. Allows single-acquisition combined arterial and portal venous imaging, reducing total contrast volume and scan passes. Particularly useful when both vascular and parenchymal enhancement are required simultaneously.
        </div>
      </div>

      <div style="background:#fffbeb;border-left:4px solid #f59e0b;padding:12px 16px;border-radius:6px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="injection-type-badge flash">Flash</span>
        </div>
        <div style="font-size:0.85rem;color:#334155;line-height:1.5;">
          <strong>Typical volume:</strong> 100 ml Iomeron 400 (triphasic).<br>
          <strong>Used for:</strong> TAVI (no coronaries), Access Routes.<br>
          <strong>Method:</strong> Three-phase injection: initial slow bolus (3 ml/s), followed by main contrast phase (5–6 ml/s), then saline chase. Optimised for flash (high-pitch spiral) acquisition requiring rapid, high-concentration bolus. Test bolus at L1 level with ROI in descending aorta.
        </div>
      </div>
    </div>

    <h4 style="color:var(--primary);margin:20px 0 12px;font-size:0.95rem;">Contrast Timing Methods</h4>

    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">
      <div style="background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:6px;">
        <strong style="color:#1e40af;">Arterial (Test Bolus)</strong>
        <div style="font-size:0.85rem;color:#475569;margin-top:4px;line-height:1.5;">
          Most common timing method. Small test bolus (10–15 ml) injected first to measure contrast transit time. Dynamic evaluation with ROI in target vessel (ascending or descending aorta). Scan delay = test bolus peak time + protocol-specific offset (typically +3s to +8s). Provides patient-specific timing accuracy.
        </div>
      </div>

      <div style="background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:6px;">
        <strong style="color:#b45309;">Set Delay (Fixed Timing)</strong>
        <div style="font-size:0.85rem;color:#475569;margin-top:4px;line-height:1.5;">
          Fixed delay from contrast injection start — no test bolus. Used with Bastion Wheel protocols (70–80 seconds) and for delayed/late enhancement phases (e.g. CARTO LAA at 60s, EVOQUE venogram at 90s, INHEART late phase at 8 minutes). Delay determined by chart, clinical evidence, or protocol design rather than individual patient transit time.
        </div>
      </div>

      <div style="background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:6px;">
        <strong style="color:#059669;">Portal Venous</strong>
        <div style="font-size:0.85rem;color:#475569;margin-top:4px;line-height:1.5;">
          Typically 60–80 seconds post-injection for hepatic/abdominal parenchymal enhancement. Not routinely used in dedicated cardiac protocols, but may be relevant in combined cardiac + abdominal imaging (e.g. extended TAVI access route assessment including abdominal organs). Can be achieved with Erasmus split-bolus technique or standard delayed acquisition.
        </div>
      </div>

      <div style="background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:6px;">
        <strong style="color:#dc2626;">Manual ROI Triggering</strong>
        <div style="font-size:0.85rem;color:#475569;margin-top:4px;line-height:1.5;">
          Used when standard test bolus timing is unreliable — primarily ECMO patients. Place ROI in target vessel and manually trigger scan at visual peak enhancement. Essential for VA-ECMO (retrograde/antegrade mixing creates unpredictable transit times) and recommended for VV-ECMO.
        </div>
      </div>

      <div style="background:#f8fafc;border:1px solid #e2e8f0;padding:12px 16px;border-radius:6px;">
        <strong style="color:#7c3aed;">Bolus Tracking</strong>
        <div style="font-size:0.85rem;color:#475569;margin-top:4px;line-height:1.5;">
          Automated triggering at a pre-set HU threshold (e.g. 100 HU in descending aorta). Preferred in paediatrics where test bolus may waste limited IV access or contrast volume. Also useful for non-cardiac CT applications requiring precise arterial phase triggering.
        </div>
      </div>
    </div>

    <h4 style="color:var(--primary);margin:20px 0 12px;font-size:0.95rem;">Protocol Injection Map</h4>
    <div style="overflow-x:auto;">
      <table class="injection-table" style="font-size:0.82rem;">
        <thead>
          <tr><th>Protocol</th><th>Injection Type</th><th>Phase</th><th>Timing</th></tr>
        </thead>
        <tbody>${injTypeRows}</tbody>
      </table>
    </div>
  </div>`;
}

// ============================================================
// CHECKLISTS (protocol detail integration)
// ============================================================
function renderChecklistSection(protocolKey) {
  const cl = getChecklistForProtocol(protocolKey);
  const sd = JSON.parse(sessionStorage.getItem('ctca_checklists') || '{}');
  const pc = sd[protocolKey] || {};
  let html = '<div class="checklist-container"><h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg> Scan Checklists</h2>';
  const phases = [
    { key: 'preScan', title: 'Pre-Scan Checklist', open: true },
    { key: 'intraScan', title: 'Intra-Scan Prompts', open: false },
    { key: 'postScan', title: 'Post-Scan Checklist', open: false }
  ];
  phases.forEach(phase => {
    const items = cl[phase.key];
    const checks = pc[phase.key] || {};
    const done = items.filter(i => checks[i.id]).length;
    const pct = items.length ? Math.round((done / items.length) * 100) : 0;
    html += `<div class="checklist-phase ${phase.open ? 'open' : ''}" id="cl-${phase.key}">
      <div class="checklist-phase-header" onclick="toggleChecklistPhase('cl-${phase.key}')">
        <h3>${phase.title}</h3>
        <span class="checklist-progress">${done}/${items.length}
          <span class="checklist-progress-bar"><span class="checklist-progress-fill" style="width:${pct}%"></span></span>
          <svg class="cl-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        </span>
      </div>
      <div class="checklist-body">`;
    items.forEach(item => {
      const chk = checks[item.id] ? 'checked' : '';
      const cls = checks[item.id] ? ' checked' : '';
      html += `<div class="checklist-item${cls}" id="cli-${item.id}">
        <input type="checkbox" ${chk} onchange="toggleChecklistItem('${protocolKey}','${phase.key}','${item.id}',this.checked)">
        <span class="checklist-item-label">${item.label}</span>
      </div>`;
    });
    html += '</div></div>';
  });
  html += '</div>';
  return html;
}

function toggleChecklistPhase(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

function toggleChecklistItem(pk, phase, itemId, checked) {
  const sd = JSON.parse(sessionStorage.getItem('ctca_checklists') || '{}');
  if (!sd[pk]) sd[pk] = {};
  if (!sd[pk][phase]) sd[pk][phase] = {};
  sd[pk][phase][itemId] = checked;
  sessionStorage.setItem('ctca_checklists', JSON.stringify(sd));
  const item = document.getElementById('cli-' + itemId);
  if (item) { if (checked) item.classList.add('checked'); else item.classList.remove('checked'); }
  updateChecklistProgress(pk, phase);
}

function updateChecklistProgress(pk, phase) {
  const cl = getChecklistForProtocol(pk);
  const sd = JSON.parse(sessionStorage.getItem('ctca_checklists') || '{}');
  const checks = (sd[pk] || {})[phase] || {};
  const items = cl[phase];
  const done = items.filter(i => checks[i.id]).length;
  const pct = items.length ? Math.round((done / items.length) * 100) : 0;
  const phaseEl = document.getElementById('cl-' + phase);
  if (phaseEl) {
    const ps = phaseEl.querySelector('.checklist-progress');
    if (ps) ps.innerHTML = `${done}/${items.length} <span class="checklist-progress-bar"><span class="checklist-progress-fill" style="width:${pct}%"></span></span> <svg class="cl-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
  }
}

// ============================================================
// QUIZ MODE
// ============================================================
let currentQuiz = null;

function renderQuizHub() {
  const container = document.getElementById('quizHubContent');
  const progress = JSON.parse(localStorage.getItem('ctca_quiz_progress') || '{}');
  let html = '<div class="quiz-hub-header"><h2>🧠 Quiz Mode</h2><p>Test your protocol knowledge with MCQs and clinical scenarios</p></div>';
  // Progress dashboard
  html += '<div class="quiz-progress-dashboard"><h3>Your Progress</h3>';
  const cats = Object.keys(quizBank);
  cats.forEach(cat => {
    const d = quizBank[cat];
    const p = progress[cat] || { attempted: 0, correct: 0 };
    const pct = p.attempted > 0 ? Math.round((p.correct / p.attempted) * 100) : 0;
    html += `<div class="quiz-progress-row">
      <span class="quiz-progress-label">${d.icon} ${d.label}</span>
      <div class="quiz-progress-bar-track"><div class="quiz-progress-bar-fill" style="width:${pct}%;background:${pct >= 70 ? 'var(--success)' : pct >= 40 ? '#eab308' : 'var(--danger)'}"></div></div>
      <span class="quiz-progress-pct">${pct}%</span>
    </div>`;
  });
  html += '</div>';
  // Quick Quiz
  html += '<div class="quiz-section-label">Quick Quiz by Category</div><div class="quiz-hub-grid">';
  cats.forEach(cat => {
    const d = quizBank[cat];
    html += `<div class="quiz-category-card" onclick="startQuiz('${cat}')">
      <div class="quiz-cat-icon">${d.icon}</div>
      <h3>${d.label}</h3>
      <p>${d.questions.length} questions</p>
    </div>`;
  });
  html += '</div>';
  // Clinical Cases
  html += '<div class="quiz-section-label">Clinical Scenarios</div><div class="quiz-hub-grid">';
  clinicalCases.forEach(c => {
    html += `<div class="quiz-category-card" onclick="navigateTo('quiz/case/${c.id}')">
      <h3>${c.title}</h3>
      <p>${c.description}</p>
      <span class="risk-badge ${c.difficulty === 'Foundation' ? 'low' : c.difficulty === 'Intermediate' ? 'moderate' : 'high'}" style="margin-top:8px;">${c.difficulty}</span>
    </div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

function startQuiz(category) {
  const d = quizBank[category];
  const shuffled = [...d.questions].sort(() => Math.random() - 0.5);
  const count = Math.min(shuffled.length, 10);
  currentQuiz = { category, label: d.label, questions: shuffled.slice(0, count), idx: 0, score: 0, answers: [] };
  renderQuizQuestion();
}

function renderQuizQuestion() {
  const container = document.getElementById('quizHubContent');
  const q = currentQuiz.questions[currentQuiz.idx];
  const total = currentQuiz.questions.length;
  const cur = currentQuiz.idx + 1;
  const shuffOpts = [...q.options].sort(() => Math.random() - 0.5);
  currentQuiz._opts = shuffOpts;
  let html = `<div class="quiz-question-card">
    <div class="quiz-question-progress">Question ${cur} of ${total} — ${currentQuiz.label}</div>
    <div class="checklist-progress-bar" style="width:100%;margin-bottom:16px;"><div class="checklist-progress-fill" style="width:${(cur/total)*100}%;background:#7c3aed;"></div></div>
    <div class="quiz-question-text">${q.question}</div>`;
  shuffOpts.forEach((o, i) => {
    html += `<button class="quiz-option" id="qopt${i}" onclick="answerQuiz(${i})">${o.text}</button>`;
  });
  html += `<div class="quiz-feedback" id="quizFb"></div>
    <button class="quiz-next-btn" id="quizNextBtn" style="display:none;" onclick="nextQuizQuestion()">${cur >= total ? 'See Results' : 'Next Question'}</button>
  </div>`;
  container.innerHTML = html;
}

function answerQuiz(idx) {
  const q = currentQuiz.questions[currentQuiz.idx];
  const opts = currentQuiz._opts;
  const isCorrect = opts[idx].correct;
  if (isCorrect) currentQuiz.score++;
  currentQuiz.answers.push({ qid: q.id, correct: isCorrect });
  // Disable & highlight
  opts.forEach((o, i) => {
    const btn = document.getElementById('qopt' + i);
    btn.classList.add('disabled');
    if (o.correct) btn.classList.add('correct');
    if (i === idx && !isCorrect) btn.classList.add('incorrect');
    if (!o.correct && i !== idx) btn.classList.add('dimmed');
  });
  const fb = document.getElementById('quizFb');
  fb.className = `quiz-feedback visible ${isCorrect ? 'correct-fb' : 'incorrect-fb'}`;
  fb.innerHTML = `<strong>${isCorrect ? '✅ Correct!' : '❌ Incorrect'}</strong> ${q.explanation}`;
  document.getElementById('quizNextBtn').style.display = 'inline-block';
}

function nextQuizQuestion() {
  currentQuiz.idx++;
  if (currentQuiz.idx >= currentQuiz.questions.length) renderQuizResults();
  else renderQuizQuestion();
}

function renderQuizResults() {
  const container = document.getElementById('quizHubContent');
  const pct = Math.round((currentQuiz.score / currentQuiz.questions.length) * 100);
  // Save progress
  const progress = JSON.parse(localStorage.getItem('ctca_quiz_progress') || '{}');
  if (!progress[currentQuiz.category]) progress[currentQuiz.category] = { attempted: 0, correct: 0 };
  progress[currentQuiz.category].attempted += currentQuiz.questions.length;
  progress[currentQuiz.category].correct += currentQuiz.score;
  localStorage.setItem('ctca_quiz_progress', JSON.stringify(progress));
  const color = pct >= 70 ? 'var(--success)' : pct >= 40 ? '#eab308' : 'var(--danger)';
  const msg = pct >= 80 ? 'Excellent!' : pct >= 60 ? 'Good work!' : pct >= 40 ? 'Keep practising!' : 'Review the learning content and try again.';
  container.innerHTML = `<div class="quiz-question-card" style="text-align:center;">
    <h2 style="font-size:1.2rem;margin-bottom:4px;">Quiz Complete — ${currentQuiz.label}</h2>
    <div class="quiz-score-display" style="color:${color};">${pct}%</div>
    <p style="font-size:0.95rem;color:var(--text-light);margin-bottom:20px;">You scored ${currentQuiz.score} out of ${currentQuiz.questions.length}. ${msg}</p>
    <button class="calc-btn" onclick="startQuiz('${currentQuiz.category}')" style="margin-bottom:8px;">Try Again</button><br>
    <button class="quiz-next-btn outline" onclick="renderQuizHub()" style="display:inline-block;margin-top:4px;">Back to Quiz Hub</button>
  </div>`;
}

// --- Clinical Case Engine ---
function renderQuizCase(caseId) {
  const c = clinicalCases.find(x => x.id === caseId);
  if (!c) { navigateTo('quiz'); return; }
  if (!window._caseState || window._caseState.caseId !== caseId) {
    window._caseState = { caseId, stepId: c.steps[0].id, history: [] };
  }
  renderCaseStep(c);
}

function renderCaseStep(c) {
  const container = document.getElementById('quizCaseContent');
  const step = c.steps.find(s => s.id === window._caseState.stepId);
  if (!step) return;
  let html = `<div class="case-patient-info"><strong>${c.title}</strong> (${c.difficulty})<br>${c.description}</div>`;
  // History trail
  window._caseState.history.forEach(h => {
    html += `<div class="case-history-card ${h.correct ? '' : 'wrong'}">
      <span style="color:var(--text-light);font-size:0.8rem;">${h.prompt.substring(0, 80)}...</span><br>
      <strong style="color:${h.correct ? '#166534' : '#991b1b'};">${h.correct ? '✅' : '❌'} ${h.text}</strong>
    </div>`;
  });
  // Current step
  if (step.summary) {
    html += `<div class="case-step-card" style="text-align:center;border-left-color:var(--success);">
      <h3 style="margin-bottom:8px;color:var(--success);">🎉 Case Complete!</h3>
      <p style="font-size:0.95rem;margin-bottom:16px;line-height:1.6;">${step.summary}</p>
      ${step.protocolRef ? `<button class="calc-btn" onclick="navigateTo('learn/${step.protocolRef}')" style="margin-bottom:8px;">📖 Review Protocol Learning</button><br>` : ''}
      <button class="quiz-next-btn outline" onclick="window._caseState=null;navigateTo('quiz',{slideBack:true})" style="display:inline-block;margin-top:4px;">Back to Quiz Hub</button>
    </div>`;
  } else {
    html += `<div class="case-step-card"><div class="quiz-question-text">${step.prompt}</div>`;
    step.options.forEach((o, i) => {
      html += `<button class="quiz-option" id="copt${i}" onclick="answerCaseStep('${c.id}','${step.id}',${i})">${o.text}</button>`;
    });
    html += '<div class="quiz-feedback" id="caseFb"></div></div>';
  }
  container.innerHTML = html;
}

function answerCaseStep(caseId, stepId, optIdx) {
  const c = clinicalCases.find(x => x.id === caseId);
  const step = c.steps.find(s => s.id === stepId);
  const opt = step.options[optIdx];
  // Disable all
  step.options.forEach((o, i) => {
    const btn = document.getElementById('copt' + i);
    btn.classList.add('disabled');
    if (o.correct) btn.classList.add('correct');
    if (i === optIdx && !opt.correct) btn.classList.add('incorrect');
    if (!o.correct && i !== optIdx) btn.classList.add('dimmed');
  });
  const fb = document.getElementById('caseFb');
  fb.className = `quiz-feedback visible ${opt.correct ? 'correct-fb' : 'incorrect-fb'}`;
  let fbHtml = opt.feedback;
  if (!opt.correct && !opt.nextStep) {
    fbHtml += '<br><button class="quiz-next-btn" onclick="retryCaseStep()" style="display:inline-block;margin-top:10px;font-size:0.85rem;">Try Again</button>';
  }
  fb.innerHTML = fbHtml;
  window._caseState.history.push({ prompt: step.prompt, text: opt.text, correct: opt.correct });
  if (opt.correct && opt.nextStep) {
    setTimeout(() => {
      window._caseState.stepId = opt.nextStep;
      renderCaseStep(c);
    }, 2000);
  }
}

function retryCaseStep() {
  window._caseState.history.pop();
  const c = clinicalCases.find(x => x.id === window._caseState.caseId);
  renderCaseStep(c);
}

// ============================================================
// PWA SERVICE WORKER REGISTRATION
// ============================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    console.log('SW registered:', reg.scope);
  }).catch(err => {
    console.log('SW registration failed:', err);
  });
}
</script>
</body>
</html>
